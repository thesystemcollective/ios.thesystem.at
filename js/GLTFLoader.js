import{M as e}from"./MathUtils.js";import{T as t,t as s,am as n,ah as i,R as o,D as r,s as a,bz as c,N as l,aj as p,al as h,ak as u,b as m,ai as d,bB as f,w as g,F as y,bC as M,bD as b}from"./constants.js";import{M as v}from"./Material.js";import{C as T}from"./Color.js";import{MeshBasicMaterial as x}from"./MeshBasicMaterial.js";import"./Quaternion.js";import{O as w,M as S,V as R}from"./Object3D.js";import{V as A,c as _,F as L,S as E,B as I,d as O,e as P}from"./BufferGeometry.js";import{R as j}from"./Triangle.js";import"./Face3.js";import{Mesh as C}from"./Mesh.js";import{A as D,P as N,I as U,V as k,Q as F,N as H}from"./AnimationClip.js";import{O as B,L as G,C as K,T as V,I as W,a as z}from"./TextureLoader.js";import"./Camera.js";import{PerspectiveCamera as X}from"./PerspectiveCamera.js";import{F as q,G as $}from"./Frustum.js";import{L as Y}from"./Light.js";import{T as Z}from"./Texture.js";function J(e){v.call(this),this.type="LineBasicMaterial",this.color=new T(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(e)}function Q(e){v.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new T(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new T(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=t,this.normalScale=new A(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.vertexTangents=!1,this.setValues(e)}function ee(e){Q.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new A(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,this.sheen=null,this.transmission=0,this.transmissionMap=null,this.setValues(e)}function te(e){v.call(this),this.type="PointsMaterial",this.color=new T(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(e)}function se(){w.call(this),this.type="Bone"}function ne(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new A(512,512),this.map=null,this.mapPass=null,this.matrix=new S,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new q,this._frameExtents=new A(1,1),this._viewportCount=1,this._viewports=[new _(0,0,1,1)]}function ie(){ne.call(this,new B(-5,5,5,-5,.5,500))}function oe(e,t){Y.call(this,e,t),this.type="DirectionalLight",this.position.copy(w.DefaultUp),this.updateMatrix(),this.target=new w,this.shadow=new ie}function re(){ne.call(this,new X(90,1,.5,500)),this._frameExtents=new A(4,2),this._viewportCount=6,this._viewports=[new _(2,1,1,1),new _(0,1,1,1),new _(3,1,1,1),new _(1,1,1,1),new _(3,0,1,1),new _(1,0,1,1)],this._cubeDirections=[new R(1,0,0),new R(-1,0,0),new R(0,0,1),new R(0,0,-1),new R(0,1,0),new R(0,-1,0)],this._cubeUps=[new R(0,1,0),new R(0,1,0),new R(0,1,0),new R(0,1,0),new R(0,0,1),new R(0,0,-1)]}function ae(e,t,s,n){Y.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==s?s:0,this.decay=void 0!==n?n:1,this.shadow=new re}function ce(){ne.call(this,new X(50,1,.5,500))}function le(e,t,s,n,i,o){Y.call(this,e,t),this.type="SpotLight",this.position.copy(w.DefaultUp),this.updateMatrix(),this.target=new w,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==s?s:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==i?i:0,this.decay=void 0!==o?o:1,this.shadow=new ce}J.prototype=Object.create(v.prototype),J.prototype.constructor=J,J.prototype.isLineBasicMaterial=!0,J.prototype.copy=function(e){return v.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.morphTargets=e.morphTargets,this},Q.prototype=Object.create(v.prototype),Q.prototype.constructor=Q,Q.prototype.isMeshStandardMaterial=!0,Q.prototype.copy=function(e){return v.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.vertexTangents=e.vertexTangents,this},ee.prototype=Object.create(Q.prototype),ee.prototype.constructor=ee,ee.prototype.isMeshPhysicalMaterial=!0,ee.prototype.copy=function(e){return Q.prototype.copy.call(this,e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.reflectivity=e.reflectivity,e.sheen?this.sheen=(this.sheen||new T).copy(e.sheen):this.sheen=null,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this},te.prototype=Object.create(v.prototype),te.prototype.constructor=te,te.prototype.isPointsMaterial=!0,te.prototype.copy=function(e){return v.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.morphTargets=e.morphTargets,this},se.prototype=Object.assign(Object.create(w.prototype),{constructor:se,isBone:!0}),Object.assign(ne.prototype,{_projScreenMatrix:new S,_lightPositionWorld:new R,_lookTarget:new R,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(e){const t=this.camera,s=this.matrix,n=this._projScreenMatrix,i=this._lookTarget,o=this._lightPositionWorld;o.setFromMatrixPosition(e.matrixWorld),t.position.copy(o),i.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(i),t.updateMatrixWorld(),n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(n),s.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),s.multiply(t.projectionMatrix),s.multiply(t.matrixWorldInverse)},getViewport:function(e){return this._viewports[e]},getFrameExtents:function(){return this._frameExtents},copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),ie.prototype=Object.assign(Object.create(ne.prototype),{constructor:ie,isDirectionalLightShadow:!0,updateMatrices:function(e){ne.prototype.updateMatrices.call(this,e)}}),oe.prototype=Object.assign(Object.create(Y.prototype),{constructor:oe,isDirectionalLight:!0,copy:function(e){return Y.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),re.prototype=Object.assign(Object.create(ne.prototype),{constructor:re,isPointLightShadow:!0,updateMatrices:function(e,t){void 0===t&&(t=0);const s=this.camera,n=this.matrix,i=this._lightPositionWorld,o=this._lookTarget,r=this._projScreenMatrix;i.setFromMatrixPosition(e.matrixWorld),s.position.copy(i),o.copy(s.position),o.add(this._cubeDirections[t]),s.up.copy(this._cubeUps[t]),s.lookAt(o),s.updateMatrixWorld(),n.makeTranslation(-i.x,-i.y,-i.z),r.multiplyMatrices(s.projectionMatrix,s.matrixWorldInverse),this._frustum.setFromProjectionMatrix(r)}}),ae.prototype=Object.assign(Object.create(Y.prototype),{constructor:ae,isPointLight:!0,copy:function(e){return Y.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),ce.prototype=Object.assign(Object.create(ne.prototype),{constructor:ce,isSpotLightShadow:!0,updateMatrices:function(t){const s=this.camera,n=2*e.RAD2DEG*t.angle,i=this.mapSize.width/this.mapSize.height,o=t.distance||s.far;n===s.fov&&i===s.aspect&&o===s.far||(s.fov=n,s.aspect=i,s.far=o,s.updateProjectionMatrix()),ne.prototype.updateMatrices.call(this,t)}}),le.prototype=Object.assign(Object.create(Y.prototype),{constructor:le,isSpotLight:!0,copy:function(e){return Y.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}});const pe={};function he(e){G.call(this,e)}function ue(e){G.call(this,e),this.options={premultiplyAlpha:"none"}}he.prototype=Object.assign(Object.create(G.prototype),{constructor:he,load:function(e,t,s,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,o=K.get(e);if(void 0!==o)return i.manager.itemStart(e),setTimeout((function(){t&&t(o),i.manager.itemEnd(e)}),0),o;if(void 0!==pe[e])return void pe[e].push({onLoad:t,onProgress:s,onError:n});const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);let a;if(r){const s=r[1],o=!!r[2];let a=r[3];a=decodeURIComponent(a),o&&(a=atob(a));try{let n;const o=(this.responseType||"").toLowerCase();switch(o){case"arraybuffer":case"blob":const e=new Uint8Array(a.length);for(let t=0;t<a.length;t++)e[t]=a.charCodeAt(t);n="blob"===o?new Blob([e.buffer],{type:s}):e.buffer;break;case"document":const t=new DOMParser;n=t.parseFromString(a,s);break;case"json":n=JSON.parse(a);break;default:n=a}setTimeout((function(){t&&t(n),i.manager.itemEnd(e)}),0)}catch(t){setTimeout((function(){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)}),0)}}else{pe[e]=[],pe[e].push({onLoad:t,onProgress:s,onError:n}),a=new XMLHttpRequest,a.open("GET",e,!0),a.addEventListener("load",(function(t){const s=this.response,n=pe[e];if(delete pe[e],200===this.status||0===this.status){this.status,K.add(e,s);for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onLoad&&t.onLoad(s)}i.manager.itemEnd(e)}else{for(let e=0,s=n.length;e<s;e++){const s=n[e];s.onError&&s.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}}),!1),a.addEventListener("progress",(function(t){const s=pe[e];for(let e=0,n=s.length;e<n;e++){const n=s[e];n.onProgress&&n.onProgress(t)}}),!1),a.addEventListener("error",(function(t){const s=pe[e];delete pe[e];for(let e=0,n=s.length;e<n;e++){const n=s[e];n.onError&&n.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}),!1),a.addEventListener("abort",(function(t){const s=pe[e];delete pe[e];for(let e=0,n=s.length;e<n;e++){const n=s[e];n.onError&&n.onError(t)}i.manager.itemError(e),i.manager.itemEnd(e)}),!1),void 0!==this.responseType&&(a.responseType=this.responseType),void 0!==this.withCredentials&&(a.withCredentials=this.withCredentials),a.overrideMimeType&&a.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const e in this.requestHeader)a.setRequestHeader(e,this.requestHeader[e]);a.send(null)}return i.manager.itemStart(e),a},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this}}),ue.prototype=Object.assign(Object.create(G.prototype),{constructor:ue,isImageBitmapLoader:!0,setOptions:function(e){return this.options=e,this},load:function(e,t,s,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,o=K.get(e);if(void 0!==o)return i.manager.itemStart(e),setTimeout((function(){t&&t(o),i.manager.itemEnd(e)}),0),o;fetch(e).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,i.options)})).then((function(s){K.add(e,s),t&&t(s),i.manager.itemEnd(e)})).catch((function(t){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)})),i.manager.itemStart(e)}});const me=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let s=0,n=e.length;s<n;s++)t+=String.fromCharCode(e[s]);try{return decodeURIComponent(escape(t))}catch(e){return t}},de=function(e){const t=e.lastIndexOf("/");return-1===t?"./":e.substr(0,t+1)},fe=new R,ge=new R,ye=new S,Me=new j,be=new E;function ve(e,t,s){w.call(this),this.type="Line",this.geometry=void 0!==e?e:new I,this.material=void 0!==t?t:new J,this.updateMorphTargets()}function Te(e,t){ve.call(this,e,t),this.type="LineLoop"}ve.prototype=Object.assign(Object.create(w.prototype),{constructor:ve,isLine:!0,copy:function(e){return w.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry){if(null===e.index){const t=e.attributes.position,s=[0];for(let e=1,n=t.count;e<n;e++)fe.fromBufferAttribute(t,e-1),ge.fromBufferAttribute(t,e),s[e]=s[e-1],s[e]+=fe.distanceTo(ge);e.setAttribute("lineDistance",new L(s,1))}}else if(e.isGeometry){const t=e.vertices,s=e.lineDistances;s[0]=0;for(let e=1,n=t.length;e<n;e++)s[e]=s[e-1],s[e]+=t[e-1].distanceTo(t[e])}return this},raycast:function(e,t){const s=this.geometry,n=this.matrixWorld,i=e.params.Line.threshold;if(null===s.boundingSphere&&s.computeBoundingSphere(),be.copy(s.boundingSphere),be.applyMatrix4(n),be.radius+=i,!1===e.ray.intersectsSphere(be))return;ye.getInverse(n),Me.copy(e.ray).applyMatrix4(ye);const o=i/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o,a=new R,c=new R,l=new R,p=new R,h=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){const n=s.index,i=s.attributes.position.array;if(null!==n){const s=n.array;for(let n=0,o=s.length-1;n<o;n+=h){const o=s[n],h=s[n+1];a.fromArray(i,3*o),c.fromArray(i,3*h);if(Me.distanceSqToSegment(a,c,p,l)>r)continue;p.applyMatrix4(this.matrixWorld);const u=e.ray.origin.distanceTo(p);u<e.near||u>e.far||t.push({distance:u,point:l.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else for(let s=0,n=i.length/3-1;s<n;s+=h){a.fromArray(i,3*s),c.fromArray(i,3*s+3);if(Me.distanceSqToSegment(a,c,p,l)>r)continue;p.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(p);n<e.near||n>e.far||t.push({distance:n,point:l.clone().applyMatrix4(this.matrixWorld),index:s,face:null,faceIndex:null,object:this})}}else if(s.isGeometry){const n=s.vertices,i=n.length;for(let s=0;s<i-1;s+=h){if(Me.distanceSqToSegment(n[s],n[s+1],p,l)>r)continue;p.applyMatrix4(this.matrixWorld);const i=e.ray.origin.distanceTo(p);i<e.near||i>e.far||t.push({distance:i,point:l.clone().applyMatrix4(this.matrixWorld),index:s,face:null,faceIndex:null,object:this})}}},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,s=Object.keys(t);if(s.length>0){const e=t[s[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,s=e.length;t<s;t++){const s=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length}}}),Te.prototype=Object.assign(Object.create(ve.prototype),{constructor:Te,isLineLoop:!0});const xe=new R,we=new R;function Se(e,t){ve.call(this,e,t),this.type="LineSegments"}Se.prototype=Object.assign(Object.create(ve.prototype),{constructor:Se,isLineSegments:!0,computeLineDistances:function(){const e=this.geometry;if(e.isBufferGeometry){if(null===e.index){const t=e.attributes.position,s=[];for(let e=0,n=t.count;e<n;e+=2)xe.fromBufferAttribute(t,e),we.fromBufferAttribute(t,e+1),s[e]=0===e?0:s[e-1],s[e+1]=s[e]+xe.distanceTo(we);e.setAttribute("lineDistance",new L(s,1))}}else if(e.isGeometry){const t=e.vertices,s=e.lineDistances;for(let e=0,n=t.length;e<n;e+=2)xe.copy(t[e]),we.copy(t[e+1]),s[e]=0===e?0:s[e-1],s[e+1]=s[e]+xe.distanceTo(we)}return this}});const Re=new S,Ae=new j,_e=new E,Le=new R;function Ee(e,t){w.call(this),this.type="Points",this.geometry=void 0!==e?e:new I,this.material=void 0!==t?t:new te,this.updateMorphTargets()}function Ie(e,t,s,n,i,o,r){const a=Ae.distanceSqToPoint(e);if(a<s){const s=new R;Ae.closestPointToPoint(e,s),s.applyMatrix4(n);const c=i.ray.origin.distanceTo(s);if(c<i.near||c>i.far)return;o.push({distance:c,distanceToRay:Math.sqrt(a),point:s,index:t,face:null,object:r})}}Ee.prototype=Object.assign(Object.create(w.prototype),{constructor:Ee,isPoints:!0,copy:function(e){return w.prototype.copy.call(this,e),this.material=e.material,this.geometry=e.geometry,this},raycast:function(e,t){const s=this.geometry,n=this.matrixWorld,i=e.params.Points.threshold;if(null===s.boundingSphere&&s.computeBoundingSphere(),_e.copy(s.boundingSphere),_e.applyMatrix4(n),_e.radius+=i,!1===e.ray.intersectsSphere(_e))return;Re.getInverse(n),Ae.copy(e.ray).applyMatrix4(Re);const o=i/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o;if(s.isBufferGeometry){const i=s.index,o=s.attributes.position.array;if(null!==i){const s=i.array;for(let i=0,a=s.length;i<a;i++){const a=s[i];Le.fromArray(o,3*a),Ie(Le,a,r,n,e,t,this)}}else for(let s=0,i=o.length/3;s<i;s++)Le.fromArray(o,3*s),Ie(Le,s,r,n,e,t,this)}else{const i=s.vertices;for(let s=0,o=i.length;s<o;s++)Ie(i[s],s,r,n,e,t,this)}},updateMorphTargets:function(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,s=Object.keys(t);if(s.length>0){const e=t[s[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,s=e.length;t<s;t++){const s=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length}}});const Oe=new S,Pe=new S;function je(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),this.frame=-1,void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new S)}}function Ce(e,t){e&&e.isGeometry,C.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new S,this.bindMatrixInverse=new S}function De(e,t,s,n,i,o,r,a,c){Z.call(this,e,t,s,n,i,o,r,a,c),this.needsUpdate=!0}Object.assign(je.prototype,{calculateInverses:function(){this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++){const t=new S;this.bones[e]&&t.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(t)}},pose:function(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.getInverse(this.boneInverses[e])}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.getInverse(t.parent.matrixWorld),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}},update:function(){const e=this.bones,t=this.boneInverses,s=this.boneMatrices,n=this.boneTexture;for(let n=0,i=e.length;n<i;n++){const i=e[n]?e[n].matrixWorld:Pe;Oe.multiplyMatrices(i,t[n]),Oe.toArray(s,16*n)}void 0!==n&&(n.needsUpdate=!0)},clone:function(){return new je(this.bones,this.boneInverses)},getBoneByName:function(e){for(let t=0,s=this.bones.length;t<s;t++){const s=this.bones[t];if(s.name===e)return s}},dispose:function(){this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=void 0)}}),Ce.prototype=Object.assign(Object.create(C.prototype),{constructor:Ce,isSkinnedMesh:!0,copy:function(e){return C.prototype.copy.call(this,e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const e=new _,t=this.geometry.attributes.skinWeight;for(let s=0,n=t.count;s<n;s++){e.x=t.getX(s),e.y=t.getY(s),e.z=t.getZ(s),e.w=t.getW(s);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(s,e.x,e.y,e.z,e.w)}},updateMatrixWorld:function(e){C.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode&&this.bindMatrixInverse.getInverse(this.bindMatrix)},boneTransform:function(){const e=new R,t=new _,s=new _,n=new R,i=new S;return function(o,r){const a=this.skeleton,c=this.geometry;t.fromBufferAttribute(c.attributes.skinIndex,o),s.fromBufferAttribute(c.attributes.skinWeight,o),e.fromBufferAttribute(c.attributes.position,o).applyMatrix4(this.bindMatrix),r.set(0,0,0);for(let o=0;o<4;o++){const c=s.getComponent(o);if(0!==c){const s=t.getComponent(o);i.multiplyMatrices(a.bones[s].matrixWorld,a.boneInverses[s]),r.addScaledVector(n.copy(e).applyMatrix4(i),c)}}return r.applyMatrix4(this.bindMatrixInverse)}}()}),De.prototype=Object.create(Z.prototype),De.prototype.constructor=De,De.prototype.isCanvasTexture=!0;const Ne=function(){function _(e){G.call(this,e),this.dracoLoader=null,this.ddsLoader=null,this.pluginCallbacks=[],this.register((function(e){return new Z(e)}))}function L(){let e={};return{get:t=>e[t],add(t,s){e[t]=s},remove(t){delete e[t]},removeAll(){e={}}}}_.prototype=Object.assign(Object.create(G.prototype),{constructor:_,load:function(e,t,s,n){const i=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:de(e),i.manager.itemStart(e);const r=t=>{n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)},a=new he(i.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),"use-credentials"===i.crossOrigin&&a.setWithCredentials(!0),a.load(e,(function(s){try{i.parse(s,o,(function(s){t(s),i.manager.itemEnd(e)}),r)}catch(e){r(e)}}),s,r)},setDRACOLoader(e){return this.dracoLoader=e,this},setDDSLoader(e){return this.ddsLoader=e,this},register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse(e,t,s,n){let i;const o={},r={};if("string"==typeof e)i=e;else{if(me(new Uint8Array(e,0,4))===ne){try{o[j.KHR_BINARY_GLTF]=new ce(e)}catch(e){return void(n&&n(e))}i=o[j.KHR_BINARY_GLTF].content}else i=me(new Uint8Array(e))}const a=JSON.parse(i);if(void 0===a.asset||a.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new Ye(a,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);r[t.name]=t,o[t.name]=!0}if(a.extensionsUsed)for(let e=0;e<a.extensionsUsed.length;++e){const t=a.extensionsUsed[e],s=a.extensionsRequired||[];switch(t){case j.KHR_LIGHTS_PUNCTUAL:o[t]=new q(a);break;case j.KHR_MATERIALS_UNLIT:o[t]=new Y;break;case j.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[t]=new ye;break;case j.KHR_DRACO_MESH_COMPRESSION:o[t]=new pe(a,this.dracoLoader);break;case j.MSFT_TEXTURE_DDS:o[t]=new K(this.ddsLoader);break;case j.KHR_TEXTURE_TRANSFORM:o[t]=new fe;break;case j.KHR_MESH_QUANTIZATION:o[t]=new Me;break;default:s.indexOf(t)>=0&&r[t]}}c.setExtensions(o),c.setPlugins(r),c.parse(s,n)}});const j={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function K(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=j.MSFT_TEXTURE_DDS,this.ddsLoader=e}function q(e){this.name=j.KHR_LIGHTS_PUNCTUAL;const t=e.extensions&&e.extensions[j.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function Y(){this.name=j.KHR_MATERIALS_UNLIT}function Z(e){this.parser=e,this.name=j.KHR_MATERIALS_CLEARCOAT}q.prototype.loadLight=function(e){const t=this.lightDefs[e];let s;const n=new T(16777215);void 0!==t.color&&n.fromArray(t.color);const i=void 0!==t.range?t.range:0;switch(t.type){case"directional":s=new oe(n),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new ae(n),s.distance=i;break;case"spot":s=new le(n),s.distance=i,t.spot=t.spot||{},t.spot.innerConeAngle=void 0!==t.spot.innerConeAngle?t.spot.innerConeAngle:0,t.spot.outerConeAngle=void 0!==t.spot.outerConeAngle?t.spot.outerConeAngle:Math.PI/4,s.angle=t.spot.outerConeAngle,s.penumbra=1-t.spot.innerConeAngle/t.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+t.type+'".')}return s.position.set(0,0,0),s.decay=2,void 0!==t.intensity&&(s.intensity=t.intensity),s.name=t.name||"light_"+e,Promise.resolve(s)},Y.prototype.getMaterialType=function(){return x},Y.prototype.extendParams=function(e,t,s){const n=[];e.color=new T(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)},Z.prototype.getMaterialType=function(){return ee},Z.prototype.extendMaterialParams=function(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new A(e,e)}return Promise.all(i)};const ne="glTF",ie=1313821514,re=5130562;function ce(e){this.name=j.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:me(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ne)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=new DataView(e,12);let n=0;for(;n<s.byteLength;){const t=s.getUint32(n,!0);n+=4;const i=s.getUint32(n,!0);if(n+=4,i===ie){const s=new Uint8Array(e,12+n,t);this.content=me(s)}else if(i===re){const s=12+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function pe(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=j.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function fe(){this.name=j.KHR_TEXTURE_TRANSFORM}function ge(e){Q.call(this),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),r={specular:{value:(new T).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=r,this.onBeforeCompile=function(e){for(let t in r)e.uniforms[t]=r[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",t),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",s),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",i),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return r.specular.value},set:function(e){r.specular.value=e}},specularMap:{get:function(){return r.specularMap.value},set:function(e){r.specularMap.value=e}},glossiness:{get:function(){return r.glossiness.value},set:function(e){r.glossiness.value=e}},glossinessMap:{get:function(){return r.glossinessMap.value},set:function(e){r.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function ye(){return{name:j.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return ge},extendParams:function(e,t,s){const n=t.extensions[this.name];e.color=new T(1,1,1),e.opacity=1;const i=[];if(Array.isArray(n.diffuseFactor)){const t=n.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==n.diffuseTexture&&i.push(s.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new T(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new T(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;i.push(s.assignTexture(e,"glossinessMap",t)),i.push(s.assignTexture(e,"specularMap",t))}return Promise.all(i)},createMaterial:function(e){const s=new ge(e);return s.fog=!0,s.color=e.color,s.map=void 0===e.map?null:e.map,s.lightMap=null,s.lightMapIntensity=1,s.aoMap=void 0===e.aoMap?null:e.aoMap,s.aoMapIntensity=1,s.emissive=e.emissive,s.emissiveIntensity=1,s.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,s.bumpMap=void 0===e.bumpMap?null:e.bumpMap,s.bumpScale=1,s.normalMap=void 0===e.normalMap?null:e.normalMap,s.normalMapType=t,e.normalScale&&(s.normalScale=e.normalScale),s.displacementMap=null,s.displacementScale=1,s.displacementBias=0,s.specularMap=void 0===e.specularMap?null:e.specularMap,s.specular=e.specular,s.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,s.glossiness=e.glossiness,s.alphaMap=null,s.envMap=void 0===e.envMap?null:e.envMap,s.envMapIntensity=1,s.refractionRatio=.98,s}}}function Me(){this.name=j.KHR_MESH_QUANTIZATION}function be(e,t,s,n){U.call(this,e,t,s,n)}pe.prototype.decodePrimitive=function(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},c={};for(let e in o){const t=ke[e]||e.toLowerCase();r[t]=o[e]}for(attributeName in e.attributes){const t=ke[attributeName]||attributeName.toLowerCase();if(void 0!==o[attributeName]){const n=s.accessors[e.attributes[attributeName]],i=Oe[n.componentType];c[t]=i,a[t]=!0===n.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(let t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)}),r,c)}))}))},fe.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),t.texCoord,e.needsUpdate=!0,e},ge.prototype=Object.create(Q.prototype),ge.prototype.constructor=ge,ge.prototype.copy=function(e){return Q.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},be.prototype=Object.create(U.prototype),be.prototype.constructor=be,be.prototype.copySampleValue_=function(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[i+e];return t},be.prototype.beforeStart_=be.prototype.copySampleValue_,be.prototype.afterEnd_=be.prototype.copySampleValue_,be.prototype.interpolate_=function(e,t,s,n){const i=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,c=3*r,l=n-t,p=(s-t)/l,h=p*p,u=h*p,m=e*c,d=m-c,f=-2*u+3*h,g=u-h,y=1-f,M=g-h+p;for(let e=0;e!==r;e++){const t=o[d+e+r],s=o[d+e+a]*l,n=o[m+e+r],c=o[m+e]*l;i[e]=y*t+M*s+f*n+g*c}return i};const xe=0,we=1,Re=2,Ae=3,_e=4,Le=5,Ie=6,Oe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Pe={9728:l,9729:s,9984:p,9985:h,9986:u,9987:n},Ne={33071:m,33648:d,10497:i},Ue={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ke={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Fe={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},He={CUBICSPLINE:void 0,LINEAR:c,STEP:f},Be="OPAQUE",Ge="MASK",Ke="BLEND",Ve={"image/png":g,"image/jpeg":o};function We(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function ze(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function Xe(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function qe(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function $e(e){const t=e.extensions&&e.extensions[j.KHR_DRACO_MESH_COMPRESSION];if(t){const{bufferView:e,indices:s,attributes:n}=t;return`draco:${e}:${s}:${n}`}{const{indices:t,attributes:s,mode:n}=e;return`${t}:${function(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}(s)}:${n}`}}function Ye(e,t){this.json=e||{},this.extensions={},this.plugins={},this.options=t||{},this.cache=new L,this.associations=new Map,this.primitiveCache={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new ue(this.options.manager):this.textureLoader=new V(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new he(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function Ze(e,t,s){const n=t.attributes,i=[],o=(t,n)=>s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}));for(let t in n){const s=ke[t]||t.toLowerCase();s in e.attributes||i.push(o(n[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(n)}return Xe(e,t),function(e,t,s){const n=t.attributes,i=new P;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],{max:t,min:o}=e;if(void 0===o||void 0===t)return;i.set(new R(o[0],o[1],o[2]),new R(t[0],t[1],t[2]))}const o=t.targets;if(void 0!==o){const e=new R,t=new R;for(let n=0,i=o.length;n<i;n++){const i=o[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],{max:o,min:r}=n;void 0!==r&&void 0!==o&&(t.setX(Math.max(Math.abs(r[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(o[2]))),e.max(t))}}i.expandByVector(e)}e.boundingBox=i;const r=new E;i.getCenter(r.center),r.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=r}(e,t,s),Promise.all(i).then(()=>void 0!==t.targets?function(e,t,s){let n=!1,i=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(i=!0),n&&i)break}if(!n&&!i)return Promise.resolve(e);const o=[],r=[];for(let a=0,c=t.length;a<c;a++){const c=t[a];if(n){const t=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;o.push(t)}if(i){const t=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal;r.push(t)}}return Promise.all([Promise.all(o),Promise.all(r)]).then((function(t){const s=t[0],o=t[1];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e)}function Je(e,t){const s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,i=[];if(t===M)for(let e=1;e<=n;e++)i.push(s.getX(0)),i.push(s.getX(e)),i.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(i.push(s.getX(e)),i.push(s.getX(e+1)),i.push(s.getX(e+2))):(i.push(s.getX(e+2)),i.push(s.getX(e+1)),i.push(s.getX(e)));const o=e.clone();return o.setIndex(i),o}return Ye.prototype.setExtensions=function(e){this.extensions=e},Ye.prototype.setPlugins=function(e){this.plugins=e},Ye.prototype.parse=function(e,t){const s=this,{extensions:n,json:i}=this;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){const o={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};ze(n,o,i),Xe(o,i),e(o)})).catch(t)},Ye.prototype.markDefs=function(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],n={},i={};for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,o=e.length;t<o;t++){const o=e[t];void 0!==o.mesh&&(void 0===n[o.mesh]&&(n[o.mesh]=i[o.mesh]=0),n[o.mesh]++,void 0!==o.skin&&(s[o.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=i},Ye.prototype._invokeOne=function(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}},Ye.prototype._invokeAll=function(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++)s.push(e(t[n]));return Promise.all(s)},Ye.prototype.getDependency=function(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this.loadTexture(t);break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;case"light":n=this.extensions[j.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n},Ye.prototype.getDependencies=function(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((t,n)=>s.getDependency(e,n))),this.cache.add(e,t)}return t},Ye.prototype.loadBuffer=function(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[j.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,i){s.load(We(t.uri,n.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},Ye.prototype.loadBufferView=function(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const{byteLength:s=0,byteOffset:n=0}=t;return e.slice(n,n+s)}))},Ye.prototype.loadAccessor=function(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){const i=e[0],o=Ue[n.type],r=Oe[n.componentType],a=r.BYTES_PER_ELEMENT,c=a*o,l=n.byteOffset||0,p=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,h=!0===n.normalized;let u,m;if(p&&p!==c){const e=Math.floor(l/p),{bufferView:s,componentType:i,count:c}=n,d=`InterleavedBuffer:${s}:${i}:${e}:${c}`,f=t.cache.get(d);f||(u=new r(s,e*p,n.count*p/a),f=new W(u,p/a),t.cache.add(d,f)),m=new z(f,o,l%p/a,h)}else u=null===i?new r(n.count*o):new r(i,l,n.count*o),m=new O(u,o,h);if(void 0!==n.sparse){const t=Ue.SCALAR,s=Oe[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,c=n.sparse.values.byteOffset||0,l=new s(e[1],a,n.sparse.count*t),p=new r(e[2],c,n.sparse.count*o);null!==i&&(m=new O(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=l.length;e<t;e++){const t=l[e];if(m.setX(t,p[e*o]),o>=2&&m.setY(t,p[e*o+1]),o>=3&&m.setZ(t,p[e*o+2]),o>=4&&m.setW(t,p[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))},Ye.prototype.loadTexture=function(e){const t=this,{json:o,options:r,textureLoader:a}=this,c=self.URL||self.webkitURL,l=o.textures[e],p=l.extensions||{};let h;h=p[j.MSFT_TEXTURE_DDS]?o.images[p[j.MSFT_TEXTURE_DDS].source]:o.images[l.source];let u=h.uri,m=!1;return void 0!==h.bufferView&&(u=t.getDependency("bufferView",h.bufferView).then((function(e){m=!0;const t=new Blob([e],{type:h.mimeType});return u=c.createObjectURL(t),u}))),Promise.resolve(u).then((function(e){let s=r.manager.getHandler(e);return s||(s=p[j.MSFT_TEXTURE_DDS]?t.extensions[j.MSFT_TEXTURE_DDS].ddsLoader:a),new Promise((function(t,n){let i=t;!0===s.isImageBitmapLoader&&(i=e=>t(new De(e))),s.load(We(e,r.path),i,void 0,n)}))})).then((function(r){!0===m&&c.revokeObjectURL(u),r.flipY=!1,l.name&&(r.name=l.name),h.mimeType in Ve&&(r.format=Ve[h.mimeType]);const a=(o.samplers||{})[l.sampler]||{};return r.magFilter=Pe[a.magFilter]||s,r.minFilter=Pe[a.minFilter]||n,r.wrapS=Ne[a.wrapS]||i,r.wrapT=Ne[a.wrapT]||i,t.associations.set(r,{type:"textures",index:e}),r}))},Ye.prototype.assignTexture=function(e,t,s){const n=this;return this.getDependency("texture",s.index).then((function(i){if(!i.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":i.format=o}if(void 0!==s.texCoord&&0!=s.texCoord&&("aoMap"!==t||s.texCoord),n.extensions[j.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[j.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(i);i=n.extensions[j.KHR_TEXTURE_TRANSFORM].extendTexture(i,e),n.associations.set(i,t)}}e[t]=i}))},Ye.prototype.assignFinalMaterial=function(e){const t=e.geometry;let s=e.material;const n=void 0!==t.attributes.tangent,i=void 0!==t.attributes.color,o=void 0===t.attributes.normal,r=!0===e.isSkinnedMesh,a=Object.keys(t.morphAttributes).length>0,c=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){let e="PointsMaterial:"+s.uuid;const t=this.cache.get(e);t||(t=new te,v.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid,t=this.cache.get(e);t||(t=new J,v.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(n||i||o||r||a){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),r&&(e+="skinning:"),n&&(e+="vertex-tangents:"),i&&(e+="vertex-colors:"),o&&(e+="flat-shading:"),a&&(e+="morph-targets:"),c&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.skinning=!0),n&&(t.vertexTangents=!0),i&&(t.vertexColors=!0),o&&(t.flatShading=!0),a&&(t.morphTargets=!0),c&&(t.morphNormals=!0),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),s.normalScale&&!n&&(s.normalScale.y=-s.normalScale.y),s.clearcoatNormalScale&&!n&&(s.clearcoatNormalScale.y=-s.clearcoatNormalScale.y),e.material=s},Ye.prototype.getMaterialType=function(){return Q},Ye.prototype.loadMaterial=function(e){const t=this,{extensions:s,json:n}=this,i=n.materials[e];let o;const c={},l=i.extensions||{},p=[];if(l[j.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=s[j.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];o=e.getMaterialType(),p.push(e.extendParams(c,i,t))}else if(l[j.KHR_MATERIALS_UNLIT]){const e=s[j.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),p.push(e.extendParams(c,i,t))}else{const s=i.pbrMetallicRoughness||{};if(c.color=new T(1,1,1),c.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;c.color.fromArray(e),c.opacity=e[3]}void 0!==s.baseColorTexture&&p.push(t.assignTexture(c,"map",s.baseColorTexture)),c.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,c.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(p.push(t.assignTexture(c,"metalnessMap",s.metallicRoughnessTexture)),p.push(t.assignTexture(c,"roughnessMap",s.metallicRoughnessTexture))),o=this._invokeOne(t=>t.getMaterialType&&t.getMaterialType(e)),p.push(this._invokeAll(t=>t.extendMaterialParams&&t.extendMaterialParams(e,c)))}!0===i.doubleSided&&(c.side=r);const h=i.alphaMode||Be;return h===Ke?(c.transparent=!0,c.depthWrite=!1):(c.transparent=!1,h===Ge&&(c.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&o!==x&&(p.push(t.assignTexture(c,"normalMap",i.normalTexture)),c.normalScale=new A(1,1),void 0!==i.normalTexture.scale&&c.normalScale.set(i.normalTexture.scale,i.normalTexture.scale)),void 0!==i.occlusionTexture&&o!==x&&(p.push(t.assignTexture(c,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(c.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&o!==x&&(c.emissive=(new T).fromArray(i.emissiveFactor)),void 0!==i.emissiveTexture&&o!==x&&p.push(t.assignTexture(c,"emissiveMap",i.emissiveTexture)),Promise.all(p).then((function(){let n;return n=o===ge?s[j.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(c):new o(c),i.name&&(n.name=i.name),n.map&&(n.map.encoding=a),n.emissiveMap&&(n.emissiveMap.encoding=a),Xe(n,i),t.associations.set(n,{type:"materials",index:e}),i.extensions&&ze(s,n,i),n}))},Ye.prototype.loadGeometries=function(e){const t=this,s=this.extensions,n=this.primitiveCache,i=e=>s[j.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(s=>Ze(s,e,t)),o=[];for(let s=0,r=e.length;s<r;s++){const r=e[s],a=$e(r),c=n[a];if(c)o.push(c.promise);else{let e;e=r.extensions&&r.extensions[j.KHR_DRACO_MESH_COMPRESSION]?i(r):Ze(new I,r,t),n[a]={primitive:r,promise:e},o.push(e)}}return Promise.all(o)},Ye.prototype.loadMesh=function(e){const t=this,{json:s}=this,n=s.meshes[e],i=n.primitives,o=[];for(let e=0,t=i.length;e<t;e++){const t=void 0===i[e].material?(void 0===(r=this.cache).DefaultMaterial&&(r.DefaultMaterial=new Q({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:y})),r.DefaultMaterial):this.getDependency("material",i[e].material);o.push(t)}var r;return o.push(t.loadGeometries(i)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),r=s[s.length-1],a=[];for(let s=0,c=r.length;s<c;s++){const c=r[s],l=i[s];let p;const h=o[s];if(l.mode===_e||l.mode===Le||l.mode===Ie||void 0===l.mode)p=!0===n.isSkinnedMesh?new Ce(c,h):new C(c,h),!0!==p.isSkinnedMesh||p.geometry.attributes.skinWeight.normalized||p.normalizeSkinWeights(),l.mode===Le?p.geometry=Je(p.geometry,b):l.mode===Ie&&(p.geometry=Je(p.geometry,M));else if(l.mode===we)p=new Se(c,h);else if(l.mode===Ae)p=new ve(c,h);else if(l.mode===Re)p=new Te(c,h);else{if(l.mode!==xe)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);p=new Ee(c,h)}Object.keys(p.geometry.morphAttributes).length>0&&qe(p,n),p.name=n.name||"mesh_"+e,r.length>1&&(p.name+="_"+s),Xe(p,n),t.assignFinalMaterial(p),a.push(p)}if(1===a.length)return a[0];const c=new $;for(let e=0,t=a.length;e<t;e++)c.add(a[e]);return c}))},Ye.prototype.loadCamera=function(t){let s;const n=this.json.cameras[t],i=n[n.type];if(i)return"perspective"===n.type?s=new X(e.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(s=new B(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(s.name=n.name),Xe(s,n),Promise.resolve(s)},Ye.prototype.loadSkin=function(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))},Ye.prototype.loadAnimation=function(e){const t=this.json.animations[e],s=[],n=[],i=[],o=[],r=[];for(let e=0,a=t.channels.length;e<a;e++){const a=t.channels[e],c=t.samplers[a.sampler],l=a.target,p=void 0!==l.node?l.node:l.id,h=void 0!==t.parameters?t.parameters[c.input]:c.input,u=void 0!==t.parameters?t.parameters[c.output]:c.output;s.push(this.getDependency("node",p)),n.push(this.getDependency("accessor",h)),i.push(this.getDependency("accessor",u)),o.push(c),r.push(l)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(i),Promise.all(o),Promise.all(r)]).then((function(s){const n=s[0],i=s[1],o=s[2],r=s[3],a=s[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=i[e],p=o[e],h=r[e],u=a[e];if(void 0===t)continue;let m;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,Fe[u.path]){case Fe.weights:m=H;break;case Fe.rotation:m=F;break;case Fe.position:case Fe.scale:default:m=k}const d=t.name?t.name:t.uuid,f=void 0!==h.interpolation?He[h.interpolation]:c,g=[];Fe[u.path]===Fe.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(d);const y=p.array;if(p.normalized){let e;if(y.constructor===Int8Array)e=1/127;else if(y.constructor===Uint8Array)e=1/255;else if(y.constructor==Int16Array)e=1/32767;else{if(y.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");e=1/65535}const t=new Float32Array(y.length);for(let s=0,n=y.length;s<n;s++)t[s]=y[s]*e;y=t}for(let e=0,t=g.length;e<t;e++){const t=new m(g[e]+"."+Fe[u.path],s.array,y,f);"CUBICSPLINE"===h.interpolation&&(t.createInterpolant=function(e){return new be(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const p=t.name?t.name:"animation_"+e;return new D(p,void 0,l)}))},Ye.prototype.loadNode=function(e){const{extensions:t,json:s}=this,n=this,i=s.meshReferences,o=s.meshUses,r=s.nodes[e];return function(){const e=[];return void 0!==r.mesh&&e.push(n.getDependency("mesh",r.mesh).then((function(e){let t;if(i[r.mesh]>1){const s=o[r.mesh]++;t=e.clone(),t.name+="_instance_"+s}else t=e;return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=r.weights.length;t<s;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))),void 0!==r.camera&&e.push(n.getDependency("camera",r.camera)),r.extensions&&r.extensions[j.KHR_LIGHTS_PUNCTUAL]&&void 0!==r.extensions[j.KHR_LIGHTS_PUNCTUAL].light&&e.push(n.getDependency("light",r.extensions[j.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(e)}().then((function(s){let i;if(i=!0===r.isBone?new se:s.length>1?new $:1===s.length?s[0]:new w,i!==s[0])for(let e=0,t=s.length;e<t;e++)i.add(s[e]);if(r.name&&(i.userData.name=r.name,i.name=N.sanitizeNodeName(r.name)),Xe(i,r),r.extensions&&ze(t,i,r),void 0!==r.matrix){const e=new S;e.fromArray(r.matrix),i.applyMatrix4(e)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return n.associations.set(i,{type:"nodes",index:e}),i}))},Ye.prototype.loadScene=function(){function e(t,s,n,i){const o=n.nodes[t];return i.getDependency("node",t).then((function(e){if(void 0===o.skin)return e;let t;return i.getDependency("skin",o.skin).then((function(e){t=e;const s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(i.getDependency("node",t.joints[e]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const n=[],i=[];for(let e=0,o=s.length;e<o;e++){const o=s[e];if(o){n.push(o);const s=new S;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*e),i.push(s)}}e.bind(new je(n,i),e.matrixWorld)})),e}))})).then((function(t){s.add(t);const r=[];if(o.children){const s=o.children;for(let o=0,a=s.length;o<a;o++){const a=s[o];r.push(e(a,t,n,i))}}return Promise.all(r)}))}return function(t){const{extensions:s,json:n}=this,i=n.scenes[t],o=this,r=new $;i.name&&(r.name=i.name),Xe(r,i),i.extensions&&ze(s,r,i);const a=i.nodes||[],c=[];for(let t=0,s=a.length;t<s;t++)c.push(e(a[t],r,n,o));return Promise.all(c).then((function(){return r}))}}(),_}();export{Ne as GLTFLoader};
//# sourceMappingURL=GLTFLoader.js.map
