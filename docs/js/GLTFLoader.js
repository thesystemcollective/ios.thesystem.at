import{S as e}from"./main.js";import{Loader as t,LoaderUtils as s,FileLoader as n,Color as o,SpotLight as r,PointLight as i,DirectionalLight as a,MeshBasicMaterial as l,MeshStandardMaterial as c,TangentSpaceNormalMap as u,ImageBitmapLoader as p,TextureLoader as h,InterleavedBuffer as d,BufferAttribute as m,LinearFilter as f,LinearMipmapLinearFilter as g,RepeatWrapping as y,RGBFormat as T,PointsMaterial as v,Material as S,LineBasicMaterial as M,DoubleSide as x,Vector2 as R,sRGBEncoding as _,BufferGeometry as A,SkinnedMesh as b,Mesh as w,LineSegments as E,Line as L,LineLoop as I,Points as P,Group as O,PerspectiveCamera as C,Math as N,OrthographicCamera as U,InterpolateLinear as H,AnimationClip as F,Bone as D,Object3D as k,PropertyBinding as G,Matrix4 as j,Skeleton as K,MeshPhysicalMaterial as B,Interpolant as V,NearestFilter as X,NearestMipmapNearestFilter as z,LinearMipmapNearestFilter as $,NearestMipmapLinearFilter as W,ClampToEdgeWrapping as q,MirroredRepeatWrapping as Y,InterpolateDiscrete as Z,RGBAFormat as Q,FrontSide as J,InterleavedBufferAttribute as ee,CanvasTexture as te,TriangleFanDrawMode as se,TriangleStripDrawMode as ne,VectorKeyframeTrack as oe,QuaternionKeyframeTrack as re,NumberKeyframeTrack as ie,Box3 as ae,Vector3 as le,Sphere as ce}from"./three.module.js";const ue=({camera:t,controller:s,model:n,reticle:o,scene:r,type:i,xrSupported:a})=>()=>{if(a){if(i===e.HIT)o.visible&&(n.position.setFromMatrixPosition(o.matrix),r.add(n));else if(i===e.FLOAT){const e=n.clone();e.position.set(0,0,-1).applyMatrix4(s.matrixWorld),e.quaternion.setFromRotationMatrix(s.matrixWorld),r.add(e)}}else t.position.set(0,0,5),n.position.set(0,-2,0),s&&s.update(),r.add(n)},pe=function(){function e(e){t.call(this,e),this.dracoLoader=null,this.ddsLoader=null,this.pluginCallbacks=[],this.register((function(e){return new fe(e)}))}function ue(){let e={};return{get:t=>e[t],add(t,s){e[t]=s},remove(t){delete e[t]},removeAll(){e={}}}}e.prototype=Object.assign(Object.create(t.prototype),{constructor:e,load:function(e,t,o,r){const i=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:s.extractUrlBase(e),i.manager.itemStart(e);const l=t=>{r&&r(t),i.manager.itemError(e),i.manager.itemEnd(e)},c=new n(i.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),"use-credentials"===i.crossOrigin&&c.setWithCredentials(!0),c.load(e,(function(s){try{i.parse(s,a,(function(s){t(s),i.manager.itemEnd(e)}),l)}catch(e){l(e)}}),o,l)},setDRACOLoader(e){return this.dracoLoader=e,this},setDDSLoader(e){return this.ddsLoader=e,this},register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse(e,t,n,o){let r;const i={},a={};if("string"==typeof e)r=e;else{if(s.decodeText(new Uint8Array(e,0,4))===ge){try{i[pe.KHR_BINARY_GLTF]=new ve(e)}catch(e){return void(o&&o(e))}r=i[pe.KHR_BINARY_GLTF].content}else r=s.decodeText(new Uint8Array(e))}const l=JSON.parse(r);if(void 0===l.asset||l.asset.version[0]<2)return void(o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new qe(l,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);a[t.name]=t,i[t.name]=!0}if(l.extensionsUsed)for(let e=0;e<l.extensionsUsed.length;++e){const t=l.extensionsUsed[e],s=l.extensionsRequired||[];switch(t){case pe.KHR_LIGHTS_PUNCTUAL:i[t]=new de(l);break;case pe.KHR_MATERIALS_UNLIT:i[t]=new me;break;case pe.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[t]=new Re;break;case pe.KHR_DRACO_MESH_COMPRESSION:i[t]=new Se(l,this.dracoLoader);break;case pe.MSFT_TEXTURE_DDS:i[t]=new he(this.ddsLoader);break;case pe.KHR_TEXTURE_TRANSFORM:i[t]=new Me;break;case pe.KHR_MESH_QUANTIZATION:i[t]=new _e;break;default:s.indexOf(t)>=0&&a[t]}}c.setExtensions(i),c.setPlugins(a),c.parse(n,o)}});const pe={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function he(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=pe.MSFT_TEXTURE_DDS,this.ddsLoader=e}function de(e){this.name=pe.KHR_LIGHTS_PUNCTUAL;const t=e.extensions&&e.extensions[pe.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function me(){this.name=pe.KHR_MATERIALS_UNLIT}function fe(e){this.parser=e,this.name=pe.KHR_MATERIALS_CLEARCOAT}de.prototype.loadLight=function(e){const t=this.lightDefs[e];let s;const n=new o(16777215);void 0!==t.color&&n.fromArray(t.color);const l=void 0!==t.range?t.range:0;switch(t.type){case"directional":s=new a(n),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new i(n),s.distance=l;break;case"spot":s=new r(n),s.distance=l,t.spot=t.spot||{},t.spot.innerConeAngle=void 0!==t.spot.innerConeAngle?t.spot.innerConeAngle:0,t.spot.outerConeAngle=void 0!==t.spot.outerConeAngle?t.spot.outerConeAngle:Math.PI/4,s.angle=t.spot.outerConeAngle,s.penumbra=1-t.spot.innerConeAngle/t.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+t.type+'".')}return s.position.set(0,0,0),s.decay=2,void 0!==t.intensity&&(s.intensity=t.intensity),s.name=t.name||"light_"+e,Promise.resolve(s)},me.prototype.getMaterialType=function(){return l},me.prototype.extendParams=function(e,t,s){const n=[];e.color=new o(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==r.baseColorTexture&&n.push(s.assignTexture(e,"map",r.baseColorTexture))}return Promise.all(n)},fe.prototype.getMaterialType=function(){return B},fe.prototype.extendMaterialParams=function(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&o.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&o.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(o.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new R(e,e)}return Promise.all(o)};const ge="glTF",ye=1313821514,Te=5130562;function ve(e){this.name=pe.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:s.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ge)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=new DataView(e,12);let o=0;for(;o<n.byteLength;){const t=n.getUint32(o,!0);o+=4;const r=n.getUint32(o,!0);if(o+=4,r===ye){const n=new Uint8Array(e,12+o,t);this.content=s.decodeText(n)}else if(r===Te){const s=12+o;this.body=e.slice(s,s+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function Se(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=pe.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function Me(){this.name=pe.KHR_TEXTURE_TRANSFORM}function xe(e){c.call(this),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),r=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),i=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),a={specular:{value:(new o).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(let t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",t),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",s),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",r),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",i)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function Re(){return{name:pe.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return xe},extendParams:function(e,t,s){const n=t.extensions[this.name];e.color=new o(1,1,1),e.opacity=1;const r=[];if(Array.isArray(n.diffuseFactor)){const t=n.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==n.diffuseTexture&&r.push(s.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new o(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new o(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;r.push(s.assignTexture(e,"glossinessMap",t)),r.push(s.assignTexture(e,"specularMap",t))}return Promise.all(r)},createMaterial:function(e){const t=new xe(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=u,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function _e(){this.name=pe.KHR_MESH_QUANTIZATION}function Ae(e,t,s,n){V.call(this,e,t,s,n)}Se.prototype.decodePrimitive=function(e,t){const s=this.json,n=this.dracoLoader,o=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,i={},a={},l={};for(let e in r){const t=Fe[e]||e.toLowerCase();i[t]=r[e]}for(attributeName in e.attributes){const t=Fe[attributeName]||attributeName.toLowerCase();if(void 0!==r[attributeName]){const n=s.accessors[e.attributes[attributeName]],o=Ce[n.componentType];l[t]=o,a[t]=!0===n.normalized}}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(let t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)}),i,l)}))}))},Me.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),t.texCoord,e.needsUpdate=!0,e},xe.prototype=Object.create(c.prototype),xe.prototype.constructor=xe,xe.prototype.copy=function(e){return c.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},Ae.prototype=Object.create(V.prototype),Ae.prototype.constructor=Ae,Ae.prototype.copySampleValue_=function(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,o=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[o+e];return t},Ae.prototype.beforeStart_=Ae.prototype.copySampleValue_,Ae.prototype.afterEnd_=Ae.prototype.copySampleValue_,Ae.prototype.interpolate_=function(e,t,s,n){const o=this.resultBuffer,r=this.sampleValues,i=this.valueSize,a=2*i,l=3*i,c=n-t,u=(s-t)/c,p=u*u,h=p*u,d=e*l,m=d-l,f=-2*h+3*p,g=h-p,y=1-f,T=g-p+u;for(let e=0;e!==i;e++){const t=r[m+e+i],s=r[m+e+a]*c,n=r[d+e+i],l=r[d+e]*c;o[e]=y*t+T*s+f*n+g*l}return o};const be=0,we=1,Ee=2,Le=3,Ie=4,Pe=5,Oe=6,Ce={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ne={9728:X,9729:f,9984:z,9985:$,9986:W,9987:g},Ue={33071:q,33648:Y,10497:y},He={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Fe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},De={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ke={CUBICSPLINE:void 0,LINEAR:H,STEP:Z},Ge="OPAQUE",je="MASK",Ke="BLEND",Be={"image/png":Q,"image/jpeg":T};function Ve(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function Xe(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function ze(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function $e(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function We(e){const t=e.extensions&&e.extensions[pe.KHR_DRACO_MESH_COMPRESSION];if(t){const{bufferView:e,indices:s,attributes:n}=t;return`draco:${e}:${s}:${n}`}{const{indices:t,attributes:s,mode:n}=e;return`${t}:${function(e){let t="";const s=Object.keys(e).sort();for(let n=0,o=s.length;n<o;n++)t+=s[n]+":"+e[s[n]]+";";return t}(s)}:${n}`}}function qe(e,t){this.json=e||{},this.extensions={},this.plugins={},this.options=t||{},this.cache=new ue,this.associations=new Map,this.primitiveCache={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new p(this.options.manager):this.textureLoader=new h(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new n(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function Ye(e,t,s){const n=t.attributes,o=[],r=(t,n)=>s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}));for(let t in n){const s=Fe[t]||t.toLowerCase();s in e.attributes||o.push(r(n[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(n)}return ze(e,t),function(e,t,s){const n=t.attributes,o=new ae;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],{max:t,min:r}=e;if(void 0===r||void 0===t)return;o.set(new le(r[0],r[1],r[2]),new le(t[0],t[1],t[2]))}const r=t.targets;if(void 0!==r){const e=new le,t=new le;for(let n=0,o=r.length;n<o;n++){const o=r[n];if(void 0!==o.POSITION){const n=s.json.accessors[o.POSITION],{max:r,min:i}=n;void 0!==i&&void 0!==r&&(t.setX(Math.max(Math.abs(i[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(i[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(i[2]),Math.abs(r[2]))),e.max(t))}}o.expandByVector(e)}e.boundingBox=o;const i=new ce;o.getCenter(i.center),i.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=i}(e,t,s),Promise.all(o).then(()=>void 0!==t.targets?function(e,t,s){let n=!1,o=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(o=!0),n&&o)break}if(!n&&!o)return Promise.resolve(e);const r=[],i=[];for(let a=0,l=t.length;a<l;a++){const l=t[a];if(n){const t=void 0!==l.POSITION?s.getDependency("accessor",l.POSITION):e.attributes.position;r.push(t)}if(o){const t=void 0!==l.NORMAL?s.getDependency("accessor",l.NORMAL):e.attributes.normal;i.push(t)}}return Promise.all([Promise.all(r),Promise.all(i)]).then((function(t){const s=t[0],r=t[1];return n&&(e.morphAttributes.position=s),o&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e)}function Ze(e,t){const s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,o=[];if(t===se)for(let e=1;e<=n;e++)o.push(s.getX(0)),o.push(s.getX(e)),o.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(o.push(s.getX(e)),o.push(s.getX(e+1)),o.push(s.getX(e+2))):(o.push(s.getX(e+2)),o.push(s.getX(e+1)),o.push(s.getX(e)));const r=e.clone();return r.setIndex(o),r}return qe.prototype.setExtensions=function(e){this.extensions=e},qe.prototype.setPlugins=function(e){this.plugins=e},qe.prototype.parse=function(e,t){const s=this,{extensions:n,json:o}=this;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){const r={scene:t[0][o.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:o.asset,parser:s,userData:{}};Xe(n,r,o),ze(r,o),e(r)})).catch(t)},qe.prototype.markDefs=function(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],n={},o={};for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(void 0===n[r.mesh]&&(n[r.mesh]=o[r.mesh]=0),n[r.mesh]++,void 0!==r.skin&&(s[r.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=o},qe.prototype._invokeOne=function(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}},qe.prototype._invokeAll=function(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++)s.push(e(t[n]));return Promise.all(s)},qe.prototype.getDependency=function(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this.loadTexture(t);break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;case"light":n=this.extensions[pe.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n},qe.prototype.getDependencies=function(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((t,n)=>s.getDependency(e,n))),this.cache.add(e,t)}return t},qe.prototype.loadBuffer=function(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[pe.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,o){s.load(Ve(t.uri,n.path),e,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},qe.prototype.loadBufferView=function(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const{byteLength:s=0,byteOffset:n=0}=t;return e.slice(n,n+s)}))},qe.prototype.loadAccessor=function(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],r=He[n.type],i=Ce[n.componentType],a=i.BYTES_PER_ELEMENT,l=a*r,c=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;let h,f;if(u&&u!==l){const e=Math.floor(c/u),{bufferView:s,componentType:o,count:l}=n,m=`InterleavedBuffer:${s}:${o}:${e}:${l}`,g=t.cache.get(m);g||(h=new i(s,e*u,n.count*u/a),g=new d(h,u/a),t.cache.add(m,g)),f=new ee(g,r,c%u/a,p)}else h=null===o?new i(n.count*r):new i(o,c,n.count*r),f=new m(h,r,p);if(void 0!==n.sparse){const t=He.SCALAR,s=Ce[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],a,n.sparse.count*t),u=new i(e[2],l,n.sparse.count*r);null!==o&&(f=new m(f.array.slice(),f.itemSize,f.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(f.setX(t,u[e*r]),r>=2&&f.setY(t,u[e*r+1]),r>=3&&f.setZ(t,u[e*r+2]),r>=4&&f.setW(t,u[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return f}))},qe.prototype.loadTexture=function(e){const t=this,{json:s,options:n,textureLoader:o}=this,r=self.URL||self.webkitURL,i=s.textures[e],a=i.extensions||{};let l;l=a[pe.MSFT_TEXTURE_DDS]?s.images[a[pe.MSFT_TEXTURE_DDS].source]:s.images[i.source];let c=l.uri,u=!1;return void 0!==l.bufferView&&(c=t.getDependency("bufferView",l.bufferView).then((function(e){u=!0;const t=new Blob([e],{type:l.mimeType});return c=r.createObjectURL(t),c}))),Promise.resolve(c).then((function(e){let s=n.manager.getHandler(e);return s||(s=a[pe.MSFT_TEXTURE_DDS]?t.extensions[pe.MSFT_TEXTURE_DDS].ddsLoader:o),new Promise((function(t,o){let r=t;!0===s.isImageBitmapLoader&&(r=e=>t(new te(e))),s.load(Ve(e,n.path),r,void 0,o)}))})).then((function(n){!0===u&&r.revokeObjectURL(c),n.flipY=!1,i.name&&(n.name=i.name),l.mimeType in Be&&(n.format=Be[l.mimeType]);const o=(s.samplers||{})[i.sampler]||{};return n.magFilter=Ne[o.magFilter]||f,n.minFilter=Ne[o.minFilter]||g,n.wrapS=Ue[o.wrapS]||y,n.wrapT=Ue[o.wrapT]||y,t.associations.set(n,{type:"textures",index:e}),n}))},qe.prototype.assignTexture=function(e,t,s){const n=this;return this.getDependency("texture",s.index).then((function(o){if(!o.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":o.format=T}if(void 0!==s.texCoord&&0!=s.texCoord&&("aoMap"!==t||s.texCoord),n.extensions[pe.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[pe.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(o);o=n.extensions[pe.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),n.associations.set(o,t)}}e[t]=o}))},qe.prototype.assignFinalMaterial=function(e){const t=e.geometry;let s=e.material;const n=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,r=void 0===t.attributes.normal,i=!0===e.isSkinnedMesh,a=Object.keys(t.morphAttributes).length>0,l=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){let e="PointsMaterial:"+s.uuid;const t=this.cache.get(e);t||(t=new v,S.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid,t=this.cache.get(e);t||(t=new M,S.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(n||o||r||i||a){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),i&&(e+="skinning:"),n&&(e+="vertex-tangents:"),o&&(e+="vertex-colors:"),r&&(e+="flat-shading:"),a&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.skinning=!0),n&&(t.vertexTangents=!0),o&&(t.vertexColors=!0),r&&(t.flatShading=!0),a&&(t.morphTargets=!0),l&&(t.morphNormals=!0),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),s.normalScale&&!n&&(s.normalScale.y=-s.normalScale.y),s.clearcoatNormalScale&&!n&&(s.clearcoatNormalScale.y=-s.clearcoatNormalScale.y),e.material=s},qe.prototype.getMaterialType=function(){return c},qe.prototype.loadMaterial=function(e){const t=this,{extensions:s,json:n}=this,r=n.materials[e];let i;const a={},c=r.extensions||{},u=[];if(c[pe.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=s[pe.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=e.getMaterialType(),u.push(e.extendParams(a,r,t))}else if(c[pe.KHR_MATERIALS_UNLIT]){const e=s[pe.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),u.push(e.extendParams(a,r,t))}else{const s=r.pbrMetallicRoughness||{};if(a.color=new o(1,1,1),a.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;a.color.fromArray(e),a.opacity=e[3]}void 0!==s.baseColorTexture&&u.push(t.assignTexture(a,"map",s.baseColorTexture)),a.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,a.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(u.push(t.assignTexture(a,"metalnessMap",s.metallicRoughnessTexture)),u.push(t.assignTexture(a,"roughnessMap",s.metallicRoughnessTexture))),i=this._invokeOne(t=>t.getMaterialType&&t.getMaterialType(e)),u.push(this._invokeAll(t=>t.extendMaterialParams&&t.extendMaterialParams(e,a)))}!0===r.doubleSided&&(a.side=x);const p=r.alphaMode||Ge;return p===Ke?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,p===je&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&i!==l&&(u.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new R(1,1),void 0!==r.normalTexture.scale&&a.normalScale.set(r.normalTexture.scale,r.normalTexture.scale)),void 0!==r.occlusionTexture&&i!==l&&(u.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(a.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&i!==l&&(a.emissive=(new o).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&i!==l&&u.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture)),Promise.all(u).then((function(){let n;return n=i===xe?s[pe.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new i(a),r.name&&(n.name=r.name),n.map&&(n.map.encoding=_),n.emissiveMap&&(n.emissiveMap.encoding=_),ze(n,r),t.associations.set(n,{type:"materials",index:e}),r.extensions&&Xe(s,n,r),n}))},qe.prototype.loadGeometries=function(e){const t=this,s=this.extensions,n=this.primitiveCache,o=e=>s[pe.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(s=>Ye(s,e,t)),r=[];for(let s=0,i=e.length;s<i;s++){const i=e[s],a=We(i),l=n[a];if(l)r.push(l.promise);else{let e;e=i.extensions&&i.extensions[pe.KHR_DRACO_MESH_COMPRESSION]?o(i):Ye(new A,i,t),n[a]={primitive:i,promise:e},r.push(e)}}return Promise.all(r)},qe.prototype.loadMesh=function(e){const t=this,{json:s}=this,n=s.meshes[e],o=n.primitives,r=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(i=this.cache).DefaultMaterial&&(i.DefaultMaterial=new c({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:J})),i.DefaultMaterial):this.getDependency("material",o[e].material);r.push(t)}var i;return r.push(t.loadGeometries(o)),Promise.all(r).then((function(s){const r=s.slice(0,s.length-1),i=s[s.length-1],a=[];for(let s=0,l=i.length;s<l;s++){const l=i[s],c=o[s];let u;const p=r[s];if(c.mode===Ie||c.mode===Pe||c.mode===Oe||void 0===c.mode)u=!0===n.isSkinnedMesh?new b(l,p):new w(l,p),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),c.mode===Pe?u.geometry=Ze(u.geometry,ne):c.mode===Oe&&(u.geometry=Ze(u.geometry,se));else if(c.mode===we)u=new E(l,p);else if(c.mode===Le)u=new L(l,p);else if(c.mode===Ee)u=new I(l,p);else{if(c.mode!==be)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);u=new P(l,p)}Object.keys(u.geometry.morphAttributes).length>0&&$e(u,n),u.name=n.name||"mesh_"+e,i.length>1&&(u.name+="_"+s),ze(u,n),t.assignFinalMaterial(u),a.push(u)}if(1===a.length)return a[0];const l=new O;for(let e=0,t=a.length;e<t;e++)l.add(a[e]);return l}))},qe.prototype.loadCamera=function(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new C(N.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new U(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=s.name),ze(t,s),Promise.resolve(t)},qe.prototype.loadSkin=function(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))},qe.prototype.loadAnimation=function(e){const t=this.json.animations[e],s=[],n=[],o=[],r=[],i=[];for(let e=0,a=t.channels.length;e<a;e++){const a=t.channels[e],l=t.samplers[a.sampler],c=a.target,u=void 0!==c.node?c.node:c.id,p=void 0!==t.parameters?t.parameters[l.input]:l.input,h=void 0!==t.parameters?t.parameters[l.output]:l.output;s.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",p)),o.push(this.getDependency("accessor",h)),r.push(l),i.push(c)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(o),Promise.all(r),Promise.all(i)]).then((function(s){const n=s[0],o=s[1],r=s[2],i=s[3],a=s[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=o[e],c=r[e],u=i[e],p=a[e];if(void 0===t)continue;let h;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,De[p.path]){case De.weights:h=ie;break;case De.rotation:h=re;break;case De.position:case De.scale:default:h=oe}const d=t.name?t.name:t.uuid,m=void 0!==u.interpolation?ke[u.interpolation]:H,f=[];De[p.path]===De.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&f.push(e.name?e.name:e.uuid)})):f.push(d);const g=c.array;if(c.normalized){let e;if(g.constructor===Int8Array)e=1/127;else if(g.constructor===Uint8Array)e=1/255;else if(g.constructor==Int16Array)e=1/32767;else{if(g.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");e=1/65535}const t=new Float32Array(g.length);for(let s=0,n=g.length;s<n;s++)t[s]=g[s]*e;g=t}for(let e=0,t=f.length;e<t;e++){const t=new h(f[e]+"."+De[p.path],s.array,g,m);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new Ae(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new F(c,void 0,l)}))},qe.prototype.loadNode=function(e){const{extensions:t,json:s}=this,n=this,o=s.meshReferences,r=s.meshUses,i=s.nodes[e];return function(){const e=[];return void 0!==i.mesh&&e.push(n.getDependency("mesh",i.mesh).then((function(e){let t;if(o[i.mesh]>1){const s=r[i.mesh]++;t=e.clone(),t.name+="_instance_"+s}else t=e;return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))),void 0!==i.camera&&e.push(n.getDependency("camera",i.camera)),i.extensions&&i.extensions[pe.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[pe.KHR_LIGHTS_PUNCTUAL].light&&e.push(n.getDependency("light",i.extensions[pe.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(e)}().then((function(s){let o;if(o=!0===i.isBone?new D:s.length>1?new O:1===s.length?s[0]:new k,o!==s[0])for(let e=0,t=s.length;e<t;e++)o.add(s[e]);if(i.name&&(o.userData.name=i.name,o.name=G.sanitizeNodeName(i.name)),ze(o,i),i.extensions&&Xe(t,o,i),void 0!==i.matrix){const e=new j;e.fromArray(i.matrix),o.applyMatrix4(e)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return n.associations.set(o,{type:"nodes",index:e}),o}))},qe.prototype.loadScene=function(){function e(t,s,n,o){const r=n.nodes[t];return o.getDependency("node",t).then((function(e){if(void 0===r.skin)return e;let t;return o.getDependency("skin",r.skin).then((function(e){t=e;const s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(o.getDependency("node",t.joints[e]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const n=[],o=[];for(let e=0,r=s.length;e<r;e++){const r=s[e];if(r){n.push(r);const s=new j;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*e),o.push(s)}}e.bind(new K(n,o),e.matrixWorld)})),e}))})).then((function(t){s.add(t);const i=[];if(r.children){const s=r.children;for(let r=0,a=s.length;r<a;r++){const a=s[r];i.push(e(a,t,n,o))}}return Promise.all(i)}))}return function(t){const{extensions:s,json:n}=this,o=n.scenes[t],r=this,i=new O;o.name&&(i.name=o.name),ze(i,o),o.extensions&&Xe(s,i,o);const a=o.nodes||[],l=[];for(let t=0,s=a.length;t<s;t++)l.push(e(a[t],i,n,r));return Promise.all(l).then((function(){return i}))}}(),e}();export{pe as G,ue as s};
