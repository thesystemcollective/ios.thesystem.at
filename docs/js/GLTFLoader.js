import{b as e,c as t,d as r,v as s,S as a}from"../main.js";import{TextureLoader as n,SphereGeometry as o,MeshBasicMaterial as i,Mesh as l,Loader as c,FileLoader as u,BufferGeometry as d,BufferAttribute as h,LoaderUtils as p,Color as f,MeshStandardMaterial as m,TangentSpaceNormalMap as g,ImageBitmapLoader as v,InterleavedBuffer as y,RGBFormat as T,LinearFilter as x,LinearMipmapLinearFilter as _,RepeatWrapping as R,PointsMaterial as w,Material as b,LineBasicMaterial as M,DoubleSide as A,Vector2 as E,sRGBEncoding as S,PropertyBinding as L,SkinnedMesh as I,LineSegments as P,Line as C,LineLoop as D,Points as O,Group as k,PerspectiveCamera as U,Math as N,OrthographicCamera as F,InterpolateLinear as H,AnimationClip as G,Bone as j,Object3D as B,Matrix4 as K,Skeleton as V,SpotLight as X,PointLight as z,DirectionalLight as q,MeshPhysicalMaterial as W,Interpolant as Y,NearestFilter as J,NearestMipmapNearestFilter as Z,LinearMipmapNearestFilter as Q,NearestMipmapLinearFilter as ee,ClampToEdgeWrapping as te,MirroredRepeatWrapping as re,InterpolateDiscrete as se,FrontSide as ae,InterleavedBufferAttribute as ne,CanvasTexture as oe,TriangleFanDrawMode as ie,TriangleStripDrawMode as le,VectorKeyframeTrack as ce,QuaternionKeyframeTrack as ue,NumberKeyframeTrack as de,Box3 as he,Vector3 as pe,Sphere as fe}from"./three.module.js";const me=async({data:r,scene:s,visible:a=!1})=>{const c=r.sky||"default";const u=`${t}/${c}.jpg`,d=new o(...e);d.scale(-1,1,1);const h=await(async(e,t=new n)=>new Promise(((r,s)=>{t.load(e,r,(()=>{}),s)})))(u),p=new i({map:h}),f=new l(d,p);return f.visible=a,s.add(f),f},ge=({controller:e,model:t,reticle:n,scene:o,shadowPlane:i,type:l,XR:c=!1})=>()=>{const u=$("#"+r);u&&u.play();const d=$("#"+s);if(d&&d.play(),c){if(l===a.HIT)n.visible&&(t.position.setFromMatrixPosition(n.matrix),i&&(n.updateMatrixWorld(),i.position.setFromMatrixPosition(n.matrixWorld),o.add(i)),o.add(t));else if(l===a.FLOAT){const r=t.clone();r.position.set(0,0,-1).applyMatrix4(e.matrixWorld),r.quaternion.setFromRotationMatrix(e.matrixWorld),o.add(r)}}else o.add(t)};var ve=function(e){c.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};ve.prototype=Object.assign(Object.create(c.prototype),{constructor:ve,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,t,r,s){var a=new u(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(e=>{var r={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,r).then(t).catch(s)}),r,s)},decodeDracoFile:function(e,t,r,s){var a={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,a).then(t)},decodeGeometry:function(e,t){for(var r in t.attributeTypes){var s=t.attributeTypes[r];void 0!==s.BYTES_PER_ELEMENT&&(t.attributeTypes[r]=s.name)}var a,n=JSON.stringify(t);if(ve.taskCache.has(e)){var o=ve.taskCache.get(e);if(o.key===n)return o.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var i=this.workerNextTaskID++,l=e.byteLength,c=this._getWorker(i,l).then((r=>(a=r,new Promise(((r,s)=>{a._callbacks[i]={resolve:r,reject:s},a.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return c.catch((()=>!0)).then((()=>{a&&i&&this._releaseTask(a,i)})),ve.taskCache.set(e,{key:n,promise:c}),c},_createGeometry:function(e){var t=new d;e.index&&t.setIndex(new h(e.index.array,1));for(var r=0;r<e.attributes.length;r++){var s=e.attributes[r],a=s.name,n=s.array,o=s.itemSize;t.setAttribute(a,new h(n,o))}return t},_loadLibrary:function(e,t){var r=new u(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise(((t,s)=>{r.load(e,t,void 0,s)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{var r=t[0];e||(this.decoderConfig.wasmBinary=t[1]);var s=ve.DRACOWorker.toString(),a=["/* draco decoder */",r,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a]))})),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then((()=>{var r;this.workerPool.length<this.workerLimit?((r=new Worker(this.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:this.decoderConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(r)):this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(r=this.workerPool[this.workerPool.length-1])._taskCosts[e]=t,r._taskLoad+=t,r}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),ve.DRACOWorker=function(){var e,t;function r(e,t,r,s,a,n){var o=n.num_components(),i=r.num_points()*o,l=i*a.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),u=e._malloc(l);t.GetAttributeDataArrayForAllPoints(r,n,c,l,u);var d=new a(e.HEAPF32.buffer,u,i).slice();return e._free(u),{name:s,array:d,itemSize:o}}onmessage=function(s){var a=s.data;switch(a.type){case"init":e=a.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":var n=a.buffer,o=a.taskConfig;t.then((e=>{var t=e.draco,s=new t.Decoder,i=new t.DecoderBuffer;i.Init(new Int8Array(n),n.byteLength);try{var l=function(e,t,s,a){var n,o,i=a.attributeIDs,l=a.attributeTypes,c=t.GetEncodedGeometryType(s);if(c===e.TRIANGULAR_MESH)n=new e.Mesh,o=t.DecodeBufferToMesh(s,n);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new e.PointCloud,o=t.DecodeBufferToPointCloud(s,n)}if(!o.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+o.error_msg());var u={index:null,attributes:[]};for(var d in i){var h,p,f=self[l[d]];if(a.useUniqueIDs)p=i[d],h=t.GetAttributeByUniqueId(n,p);else{if(-1===(p=t.GetAttributeId(n,e[i[d]])))continue;h=t.GetAttribute(n,p)}u.attributes.push(r(e,t,n,d,f,h))}c===e.TRIANGULAR_MESH&&(u.index=function(e,t,r){var s=3*r.num_faces(),a=4*s,n=e._malloc(a);t.GetTrianglesUInt32Array(r,a,n);var o=new Uint32Array(e.HEAPF32.buffer,n,s).slice();return e._free(n),{array:o,itemSize:1}}(e,t,n));return e.destroy(n),u}(t,s,i,o),c=l.attributes.map((e=>e.array.buffer));l.index&&c.push(l.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:l},c)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{t.destroy(i),t.destroy(s)}}))}}},ve.taskCache=new WeakMap,ve.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},ve.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},ve.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},ve.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};var ye=function(){function e(e){c.call(this,e),this.dracoLoader=null,this.ddsLoader=null,this.ktx2Loader=null,this.pluginCallbacks=[],this.register((function(e){return new $(e)})),this.register((function(e){return new ge(e)})),this.register((function(e){return new me(e)})),this.register((function(e){return new a(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(c.prototype),{constructor:e,load:function(e,t,r,s){var a,n=this;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:p.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){s?s(t):console.error(t),n.manager.itemError(e),n.manager.itemEnd(e)},i=new u(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(r){try{n.parse(r,a,(function(r){t(r),n.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},setKTX2Loader:function(e){return this.ktx2Loader=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,a,n){var i,l={},c={};if("string"==typeof e)i=e;else if(p.decodeText(new Uint8Array(e,0,4))===ve){try{l[r.KHR_BINARY_GLTF]=new xe(e)}catch(e){return void(n&&n(e))}i=l[r.KHR_BINARY_GLTF].content}else i=p.decodeText(new Uint8Array(e));var u=JSON.parse(i);if(void 0===u.asset||u.asset.version[0]<2)n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var d=new Ye(u,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager,ktx2Loader:this.ktx2Loader});d.fileLoader.setRequestHeader(this.requestHeader);for(var h=0;h<this.pluginCallbacks.length;h++){var f=this.pluginCallbacks[h](d);c[f.name]=f,l[f.name]=!0}if(u.extensionsUsed)for(h=0;h<u.extensionsUsed.length;++h){var m=u.extensionsUsed[h],g=u.extensionsRequired||[];switch(m){case r.KHR_MATERIALS_UNLIT:l[m]=new o;break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:l[m]=new be;break;case r.KHR_DRACO_MESH_COMPRESSION:l[m]=new _e(u,this.dracoLoader);break;case r.MSFT_TEXTURE_DDS:l[m]=new s(this.ddsLoader);break;case r.KHR_TEXTURE_TRANSFORM:l[m]=new Re;break;case r.KHR_MESH_QUANTIZATION:l[m]=new Me;break;default:g.indexOf(m)>=0&&void 0===c[m]&&console.warn('THREE.GLTFLoader: Unknown extension "'+m+'".')}}d.setExtensions(l),d.setPlugins(c),d.parse(a,n)}}});var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function s(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=r.MSFT_TEXTURE_DDS,this.ddsLoader=e}function a(e){this.parser=e,this.name=r.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function o(){this.name=r.KHR_MATERIALS_UNLIT}function $(e){this.parser=e,this.name=r.KHR_MATERIALS_CLEARCOAT}function me(e){this.parser=e,this.name=r.KHR_MATERIALS_TRANSMISSION}function ge(e){this.parser=e,this.name=r.KHR_TEXTURE_BASISU}a.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],r=0,s=t.length;r<s;r++){var a=t[r];a.extensions&&a.extensions[this.name]&&void 0!==a.extensions[this.name].light&&e._addNodeRef(this.cache,a.extensions[this.name].light)}},a.prototype._loadLight=function(e){var t=this.parser,r="light:"+e,s=t.cache.get(r);if(s)return s;var a,n=t.json,o=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e],i=new f(16777215);void 0!==o.color&&i.fromArray(o.color);var l=void 0!==o.range?o.range:0;switch(o.type){case"directional":(a=new q(i)).target.position.set(0,0,-1),a.add(a.target);break;case"point":(a=new z(i)).distance=l;break;case"spot":(a=new X(i)).distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,a.angle=o.spot.outerConeAngle,a.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+o.type+'".')}return a.position.set(0,0,0),a.decay=2,void 0!==o.intensity&&(a.intensity=o.intensity),a.name=t.createUniqueName(o.name||"light_"+e),s=Promise.resolve(a),t.cache.add(r,s),s},a.prototype.createNodeAttachment=function(e){var t=this,r=this.parser,s=r.json.nodes[e],a=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===a?null:this._loadLight(a).then((function(e){return r._getNodeRef(t.cache,a,e)}))},o.prototype.getMaterialType=function(){return i},o.prototype.extendParams=function(e,t,r){var s=[];e.color=new f(1,1,1),e.opacity=1;var a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var n=a.baseColorFactor;e.color.fromArray(n),e.opacity=n[3]}void 0!==a.baseColorTexture&&s.push(r.assignTexture(e,"map",a.baseColorTexture))}return Promise.all(s)},$.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null},$.prototype.extendMaterialParams=function(e,t){var r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();var a=[],n=s.extensions[this.name];if(void 0!==n.clearcoatFactor&&(t.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&a.push(r.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&a.push(r.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(a.push(r.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale)){var o=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new E(o,o)}return Promise.all(a)},me.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?W:null},me.prototype.extendMaterialParams=function(e,t){var r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();var a=[],n=s.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&a.push(r.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(a)},ge.prototype.loadTexture=function(e){var t=this.parser,r=t.json,s=r.textures[e];if(!s.extensions||!s.extensions[this.name])return null;var a=s.extensions[this.name],n=r.images[a.source],o=t.options.ktx2Loader;if(!o)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,n,o)};var ve="glTF",ye=1313821514,Te=5130562;function xe(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:p.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ve)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var s=new DataView(e,12),a=0;a<s.byteLength;){var n=s.getUint32(a,!0);a+=4;var o=s.getUint32(a,!0);if(a+=4,o===ye){var i=new Uint8Array(e,12+a,n);this.content=p.decodeText(i)}else if(o===Te){var l=12+a;this.body=e.slice(l,l+n)}a+=n}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function _e(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function Re(){this.name=r.KHR_TEXTURE_TRANSFORM}function we(e){m.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),r=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),n=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new f).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var i in o)e.uniforms[i]=o[i];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",r).replace("#include <roughnessmap_fragment>",s).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",n)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){o.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){o.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function be(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return we},extendParams:function(e,t,r){var s=t.extensions[this.name];e.color=new f(1,1,1),e.opacity=1;var a=[];if(Array.isArray(s.diffuseFactor)){var n=s.diffuseFactor;e.color.fromArray(n),e.opacity=n[3]}if(void 0!==s.diffuseTexture&&a.push(r.assignTexture(e,"map",s.diffuseTexture)),e.emissive=new f(0,0,0),e.glossiness=void 0!==s.glossinessFactor?s.glossinessFactor:1,e.specular=new f(1,1,1),Array.isArray(s.specularFactor)&&e.specular.fromArray(s.specularFactor),void 0!==s.specularGlossinessTexture){var o=s.specularGlossinessTexture;a.push(r.assignTexture(e,"glossinessMap",o)),a.push(r.assignTexture(e,"specularMap",o))}return Promise.all(a)},createMaterial:function(e){var t=new we(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=g,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function Me(){this.name=r.KHR_MESH_QUANTIZATION}function Ae(e,t,r,s){Y.call(this,e,t,r,s)}_e.prototype.decodePrimitive=function(e,t){var r=this.json,s=this.dracoLoader,a=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,o={},i={},l={};for(var c in n){var u=Fe[c]||c.toLowerCase();o[u]=n[c]}for(c in e.attributes){u=Fe[c]||c.toLowerCase();if(void 0!==n[c]){var d=r.accessors[e.attributes[c]],h=Oe[d.componentType];l[u]=h,i[u]=!0===d.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){s.decodeDracoFile(e,(function(e){for(var r in e.attributes){var s=e.attributes[r],a=i[r];void 0!==a&&(s.normalized=a)}t(e)}),o,l)}))}))},Re.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},we.prototype=Object.create(m.prototype),we.prototype.constructor=we,we.prototype.copy=function(e){return m.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},Ae.prototype=Object.create(Y.prototype),Ae.prototype.constructor=Ae,Ae.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,s=this.valueSize,a=e*s*3+s,n=0;n!==s;n++)t[n]=r[a+n];return t},Ae.prototype.beforeStart_=Ae.prototype.copySampleValue_,Ae.prototype.afterEnd_=Ae.prototype.copySampleValue_,Ae.prototype.interpolate_=function(e,t,r,s){for(var a=this.resultBuffer,n=this.sampleValues,o=this.valueSize,i=2*o,l=3*o,c=s-t,u=(r-t)/c,d=u*u,h=d*u,p=e*l,f=p-l,m=-2*h+3*d,g=h-d,v=1-m,y=g-d+u,T=0;T!==o;T++){var x=n[f+T+o],_=n[f+T+i]*c,R=n[p+T+o],w=n[p+T]*c;a[T]=v*x+y*_+m*R+g*w}return a};var Ee=0,Se=1,Le=2,Ie=3,Pe=4,Ce=5,De=6,Oe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ke={9728:J,9729:x,9984:Z,9985:Q,9986:ee,9987:_},Ue={33071:te,33648:re,10497:R},Ne={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Fe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},He={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ge={CUBICSPLINE:void 0,LINEAR:H,STEP:se},je="OPAQUE",Be="MASK",Ke="BLEND";function Ve(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function Xe(e,t,r){for(var s in r.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=r.extensions[s])}function ze(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function qe(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,s=t.weights.length;r<s;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(r=0,s=a.length;r<s;r++)e.morphTargetDictionary[a[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function We(e){for(var t="",r=Object.keys(e).sort(),s=0,a=r.length;s<a;s++)t+=r[s]+":"+e[r[s]]+";";return t}function Ye(e,r){this.json=e||{},this.extensions={},this.plugins={},this.options=r||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new v(this.options.manager):this.textureLoader=new n(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new u(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function $e(e,t,r){var s=t.attributes,a=[];function n(t,s){return r.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(var o in s){var i=Fe[o]||o.toLowerCase();i in e.attributes||a.push(n(s[o],i))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return ze(e,t),function(e,t,r){var s=t.attributes,a=new he;if(void 0!==s.POSITION){var n=(h=r.json.accessors[s.POSITION]).min,o=h.max;if(void 0!==n&&void 0!==o){a.set(new pe(n[0],n[1],n[2]),new pe(o[0],o[1],o[2]));var i=t.targets;if(void 0!==i){for(var l=new pe,c=new pe,u=0,d=i.length;u<d;u++){var h,p=i[u];if(void 0!==p.POSITION)n=(h=r.json.accessors[p.POSITION]).min,o=h.max,void 0!==n&&void 0!==o?(c.setX(Math.max(Math.abs(n[0]),Math.abs(o[0]))),c.setY(Math.max(Math.abs(n[1]),Math.abs(o[1]))),c.setZ(Math.max(Math.abs(n[2]),Math.abs(o[2]))),l.max(c)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}a.expandByVector(l)}e.boundingBox=a;var f=new fe;a.getCenter(f.center),f.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=f}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,r){for(var s=!1,a=!1,n=0,o=t.length;n<o&&(void 0!==(c=t[n]).POSITION&&(s=!0),void 0!==c.NORMAL&&(a=!0),!s||!a);n++);if(!s&&!a)return Promise.resolve(e);var i=[],l=[];for(n=0,o=t.length;n<o;n++){var c=t[n];if(s){var u=void 0!==c.POSITION?r.getDependency("accessor",c.POSITION):e.attributes.position;i.push(u)}a&&(u=void 0!==c.NORMAL?r.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(u))}return Promise.all([Promise.all(i),Promise.all(l)]).then((function(t){var r=t[0],n=t[1];return s&&(e.morphAttributes.position=r),a&&(e.morphAttributes.normal=n),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function Je(e,t){var r=e.getIndex();if(null===r){var s=[],a=e.getAttribute("position");if(void 0===a)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var n=0;n<a.count;n++)s.push(n);e.setIndex(s),r=e.getIndex()}var o=r.count-2,i=[];if(t===ie)for(n=1;n<=o;n++)i.push(r.getX(0)),i.push(r.getX(n)),i.push(r.getX(n+1));else for(n=0;n<o;n++)n%2==0?(i.push(r.getX(n)),i.push(r.getX(n+1)),i.push(r.getX(n+2))):(i.push(r.getX(n+2)),i.push(r.getX(n+1)),i.push(r.getX(n)));i.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(i),l}return Ye.prototype.setExtensions=function(e){this.extensions=e},Ye.prototype.setPlugins=function(e){this.plugins=e},Ye.prototype.parse=function(e,t){var r=this,s=this.json,a=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){var n={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:r,userData:{}};Xe(a,n,s),ze(n,s),e(n)})).catch(t)},Ye.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],s=0,a=t.length;s<a;s++)for(var n=t[s].joints,o=0,i=n.length;o<i;o++)e[n[o]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var u=e[l];void 0!==u.mesh&&(this._addNodeRef(this.meshCache,u.mesh),void 0!==u.skin&&(r[u.mesh].isSkinnedMesh=!0)),void 0!==u.camera&&this._addNodeRef(this.cameraCache,u.camera)}},Ye.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},Ye.prototype._getNodeRef=function(e,t,r){if(e.refs[t]<=1)return r;var s=r.clone();return s.name+="_instance_"+e.uses[t]++,s},Ye.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var r=0;r<t.length;r++){var s=e(t[r]);if(s)return s}},Ye.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var r=[],s=0;s<t.length;s++){var a=e(t[s]);a&&r.push(a)}return r},Ye.prototype.getDependency=function(e,t){var r=e+":"+t,s=this.cache.get(r);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":s=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,s)}return s},Ye.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return r.getDependency(e,s)}))),this.cache.add(e,t)}return t},Ye.prototype.loadBuffer=function(e){var t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var a=this.options;return new Promise((function(e,r){s.load(Ve(t.uri,a.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},Ye.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+r)}))},Ye.prototype.loadAccessor=function(e){var t=this,r=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);var a=[];return void 0!==s.bufferView?a.push(this.getDependency("bufferView",s.bufferView)):a.push(null),void 0!==s.sparse&&(a.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,n,o=e[0],i=Ne[s.type],l=Oe[s.componentType],c=l.BYTES_PER_ELEMENT,u=c*i,d=s.byteOffset||0,p=void 0!==s.bufferView?r.bufferViews[s.bufferView].byteStride:void 0,f=!0===s.normalized;if(p&&p!==u){var m=Math.floor(d/p),g="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+m+":"+s.count,v=t.cache.get(g);v||(a=new l(o,m*p,s.count*p/c),v=new y(a,p/c),t.cache.add(g,v)),n=new ne(v,i,d%p/c,f)}else a=null===o?new l(s.count*i):new l(o,d,s.count*i),n=new h(a,i,f);if(void 0!==s.sparse){var T=Ne.SCALAR,x=Oe[s.sparse.indices.componentType],_=s.sparse.indices.byteOffset||0,R=s.sparse.values.byteOffset||0,w=new x(e[1],_,s.sparse.count*T),b=new l(e[2],R,s.sparse.count*i);null!==o&&(n=new h(n.array.slice(),n.itemSize,n.normalized));for(var M=0,A=w.length;M<A;M++){var E=w[M];if(n.setX(E,b[M*i]),i>=2&&n.setY(E,b[M*i+1]),i>=3&&n.setZ(E,b[M*i+2]),i>=4&&n.setW(E,b[M*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n}))},Ye.prototype.loadTexture=function(e){var t,s,a=this.json,n=this.options,o=a.textures[e],i=o.extensions||{};return(t=i[r.MSFT_TEXTURE_DDS]?a.images[i[r.MSFT_TEXTURE_DDS].source]:a.images[o.source]).uri&&(s=n.manager.getHandler(t.uri)),s||(s=i[r.MSFT_TEXTURE_DDS]?this.extensions[r.MSFT_TEXTURE_DDS].ddsLoader:this.textureLoader),this.loadTextureImage(e,t,s)},Ye.prototype.loadTextureImage=function(e,t,r){var s=this,a=this.json,n=this.options,o=a.textures[e],i=self.URL||self.webkitURL,l=t.uri,c=!1,u=!0;return"image/jpeg"===t.mimeType&&(u=!1),void 0!==t.bufferView&&(l=s.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var r=new DataView(e,25,1).getUint8(0,!1);u=6===r||4===r||3===r}c=!0;var s=new Blob([e],{type:t.mimeType});return l=i.createObjectURL(s)}))),Promise.resolve(l).then((function(e){return new Promise((function(t,s){var a=t;!0===r.isImageBitmapLoader&&(a=function(e){t(new oe(e))}),r.load(Ve(e,n.path),a,void 0,s)}))})).then((function(t){!0===c&&i.revokeObjectURL(l),t.flipY=!1,o.name&&(t.name=o.name),u||(t.format=T);var r=(a.samplers||{})[o.sampler]||{};return t.magFilter=ke[r.magFilter]||x,t.minFilter=ke[r.minFilter]||_,t.wrapS=Ue[r.wrapS]||R,t.wrapT=Ue[r.wrapT]||R,s.associations.set(t,{type:"textures",index:e}),t}))},Ye.prototype.assignTexture=function(e,t,s){var a=this;return this.getDependency("texture",s.index).then((function(n){if(void 0===s.texCoord||0==s.texCoord||"aoMap"===t&&1==s.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+s.texCoord+" for texture "+t+" not yet supported."),a.extensions[r.KHR_TEXTURE_TRANSFORM]){var o=void 0!==s.extensions?s.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;if(o){var i=a.associations.get(n);n=a.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(n,o),a.associations.set(n,i)}}e[t]=n}))},Ye.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,s=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,n=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,i=Object.keys(t.morphAttributes).length>0,l=i&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+r.uuid,u=this.cache.get(c);u||(u=new w,b.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,u.sizeAttenuation=!1,this.cache.add(c,u)),r=u}else if(e.isLine){c="LineBasicMaterial:"+r.uuid;var d=this.cache.get(c);d||(d=new M,b.prototype.copy.call(d,r),d.color.copy(r.color),this.cache.add(c,d)),r=d}if(s||a||n||o||i){c="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),o&&(c+="skinning:"),s&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),n&&(c+="flat-shading:"),i&&(c+="morph-targets:"),l&&(c+="morph-normals:");var h=this.cache.get(c);h||(h=r.clone(),o&&(h.skinning=!0),s&&(h.vertexTangents=!0),a&&(h.vertexColors=!0),n&&(h.flatShading=!0),i&&(h.morphTargets=!0),l&&(h.morphNormals=!0),this.cache.add(c,h),this.associations.set(h,this.associations.get(r))),r=h}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),r.normalScale&&!s&&(r.normalScale.y=-r.normalScale.y),r.clearcoatNormalScale&&!s&&(r.clearcoatNormalScale.y=-r.clearcoatNormalScale.y),e.material=r},Ye.prototype.getMaterialType=function(){return m},Ye.prototype.loadMaterial=function(e){var t,s=this,a=this.json,n=this.extensions,o=a.materials[e],l={},c=o.extensions||{},u=[];if(c[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var d=n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=d.getMaterialType(),u.push(d.extendParams(l,o,s))}else if(c[r.KHR_MATERIALS_UNLIT]){var h=n[r.KHR_MATERIALS_UNLIT];t=h.getMaterialType(),u.push(h.extendParams(l,o,s))}else{var p=o.pbrMetallicRoughness||{};if(l.color=new f(1,1,1),l.opacity=1,Array.isArray(p.baseColorFactor)){var m=p.baseColorFactor;l.color.fromArray(m),l.opacity=m[3]}void 0!==p.baseColorTexture&&u.push(s.assignTexture(l,"map",p.baseColorTexture)),l.metalness=void 0!==p.metallicFactor?p.metallicFactor:1,l.roughness=void 0!==p.roughnessFactor?p.roughnessFactor:1,void 0!==p.metallicRoughnessTexture&&(u.push(s.assignTexture(l,"metalnessMap",p.metallicRoughnessTexture)),u.push(s.assignTexture(l,"roughnessMap",p.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),u.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,l)}))))}!0===o.doubleSided&&(l.side=A);var g=o.alphaMode||je;return g===Ke?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,g===Be&&(l.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==i&&(u.push(s.assignTexture(l,"normalMap",o.normalTexture)),l.normalScale=new E(1,1),void 0!==o.normalTexture.scale&&l.normalScale.set(o.normalTexture.scale,o.normalTexture.scale)),void 0!==o.occlusionTexture&&t!==i&&(u.push(s.assignTexture(l,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(l.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==i&&(l.emissive=(new f).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&t!==i&&u.push(s.assignTexture(l,"emissiveMap",o.emissiveTexture)),Promise.all(u).then((function(){var a;return a=t===we?n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new t(l),o.name&&(a.name=o.name),a.map&&(a.map.encoding=S),a.emissiveMap&&(a.emissiveMap.encoding=S),ze(a,o),s.associations.set(a,{type:"materials",index:e}),o.extensions&&Xe(n,a,o),a}))},Ye.prototype.createUniqueName=function(e){for(var t=L.sanitizeNodeName(e||""),r=1;this.nodeNamesUsed[t];++r)t=e+"_"+r;return this.nodeNamesUsed[t]=!0,t},Ye.prototype.loadGeometries=function(e){var t=this,s=this.extensions,a=this.primitiveCache;function n(e){return s[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return $e(r,e,t)}))}for(var o,i,l=[],c=0,u=e.length;c<u;c++){var h,p=e[c],f=(i=void 0,(i=(o=p).extensions&&o.extensions[r.KHR_DRACO_MESH_COMPRESSION])?"draco:"+i.bufferView+":"+i.indices+":"+We(i.attributes):o.indices+":"+We(o.attributes)+":"+o.mode),m=a[f];if(m)l.push(m.promise);else h=p.extensions&&p.extensions[r.KHR_DRACO_MESH_COMPRESSION]?n(p):$e(new d,p,t),a[f]={primitive:p,promise:h},l.push(h)}return Promise.all(l)},Ye.prototype.loadMesh=function(e){for(var t,r=this,s=this.json.meshes[e],a=s.primitives,n=[],o=0,i=a.length;o<i;o++){var c=void 0===a[o].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new m({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ae})),t.DefaultMaterial):this.getDependency("material",a[o].material);n.push(c)}return n.push(r.loadGeometries(a)),Promise.all(n).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],i=[],c=0,u=o.length;c<u;c++){var d,h=o[c],p=a[c],f=n[c];if(p.mode===Pe||p.mode===Ce||p.mode===De||void 0===p.mode)!0!==(d=!0===s.isSkinnedMesh?new I(h,f):new l(h,f)).isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),p.mode===Ce?d.geometry=Je(d.geometry,le):p.mode===De&&(d.geometry=Je(d.geometry,ie));else if(p.mode===Se)d=new P(h,f);else if(p.mode===Ie)d=new C(h,f);else if(p.mode===Le)d=new D(h,f);else{if(p.mode!==Ee)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);d=new O(h,f)}Object.keys(d.geometry.morphAttributes).length>0&&qe(d,s),d.name=r.createUniqueName(s.name||"mesh_"+e),o.length>1&&(d.name+="_"+c),ze(d,s),r.assignFinalMaterial(d),i.push(d)}if(1===i.length)return i[0];var m=new k;for(c=0,u=i.length;c<u;c++)m.add(i[c]);return m}))},Ye.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],s=r[r.type];if(s)return"perspective"===r.type?t=new U(N.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===r.type&&(t=new F(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),ze(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},Ye.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},Ye.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],s=[],a=[],n=[],o=[],i=0,l=t.channels.length;i<l;i++){var c=t.channels[i],u=t.samplers[c.sampler],d=c.target,h=void 0!==d.node?d.node:d.id,p=void 0!==t.parameters?t.parameters[u.input]:u.input,f=void 0!==t.parameters?t.parameters[u.output]:u.output;r.push(this.getDependency("node",h)),s.push(this.getDependency("accessor",p)),a.push(this.getDependency("accessor",f)),n.push(u),o.push(d)}return Promise.all([Promise.all(r),Promise.all(s),Promise.all(a),Promise.all(n),Promise.all(o)]).then((function(r){for(var s=r[0],a=r[1],n=r[2],o=r[3],i=r[4],l=[],c=0,u=s.length;c<u;c++){var d=s[c],h=a[c],p=n[c],f=o[c],m=i[c];if(void 0!==d){var g;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,He[m.path]){case He.weights:g=de;break;case He.rotation:g=ue;break;case He.position:case He.scale:default:g=ce}var v=d.name?d.name:d.uuid,y=void 0!==f.interpolation?Ge[f.interpolation]:H,T=[];He[m.path]===He.weights?d.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&T.push(e.name?e.name:e.uuid)})):T.push(v);var x=p.array;if(p.normalized){var _;if(x.constructor===Int8Array)_=1/127;else if(x.constructor===Uint8Array)_=1/255;else if(x.constructor==Int16Array)_=1/32767;else{if(x.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");_=1/65535}for(var R=new Float32Array(x.length),w=0,b=x.length;w<b;w++)R[w]=x[w]*_;x=R}for(w=0,b=T.length;w<b;w++){var M=new g(T[w]+"."+He[m.path],h.array,x,y);"CUBICSPLINE"===f.interpolation&&(M.createInterpolant=function(e){return new Ae(this.times,this.values,this.getValueSize()/3,e)},M.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(M)}}}var A=t.name?t.name:"animation_"+e;return new G(A,void 0,l)}))},Ye.prototype.loadNode=function(e){var t,r=this.json,s=this.extensions,a=this,n=r.nodes[e],o=n.name?a.createUniqueName(n.name):"";return(t=[],void 0!==n.mesh&&t.push(a.getDependency("mesh",n.mesh).then((function(e){var t=a._getNodeRef(a.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=n.weights.length;t<r;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))),void 0!==n.camera&&t.push(a.getDependency("camera",n.camera).then((function(e){return a._getNodeRef(a.cameraCache,n.camera,e)}))),a._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var r;if((r=!0===n.isBone?new j:t.length>1?new k:1===t.length?t[0]:new B)!==t[0])for(var i=0,l=t.length;i<l;i++)r.add(t[i]);if(n.name&&(r.userData.name=n.name,r.name=o),ze(r,n),n.extensions&&Xe(s,r,n),void 0!==n.matrix){var c=new K;c.fromArray(n.matrix),r.applyMatrix4(c)}else void 0!==n.translation&&r.position.fromArray(n.translation),void 0!==n.rotation&&r.quaternion.fromArray(n.rotation),void 0!==n.scale&&r.scale.fromArray(n.scale);return a.associations.set(r,{type:"nodes",index:e}),r}))},Ye.prototype.loadScene=function(){function e(t,r,s,a){var n=s.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===n.skin?e:a.getDependency("skin",n.skin).then((function(e){for(var r=[],s=0,n=(t=e).joints.length;s<n;s++)r.push(a.getDependency("node",t.joints[s]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var s=[],a=[],n=0,o=r.length;n<o;n++){var i=r[n];if(i){s.push(i);var l=new K;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*n),a.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[n])}e.bind(new V(s,a),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var o=[];if(n.children)for(var i=n.children,l=0,c=i.length;l<c;l++){var u=i[l];o.push(e(u,t,s,a))}return Promise.all(o)}))}return function(t){var r=this.json,s=this.extensions,a=this.json.scenes[t],n=new k;a.name&&(n.name=this.createUniqueName(a.name)),ze(n,a),a.extensions&&Xe(s,n,a);for(var o=a.nodes||[],i=[],l=0,c=o.length;l<c;l++)i.push(e(o[l],n,r,this));return Promise.all(i).then((function(){return n}))}}(),e}();export{ve as D,ye as G,me as a,ge as s};
