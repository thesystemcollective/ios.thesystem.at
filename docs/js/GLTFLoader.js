import{a as e,S as t}from"./main.js";import{TextureLoader as s,MeshBasicMaterial as n,BackSide as o,BoxGeometry as r,Mesh as a,Loader as i,LoaderUtils as l,FileLoader as c,Color as u,SpotLight as p,PointLight as h,DirectionalLight as d,MeshStandardMaterial as m,TangentSpaceNormalMap as f,ImageBitmapLoader as g,InterleavedBuffer as y,BufferAttribute as T,LinearFilter as v,LinearMipmapLinearFilter as S,RepeatWrapping as M,RGBFormat as x,PointsMaterial as R,Material as _,LineBasicMaterial as b,DoubleSide as A,Vector2 as w,sRGBEncoding as E,BufferGeometry as L,SkinnedMesh as I,LineSegments as P,Line as O,LineLoop as C,Points as N,Group as U,PerspectiveCamera as H,Math as F,OrthographicCamera as D,InterpolateLinear as k,AnimationClip as G,Bone as j,Object3D as K,PropertyBinding as B,Matrix4 as V,Skeleton as X,MeshPhysicalMaterial as z,Interpolant as $,NearestFilter as W,NearestMipmapNearestFilter as q,LinearMipmapNearestFilter as Y,NearestMipmapLinearFilter as Z,ClampToEdgeWrapping as Q,MirroredRepeatWrapping as J,InterpolateDiscrete as ee,RGBAFormat as te,FrontSide as se,InterleavedBufferAttribute as ne,CanvasTexture as oe,TriangleFanDrawMode as re,TriangleStripDrawMode as ae,VectorKeyframeTrack as ie,QuaternionKeyframeTrack as le,NumberKeyframeTrack as ce,Box3 as ue,Vector3 as pe,Sphere as he}from"./three.module.js";const de=({data:t,scene:i})=>{const l=t.skybox||"default",c=`${e}${l}/`,u=new s,p=[new n({map:u.load(c+"px.jpg"),side:o}),new n({map:u.load(c+"nx.jpg"),side:o}),new n({map:u.load(c+"py.jpg"),side:o}),new n({map:u.load(c+"ny.jpg"),side:o}),new n({map:u.load(c+"pz.jpg"),side:o}),new n({map:u.load(c+"nz.jpg"),side:o})],h=new r(500,500,500,1,1,1),d=new a(h,p);return d.visible=!1,i.add(d),d},me=({camera:e,controller:s,model:n,reticle:o,scene:r,type:a,xrSupported:i})=>()=>{if(i){if(a===t.HIT)o.visible&&(n.position.setFromMatrixPosition(o.matrix),r.add(n));else if(a===t.FLOAT){const e=n.clone();e.position.set(0,0,-1).applyMatrix4(s.matrixWorld),e.quaternion.setFromRotationMatrix(s.matrixWorld),r.add(e)}}else e.position.set(0,0,5),s&&s.update(),r.add(n)},fe=function(){function e(e){i.call(this,e),this.dracoLoader=null,this.ddsLoader=null,this.pluginCallbacks=[],this.register((function(e){return new fe(e)}))}function t(){let e={};return{get:t=>e[t],add(t,s){e[t]=s},remove(t){delete e[t]},removeAll(){e={}}}}e.prototype=Object.assign(Object.create(i.prototype),{constructor:e,load:function(e,t,s,n){const o=this;let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:l.extractUrlBase(e),o.manager.itemStart(e);const a=t=>{n&&n(t),o.manager.itemError(e),o.manager.itemEnd(e)},i=new c(o.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),"use-credentials"===o.crossOrigin&&i.setWithCredentials(!0),i.load(e,(function(s){try{o.parse(s,r,(function(s){t(s),o.manager.itemEnd(e)}),a)}catch(e){a(e)}}),s,a)},setDRACOLoader(e){return this.dracoLoader=e,this},setDDSLoader(e){return this.ddsLoader=e,this},register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse(e,t,s,n){let a;const i={},c={};if("string"==typeof e)a=e;else{if(l.decodeText(new Uint8Array(e,0,4))===ge){try{i[o.KHR_BINARY_GLTF]=new ve(e)}catch(e){return void(n&&n(e))}a=i[o.KHR_BINARY_GLTF].content}else a=l.decodeText(new Uint8Array(e))}const u=JSON.parse(a);if(void 0===u.asset||u.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const p=new qe(u,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});p.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](p);c[t.name]=t,i[t.name]=!0}if(u.extensionsUsed)for(let e=0;e<u.extensionsUsed.length;++e){const t=u.extensionsUsed[e],s=u.extensionsRequired||[];switch(t){case o.KHR_LIGHTS_PUNCTUAL:i[t]=new de(u);break;case o.KHR_MATERIALS_UNLIT:i[t]=new me;break;case o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[t]=new Re;break;case o.KHR_DRACO_MESH_COMPRESSION:i[t]=new Se(u,this.dracoLoader);break;case o.MSFT_TEXTURE_DDS:i[t]=new r(this.ddsLoader);break;case o.KHR_TEXTURE_TRANSFORM:i[t]=new Me;break;case o.KHR_MESH_QUANTIZATION:i[t]=new _e;break;default:s.indexOf(t)>=0&&c[t]}}p.setExtensions(i),p.setPlugins(c),p.parse(s,n)}});const o={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function r(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=o.MSFT_TEXTURE_DDS,this.ddsLoader=e}function de(e){this.name=o.KHR_LIGHTS_PUNCTUAL;const t=e.extensions&&e.extensions[o.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function me(){this.name=o.KHR_MATERIALS_UNLIT}function fe(e){this.parser=e,this.name=o.KHR_MATERIALS_CLEARCOAT}de.prototype.loadLight=function(e){const t=this.lightDefs[e];let s;const n=new u(16777215);void 0!==t.color&&n.fromArray(t.color);const o=void 0!==t.range?t.range:0;switch(t.type){case"directional":s=new d(n),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new h(n),s.distance=o;break;case"spot":s=new p(n),s.distance=o,t.spot=t.spot||{},t.spot.innerConeAngle=void 0!==t.spot.innerConeAngle?t.spot.innerConeAngle:0,t.spot.outerConeAngle=void 0!==t.spot.outerConeAngle?t.spot.outerConeAngle:Math.PI/4,s.angle=t.spot.outerConeAngle,s.penumbra=1-t.spot.innerConeAngle/t.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+t.type+'".')}return s.position.set(0,0,0),s.decay=2,void 0!==t.intensity&&(s.intensity=t.intensity),s.name=t.name||"light_"+e,Promise.resolve(s)},me.prototype.getMaterialType=function(){return n},me.prototype.extendParams=function(e,t,s){const n=[];e.color=new u(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==o.baseColorTexture&&n.push(s.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(n)},fe.prototype.getMaterialType=function(){return z},fe.prototype.extendMaterialParams=function(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&o.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&o.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(o.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new w(e,e)}return Promise.all(o)};const ge="glTF",ye=1313821514,Te=5130562;function ve(e){this.name=o.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:l.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ge)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=new DataView(e,12);let n=0;for(;n<s.byteLength;){const t=s.getUint32(n,!0);n+=4;const o=s.getUint32(n,!0);if(n+=4,o===ye){const s=new Uint8Array(e,12+n,t);this.content=l.decodeText(s)}else if(o===Te){const s=12+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function Se(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=o.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function Me(){this.name=o.KHR_TEXTURE_TRANSFORM}function xe(e){m.call(this),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),a={specular:{value:(new u).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(let t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",t),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",s),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",o),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function Re(){return{name:o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return xe},extendParams:function(e,t,s){const n=t.extensions[this.name];e.color=new u(1,1,1),e.opacity=1;const o=[];if(Array.isArray(n.diffuseFactor)){const t=n.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==n.diffuseTexture&&o.push(s.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new u(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new u(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;o.push(s.assignTexture(e,"glossinessMap",t)),o.push(s.assignTexture(e,"specularMap",t))}return Promise.all(o)},createMaterial:function(e){const t=new xe(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=f,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function _e(){this.name=o.KHR_MESH_QUANTIZATION}function be(e,t,s,n){$.call(this,e,t,s,n)}Se.prototype.decodePrimitive=function(e,t){const s=this.json,n=this.dracoLoader,o=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},i={},l={};for(let e in r){const t=Fe[e]||e.toLowerCase();a[t]=r[e]}for(attributeName in e.attributes){const t=Fe[attributeName]||attributeName.toLowerCase();if(void 0!==r[attributeName]){const n=s.accessors[e.attributes[attributeName]],o=Ce[n.componentType];l[t]=o,i[t]=!0===n.normalized}}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(let t in e.attributes){const s=e.attributes[t],n=i[t];void 0!==n&&(s.normalized=n)}t(e)}),a,l)}))}))},Me.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),t.texCoord,e.needsUpdate=!0,e},xe.prototype=Object.create(m.prototype),xe.prototype.constructor=xe,xe.prototype.copy=function(e){return m.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},be.prototype=Object.create($.prototype),be.prototype.constructor=be,be.prototype.copySampleValue_=function(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,o=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[o+e];return t},be.prototype.beforeStart_=be.prototype.copySampleValue_,be.prototype.afterEnd_=be.prototype.copySampleValue_,be.prototype.interpolate_=function(e,t,s,n){const o=this.resultBuffer,r=this.sampleValues,a=this.valueSize,i=2*a,l=3*a,c=n-t,u=(s-t)/c,p=u*u,h=p*u,d=e*l,m=d-l,f=-2*h+3*p,g=h-p,y=1-f,T=g-p+u;for(let e=0;e!==a;e++){const t=r[m+e+a],s=r[m+e+i]*c,n=r[d+e+a],l=r[d+e]*c;o[e]=y*t+T*s+f*n+g*l}return o};const Ae=0,we=1,Ee=2,Le=3,Ie=4,Pe=5,Oe=6,Ce={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ne={9728:W,9729:v,9984:q,9985:Y,9986:Z,9987:S},Ue={33071:Q,33648:J,10497:M},He={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Fe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},De={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ke={CUBICSPLINE:void 0,LINEAR:k,STEP:ee},Ge="OPAQUE",je="MASK",Ke="BLEND",Be={"image/png":te,"image/jpeg":x};function Ve(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function Xe(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function ze(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function $e(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function We(e){const t=e.extensions&&e.extensions[o.KHR_DRACO_MESH_COMPRESSION];if(t){const{bufferView:e,indices:s,attributes:n}=t;return`draco:${e}:${s}:${n}`}{const{indices:t,attributes:s,mode:n}=e;return`${t}:${function(e){let t="";const s=Object.keys(e).sort();for(let n=0,o=s.length;n<o;n++)t+=s[n]+":"+e[s[n]]+";";return t}(s)}:${n}`}}function qe(e,n){this.json=e||{},this.extensions={},this.plugins={},this.options=n||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new g(this.options.manager):this.textureLoader=new s(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new c(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function Ye(e,t,s){const n=t.attributes,o=[],r=(t,n)=>s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}));for(let t in n){const s=Fe[t]||t.toLowerCase();s in e.attributes||o.push(r(n[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(n)}return ze(e,t),function(e,t,s){const n=t.attributes,o=new ue;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],{max:t,min:r}=e;if(void 0===r||void 0===t)return;o.set(new pe(r[0],r[1],r[2]),new pe(t[0],t[1],t[2]))}const r=t.targets;if(void 0!==r){const e=new pe,t=new pe;for(let n=0,o=r.length;n<o;n++){const o=r[n];if(void 0!==o.POSITION){const n=s.json.accessors[o.POSITION],{max:r,min:a}=n;void 0!==a&&void 0!==r&&(t.setX(Math.max(Math.abs(a[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(a[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(a[2]),Math.abs(r[2]))),e.max(t))}}o.expandByVector(e)}e.boundingBox=o;const a=new he;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(o).then(()=>void 0!==t.targets?function(e,t,s){let n=!1,o=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(o=!0),n&&o)break}if(!n&&!o)return Promise.resolve(e);const r=[],a=[];for(let i=0,l=t.length;i<l;i++){const l=t[i];if(n){const t=void 0!==l.POSITION?s.getDependency("accessor",l.POSITION):e.attributes.position;r.push(t)}if(o){const t=void 0!==l.NORMAL?s.getDependency("accessor",l.NORMAL):e.attributes.normal;a.push(t)}}return Promise.all([Promise.all(r),Promise.all(a)]).then((function(t){const s=t[0],r=t[1];return n&&(e.morphAttributes.position=s),o&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e)}function Ze(e,t){const s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,o=[];if(t===re)for(let e=1;e<=n;e++)o.push(s.getX(0)),o.push(s.getX(e)),o.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(o.push(s.getX(e)),o.push(s.getX(e+1)),o.push(s.getX(e+2))):(o.push(s.getX(e+2)),o.push(s.getX(e+1)),o.push(s.getX(e)));const r=e.clone();return r.setIndex(o),r}return qe.prototype.setExtensions=function(e){this.extensions=e},qe.prototype.setPlugins=function(e){this.plugins=e},qe.prototype.parse=function(e,t){const s=this,{extensions:n,json:o}=this;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){const r={scene:t[0][o.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:o.asset,parser:s,userData:{}};Xe(n,r,o),ze(r,o),e(r)})).catch(t)},qe.prototype.markDefs=function(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],n={},o={};for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(void 0===n[r.mesh]&&(n[r.mesh]=o[r.mesh]=0),n[r.mesh]++,void 0!==r.skin&&(s[r.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=o},qe.prototype._invokeOne=function(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}},qe.prototype._invokeAll=function(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++)s.push(e(t[n]));return Promise.all(s)},qe.prototype.getDependency=function(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this.loadTexture(t);break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;case"light":n=this.extensions[o.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n},qe.prototype.getDependencies=function(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((t,n)=>s.getDependency(e,n))),this.cache.add(e,t)}return t},qe.prototype.loadBuffer=function(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[o.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,o){s.load(Ve(t.uri,n.path),e,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},qe.prototype.loadBufferView=function(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const{byteLength:s=0,byteOffset:n=0}=t;return e.slice(n,n+s)}))},qe.prototype.loadAccessor=function(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],r=He[n.type],a=Ce[n.componentType],i=a.BYTES_PER_ELEMENT,l=i*r,c=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;let h,d;if(u&&u!==l){const e=Math.floor(c/u),{bufferView:s,componentType:o,count:l}=n,m=`InterleavedBuffer:${s}:${o}:${e}:${l}`,f=t.cache.get(m);f||(h=new a(s,e*u,n.count*u/i),f=new y(h,u/i),t.cache.add(m,f)),d=new ne(f,r,c%u/i,p)}else h=null===o?new a(n.count*r):new a(o,c,n.count*r),d=new T(h,r,p);if(void 0!==n.sparse){const t=He.SCALAR,s=Ce[n.sparse.indices.componentType],i=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],i,n.sparse.count*t),u=new a(e[2],l,n.sparse.count*r);null!==o&&(d=new T(d.array.slice(),d.itemSize,d.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(d.setX(t,u[e*r]),r>=2&&d.setY(t,u[e*r+1]),r>=3&&d.setZ(t,u[e*r+2]),r>=4&&d.setW(t,u[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return d}))},qe.prototype.loadTexture=function(e){const t=this,{json:s,options:n,textureLoader:r}=this,a=self.URL||self.webkitURL,i=s.textures[e],l=i.extensions||{};let c;c=l[o.MSFT_TEXTURE_DDS]?s.images[l[o.MSFT_TEXTURE_DDS].source]:s.images[i.source];let u=c.uri,p=!1;return void 0!==c.bufferView&&(u=t.getDependency("bufferView",c.bufferView).then((function(e){p=!0;const t=new Blob([e],{type:c.mimeType});return u=a.createObjectURL(t),u}))),Promise.resolve(u).then((function(e){let s=n.manager.getHandler(e);return s||(s=l[o.MSFT_TEXTURE_DDS]?t.extensions[o.MSFT_TEXTURE_DDS].ddsLoader:r),new Promise((function(t,o){let r=t;!0===s.isImageBitmapLoader&&(r=e=>t(new oe(e))),s.load(Ve(e,n.path),r,void 0,o)}))})).then((function(n){!0===p&&a.revokeObjectURL(u),n.flipY=!1,i.name&&(n.name=i.name),c.mimeType in Be&&(n.format=Be[c.mimeType]);const o=(s.samplers||{})[i.sampler]||{};return n.magFilter=Ne[o.magFilter]||v,n.minFilter=Ne[o.minFilter]||S,n.wrapS=Ue[o.wrapS]||M,n.wrapT=Ue[o.wrapT]||M,t.associations.set(n,{type:"textures",index:e}),n}))},qe.prototype.assignTexture=function(e,t,s){const n=this;return this.getDependency("texture",s.index).then((function(r){if(!r.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":r.format=x}if(void 0!==s.texCoord&&0!=s.texCoord&&("aoMap"!==t||s.texCoord),n.extensions[o.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[o.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(r);r=n.extensions[o.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),n.associations.set(r,t)}}e[t]=r}))},qe.prototype.assignFinalMaterial=function(e){const t=e.geometry;let s=e.material;const n=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,r=void 0===t.attributes.normal,a=!0===e.isSkinnedMesh,i=Object.keys(t.morphAttributes).length>0,l=i&&void 0!==t.morphAttributes.normal;if(e.isPoints){let e="PointsMaterial:"+s.uuid;const t=this.cache.get(e);t||(t=new R,_.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid,t=this.cache.get(e);t||(t=new b,_.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(n||o||r||a||i){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),a&&(e+="skinning:"),n&&(e+="vertex-tangents:"),o&&(e+="vertex-colors:"),r&&(e+="flat-shading:"),i&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=s.clone(),a&&(t.skinning=!0),n&&(t.vertexTangents=!0),o&&(t.vertexColors=!0),r&&(t.flatShading=!0),i&&(t.morphTargets=!0),l&&(t.morphNormals=!0),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),s.normalScale&&!n&&(s.normalScale.y=-s.normalScale.y),s.clearcoatNormalScale&&!n&&(s.clearcoatNormalScale.y=-s.clearcoatNormalScale.y),e.material=s},qe.prototype.getMaterialType=function(){return m},qe.prototype.loadMaterial=function(e){const t=this,{extensions:s,json:r}=this,a=r.materials[e];let i;const l={},c=a.extensions||{},p=[];if(c[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=s[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=e.getMaterialType(),p.push(e.extendParams(l,a,t))}else if(c[o.KHR_MATERIALS_UNLIT]){const e=s[o.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),p.push(e.extendParams(l,a,t))}else{const s=a.pbrMetallicRoughness||{};if(l.color=new u(1,1,1),l.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;l.color.fromArray(e),l.opacity=e[3]}void 0!==s.baseColorTexture&&p.push(t.assignTexture(l,"map",s.baseColorTexture)),l.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,l.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(p.push(t.assignTexture(l,"metalnessMap",s.metallicRoughnessTexture)),p.push(t.assignTexture(l,"roughnessMap",s.metallicRoughnessTexture))),i=this._invokeOne(t=>t.getMaterialType&&t.getMaterialType(e)),p.push(this._invokeAll(t=>t.extendMaterialParams&&t.extendMaterialParams(e,l)))}!0===a.doubleSided&&(l.side=A);const h=a.alphaMode||Ge;return h===Ke?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,h===je&&(l.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&i!==n&&(p.push(t.assignTexture(l,"normalMap",a.normalTexture)),l.normalScale=new w(1,1),void 0!==a.normalTexture.scale&&l.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&i!==n&&(p.push(t.assignTexture(l,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(l.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&i!==n&&(l.emissive=(new u).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&i!==n&&p.push(t.assignTexture(l,"emissiveMap",a.emissiveTexture)),Promise.all(p).then((function(){let n;return n=i===xe?s[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new i(l),a.name&&(n.name=a.name),n.map&&(n.map.encoding=E),n.emissiveMap&&(n.emissiveMap.encoding=E),ze(n,a),t.associations.set(n,{type:"materials",index:e}),a.extensions&&Xe(s,n,a),n}))},qe.prototype.loadGeometries=function(e){const t=this,s=this.extensions,n=this.primitiveCache,r=e=>s[o.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(s=>Ye(s,e,t)),a=[];for(let s=0,i=e.length;s<i;s++){const i=e[s],l=We(i),c=n[l];if(c)a.push(c.promise);else{let e;e=i.extensions&&i.extensions[o.KHR_DRACO_MESH_COMPRESSION]?r(i):Ye(new L,i,t),n[l]={primitive:i,promise:e},a.push(e)}}return Promise.all(a)},qe.prototype.loadMesh=function(e){const t=this,{json:s}=this,n=s.meshes[e],o=n.primitives,r=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(i=this.cache).DefaultMaterial&&(i.DefaultMaterial=new m({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:se})),i.DefaultMaterial):this.getDependency("material",o[e].material);r.push(t)}var i;return r.push(t.loadGeometries(o)),Promise.all(r).then((function(s){const r=s.slice(0,s.length-1),i=s[s.length-1],l=[];for(let s=0,c=i.length;s<c;s++){const c=i[s],u=o[s];let p;const h=r[s];if(u.mode===Ie||u.mode===Pe||u.mode===Oe||void 0===u.mode)p=!0===n.isSkinnedMesh?new I(c,h):new a(c,h),!0!==p.isSkinnedMesh||p.geometry.attributes.skinWeight.normalized||p.normalizeSkinWeights(),u.mode===Pe?p.geometry=Ze(p.geometry,ae):u.mode===Oe&&(p.geometry=Ze(p.geometry,re));else if(u.mode===we)p=new P(c,h);else if(u.mode===Le)p=new O(c,h);else if(u.mode===Ee)p=new C(c,h);else{if(u.mode!==Ae)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);p=new N(c,h)}Object.keys(p.geometry.morphAttributes).length>0&&$e(p,n),p.name=n.name||"mesh_"+e,i.length>1&&(p.name+="_"+s),ze(p,n),t.assignFinalMaterial(p),l.push(p)}if(1===l.length)return l[0];const c=new U;for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))},qe.prototype.loadCamera=function(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new H(F.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new D(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=s.name),ze(t,s),Promise.resolve(t)},qe.prototype.loadSkin=function(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))},qe.prototype.loadAnimation=function(e){const t=this.json.animations[e],s=[],n=[],o=[],r=[],a=[];for(let e=0,i=t.channels.length;e<i;e++){const i=t.channels[e],l=t.samplers[i.sampler],c=i.target,u=void 0!==c.node?c.node:c.id,p=void 0!==t.parameters?t.parameters[l.input]:l.input,h=void 0!==t.parameters?t.parameters[l.output]:l.output;s.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",p)),o.push(this.getDependency("accessor",h)),r.push(l),a.push(c)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(o),Promise.all(r),Promise.all(a)]).then((function(s){const n=s[0],o=s[1],r=s[2],a=s[3],i=s[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=o[e],c=r[e],u=a[e],p=i[e];if(void 0===t)continue;let h;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,De[p.path]){case De.weights:h=ce;break;case De.rotation:h=le;break;case De.position:case De.scale:default:h=ie}const d=t.name?t.name:t.uuid,m=void 0!==u.interpolation?ke[u.interpolation]:k,f=[];De[p.path]===De.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&f.push(e.name?e.name:e.uuid)})):f.push(d);const g=c.array;if(c.normalized){let e;if(g.constructor===Int8Array)e=1/127;else if(g.constructor===Uint8Array)e=1/255;else if(g.constructor==Int16Array)e=1/32767;else{if(g.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");e=1/65535}const t=new Float32Array(g.length);for(let s=0,n=g.length;s<n;s++)t[s]=g[s]*e;g=t}for(let e=0,t=f.length;e<t;e++){const t=new h(f[e]+"."+De[p.path],s.array,g,m);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new be(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new G(c,void 0,l)}))},qe.prototype.loadNode=function(e){const{extensions:t,json:s}=this,n=this,r=s.meshReferences,a=s.meshUses,i=s.nodes[e];return function(){const e=[];return void 0!==i.mesh&&e.push(n.getDependency("mesh",i.mesh).then((function(e){let t;if(r[i.mesh]>1){const s=a[i.mesh]++;t=e.clone(),t.name+="_instance_"+s}else t=e;return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))),void 0!==i.camera&&e.push(n.getDependency("camera",i.camera)),i.extensions&&i.extensions[o.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[o.KHR_LIGHTS_PUNCTUAL].light&&e.push(n.getDependency("light",i.extensions[o.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(e)}().then((function(s){let o;if(o=!0===i.isBone?new j:s.length>1?new U:1===s.length?s[0]:new K,o!==s[0])for(let e=0,t=s.length;e<t;e++)o.add(s[e]);if(i.name&&(o.userData.name=i.name,o.name=B.sanitizeNodeName(i.name)),ze(o,i),i.extensions&&Xe(t,o,i),void 0!==i.matrix){const e=new V;e.fromArray(i.matrix),o.applyMatrix4(e)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return n.associations.set(o,{type:"nodes",index:e}),o}))},qe.prototype.loadScene=function(){function e(t,s,n,o){const r=n.nodes[t];return o.getDependency("node",t).then((function(e){if(void 0===r.skin)return e;let t;return o.getDependency("skin",r.skin).then((function(e){t=e;const s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(o.getDependency("node",t.joints[e]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const n=[],o=[];for(let e=0,r=s.length;e<r;e++){const r=s[e];if(r){n.push(r);const s=new V;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*e),o.push(s)}}e.bind(new X(n,o),e.matrixWorld)})),e}))})).then((function(t){s.add(t);const a=[];if(r.children){const s=r.children;for(let r=0,i=s.length;r<i;r++){const i=s[r];a.push(e(i,t,n,o))}}return Promise.all(a)}))}return function(t){const{extensions:s,json:n}=this,o=n.scenes[t],r=this,a=new U;o.name&&(a.name=o.name),ze(a,o),o.extensions&&Xe(s,a,o);const i=o.nodes||[],l=[];for(let t=0,s=i.length;t<s;t++)l.push(e(i[t],a,n,r));return Promise.all(l).then((function(){return a}))}}(),e}();export{fe as G,de as a,me as s};
