import{p as e,g as t}from"./main.js";import{G as a,A as n,O as r,T as i,R as s,S as o,a as l,b as u,B as c,F as p,C as d,c as f,M as h,d as m,e as g,f as E,g as M,h as _,i as T,P as b,j as S,E as x,k as v,W as R,l as w,m as L,n as P,U as F,o as C,N,p as U,q as y,r as D,s as I,t as O,u as B,v as W,L as X,w as H,x as k,V,y as j,z,D as Y,H as q,I as K,J as Z,K as J,Q,X as $,Y as ee,Z as te,_ as ae,$ as ne,a0 as re,a1 as ie,a2 as se,a3 as oe,a4 as le,a5 as ue,a6 as ce,a7 as pe,a8 as de,a9 as fe,aa as he,ab as me,ac as ge,ad as Ee,ae as Me,af as _e,ag as Te,ah as be,ai as Se,aj as xe,ak as ve,al as Ae,am as Re,an as we,ao as Le,ap as Pe,aq as Fe,ar as Ce,as as Ne,at as Ue,au as ye,av as De,aw as Ie,ax as Oe,ay as Be,az as Ge,aA as We,aB as Xe,aC as He,aD as ke,aE as Ve,aF as je,aG as ze,aH as Ye,aI as qe,aJ as Ke,aK as Ze,aL as Je,aM as Qe,aN as $e,aO as et,aP as tt,aQ as at,aR as nt,aS as rt,aT as it,aU as st,aV as ot,aW as lt,aX as ut,aY as ct,aZ as pt,a_ as dt,a$ as ft,b0 as ht,b1 as mt,b2 as gt,b3 as Et,b4 as Mt,b5 as _t,b6 as Tt,b7 as bt,b8 as St,b9 as xt,ba as vt,bb as At,bc as Rt,bd as wt,be as Lt,bf as Pt,bg as Ft,bh as Ct,bi as Nt,bj as Ut,bk as yt,bl as Dt,bm as It,bn as Ot,bo as Bt,bp as Gt,bq as Wt,br as Xt,bs as Ht,bt as kt,bu as Vt,bv as jt,bw as zt,bx as Yt,by as qt,bz as Kt,bA as Zt,bB as Jt,bC as Qt,bD as $t,bE as ea,bF as ta,bG as aa,bH as na,bI as ra,bJ as ia,bK as sa,bL as oa,bM as la,bN as ua,bO as ca,bP as pa,bQ as da,bR as fa,bS as ha,bT as ma,bU as ga,bV as Ea,bW as Ma,bX as _a,bY as Ta}from"./HemisphereLight.js";export{A as AnimationMixer,G as GLTFLoader,b$ as HemisphereLight,b_ as PerspectiveCamera,bZ as spawnModel}from"./HemisphereLight.js";const ba=({camera:e,hud:t,renderer:a})=>()=>{e.aspect=window.innerWidth/window.innerHeight,e.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),t.onWindowResize()};let Sa=null,xa=!1;const va=e=>async(t,a)=>{const{camera:n,clock:r,hud:i,mixer:s,renderer:o,reticle:l,scene:u,stats:c}=e;if(a){const e=o.xr.getSession();if(!1===xa){const t=await e.requestReferenceSpace("viewer"),a=await e.requestHitTestSource({space:t});Sa=a,e.addEventListener("end",()=>{xa=!1,Sa=null}),xa=!0}if(Sa){const e=o.xr.getReferenceSpace(),t=a.getHitTestResults(Sa);if(t.length){if(l){const a=t[0];l.visible=!0,l.matrix.fromArray(a.getPose(e).transform.matrix)}}else l&&(l.visible=!1)}}s&&s.update(r.getDelta()),i.render(o),o.render(u,n)},Aa=async()=>{const[{MeshBasicMaterial:e},{Mesh:t},{RingBufferGeometry:a}]=await Promise.all([import("./HemisphereLight.js").then((function(e){return e.c5})),import("./HemisphereLight.js").then((function(e){return e.c6})),import("./RingGeometry.js")]),n=new t(new a(.15,.2,32).rotateX(-Math.PI/2),new e);return n.matrixAutoUpdate=!1,n.visible=!1,n},Ra=async(r,i)=>{if(!r)throw new Error("loadModel needs { file } argument to be set.");i.show(e);const s=await((e,a,n)=>new Promise((r,i)=>{const s=`${t}/${a}`,o=(e=>t=>{if(t.total>0){const a=Math.ceil(t.loaded/t.total*100);e.setContent(`${a}% ${t.loaded}/${t.total}`)}t.loaded>=t.total&&e.hide()})(n);e.load(s,r,o,i)}))(new a,r,i),o=s.scene;let l=null;return s.animations&&s.animations.length&&(l=new n(o),s.animations.forEach(e=>l.clipAction(e).play())),{model:o,mixer:l}},wa=async({camera:e,hemisphereLight:t,scene:a})=>{const{CameraHelper:n}=await import("./CameraHelper.js"),{default:r}=await import("./stats.module.js"),i=new n(e);if(a.add(i),t){const{HemisphereLightHelper:e}=await import("./HemisphereLightHelper.js"),n=new e(t);a.add(n)}const s=new r;return document.body.appendChild(s.dom),s};class La{constructor(e){const t=window.innerWidth/2,a=window.innerHeight/2;this.camera=new r(-t,t,a,-a,1,10),this.camera.position.z=10,this.scene=e,this.scene.add(this.camera);(new i).load("textures/exitbutton.jpg",this.create.bind(this)),this.raycaster=new s}clickListener(e){const t=e.clientX/window.innerWidth*2-1,a=-e.clientY/window.innerHeight*2+1;this.raycaster.setFromCamera({x:t,y:a},this.camera);const n=this.raycaster.intersectObjects([this.exitButton],!0);if(n.length>0){n[0]}}render(e){e.clearDepth(),e.render(this.scene,this.camera)}createSprite({material:e,center:t=[0,1],height:a=76,width:n=76}){const r=new o(e);return r.center.set(...t),r.scale.set(n,a,1),this.scene.add(r),document.body.addEventListener("click",this.clickListener.bind(this)),r}create(e){const t=new l({map:e});this.exitButton=this.createSprite({material:t,center:[0,1]}),this.update()}onWindowResize(){const e=window.innerWidth/2,t=window.innerHeight/2;this.camera.left=-e,this.camera.right=e,this.camera.top=t,this.camera.bottom=-t,this.camera.updateProjectionMatrix(),this.update()}update(){const e=window.innerWidth/2,t=window.innerHeight/2;this.exitButton.position.set(e,-t,1)}}class Pa{constructor(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}class Fa extends u{constructor(){super(),Object.defineProperty(this,"isScene",{value:!0}),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.environment&&(t.object.environment=this.environment.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}function Ca(e,t){const a=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const a=n.get(t);a&&(e.deleteBuffer(a.buffer),n.delete(t))},update:function(t,r){if(t.isGLBufferAttribute){var i=n.get(t);return void((!i||i.version<t.version)&&n.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const s=n.get(t);void 0===s?n.set(t,function(t,a){const n=t.array,r=t.usage,i=e.createBuffer();e.bindBuffer(a,i),e.bufferData(a,n,r),t.onUploadCallback();let s=e.FLOAT;return n instanceof Float32Array?s=e.FLOAT:n instanceof Float64Array||(n instanceof Uint16Array?s=e.UNSIGNED_SHORT:n instanceof Int16Array?s=e.SHORT:n instanceof Uint32Array?s=e.UNSIGNED_INT:n instanceof Int32Array?s=e.INT:n instanceof Int8Array?s=e.BYTE:n instanceof Uint8Array&&(s=e.UNSIGNED_BYTE)),{buffer:i,type:s,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version}}(t,r)):s.version<t.version&&(!function(t,n,r){const i=n.array,s=n.updateRange;e.bindBuffer(r,t),-1===s.count?e.bufferSubData(r,0,i):(a?e.bufferSubData(r,s.offset*i.BYTES_PER_ELEMENT,i,s.offset,s.count):e.bufferSubData(r,s.offset*i.BYTES_PER_ELEMENT,i.subarray(s.offset,s.offset+s.count)),s.count=-1)}(s.buffer,t,r),s.version=t.version)}}}class Na extends c{constructor(e,t,a,n){super(),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:a,heightSegments:n};const r=(e=e||1)/2,i=(t=t||1)/2,s=Math.floor(a)||1,o=Math.floor(n)||1,l=s+1,u=o+1,c=e/s,d=t/o,f=[],h=[],m=[],g=[];for(let e=0;e<u;e++){const t=e*d-i;for(let a=0;a<l;a++){const n=a*c-r;h.push(n,-t,0),m.push(0,0,1),g.push(a/s),g.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<s;t++){const a=t+l*e,n=t+l*(e+1),r=t+1+l*(e+1),i=t+1+l*e;f.push(a,n,i),f.push(n,r,i)}this.setIndex(f),this.setAttribute("position",new p(h,3)),this.setAttribute("normal",new p(m,3)),this.setAttribute("uv",new p(g,2))}}function Ua(e,t,a,n,r){const i=new d(0);let s,o,l=0,u=null,c=0,p=null;function b(e,t){a.buffers.color.setClear(e.r,e.g,e.b,t,r)}return{getClearColor:function(){return i},setClearColor:function(e,t){i.set(e),l=void 0!==t?t:1,b(i,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,b(i,l)},render:function(a,r,d,S){let x=!0===r.isScene?r.background:null;x&&x.isTexture&&(x=t.get(x));const v=e.xr,A=v.getSession&&v.getSession();A&&"additive"===A.environmentBlendMode&&(x=null),null===x?b(i,l):x&&x.isColor&&(b(x,1),S=!0),(e.autoClear||S)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),x&&(x.isCubeTexture||x.isWebGLCubeRenderTarget||x.isWebGLCubeRenderTargetTexture||x.mapping===f)?(void 0===o&&(o=new h(new m(1,1,1),new g({name:"BackgroundCubeMaterial",uniforms:E(M.cube.uniforms),vertexShader:M.cube.vertexShader,fragmentShader:M.cube.fragmentShader,side:_,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(e,t,a){this.matrixWorld.copyPosition(a.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(o)),x.isWebGLCubeRenderTarget&&(x=x.texture),o.material.uniforms.envMap.value=x,o.material.uniforms.flipEnvMap.value=x.isCubeTexture?-1:1,u===x&&c===x.version&&p===e.toneMapping||(o.material.needsUpdate=!0,u=x,c=x.version,p=e.toneMapping),a.unshift(o,o.geometry,o.material,0,0,null)):x&&x.isTexture&&(void 0===s&&(s=new h(new Na(2,2),new g({name:"BackgroundMaterial",uniforms:E(M.background.uniforms),vertexShader:M.background.vertexShader,fragmentShader:M.background.fragmentShader,side:T,depthTest:!1,depthWrite:!1,fog:!1})),s.geometry.deleteAttribute("normal"),Object.defineProperty(s.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(s)),s.material.uniforms.t2D.value=x,!0===x.matrixAutoUpdate&&x.updateMatrix(),s.material.uniforms.uvTransform.value.copy(x.matrix),u===x&&c===x.version&&p===e.toneMapping||(s.material.needsUpdate=!0,u=x,c=x.version,p=e.toneMapping),a.unshift(s,s.geometry,s.material,0,0,null))}}}function ya(e,t,a,n){const r=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=n.isWebGL2?null:t.get("OES_vertex_array_object"),s=n.isWebGL2||null!==i,o={},l=d(null);let u=l;function c(t){return n.isWebGL2?e.bindVertexArray(t):i.bindVertexArrayOES(t)}function p(t){return n.isWebGL2?e.deleteVertexArray(t):i.deleteVertexArrayOES(t)}function d(e){const t=[],a=[],n=[];for(let e=0;e<r;e++)t[e]=0,a[e]=0,n[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:a,attributeDivisors:n,object:e,attributes:{},index:null}}function f(){const e=u.newAttributes;for(let t=0,a=e.length;t<a;t++)e[t]=0}function h(e){m(e,0)}function m(a,r){const i=u.newAttributes,s=u.enabledAttributes,o=u.attributeDivisors;if(i[a]=1,0===s[a]&&(e.enableVertexAttribArray(a),s[a]=1),o[a]!==r){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](a,r),o[a]=r}}function g(){const t=u.newAttributes,a=u.enabledAttributes;for(let n=0,r=a.length;n<r;n++)a[n]!==t[n]&&(e.disableVertexAttribArray(n),a[n]=0)}function E(t,a,r,i,s,o){!0!==n.isWebGL2||r!==e.INT&&r!==e.UNSIGNED_INT?e.vertexAttribPointer(t,a,r,i,s,o):e.vertexAttribIPointer(t,a,r,s,o)}function M(){_(),u!==l&&(u=l,c(u.object))}function _(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,p,M,_){let T=!1;if(s){const t=function(t,a,r){const s=!0===r.wireframe;let l=o[t.id];void 0===l&&(l={},o[t.id]=l);let u=l[a.id];void 0===u&&(u={},l[a.id]=u);let c=u[s];void 0===c&&(c=d(n.isWebGL2?e.createVertexArray():i.createVertexArrayOES()),u[s]=c);return c}(M,p,l);u!==t&&(u=t,c(u.object)),T=function(e,t){const a=u.attributes,n=e.attributes;if(Object.keys(a).length!==Object.keys(n).length)return!0;for(const e in n){const t=a[e],r=n[e];if(void 0===t)return!0;if(t.attribute!==r)return!0;if(t.data!==r.data)return!0}return u.index!==t}(M,_),T&&function(e,t){const a={},n=e.attributes;for(const e in n){const t=n[e],r={};r.attribute=t,t.data&&(r.data=t.data),a[e]=r}u.attributes=a,u.index=t}(M,_)}else{const e=!0===l.wireframe;u.geometry===M.id&&u.program===p.id&&u.wireframe===e||(u.geometry=M.id,u.program=p.id,u.wireframe=e,T=!0)}!0===r.isInstancedMesh&&(T=!0),null!==_&&a.update(_,e.ELEMENT_ARRAY_BUFFER),T&&(!function(r,i,s,o){if(!1===n.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;f();const l=o.attributes,u=s.getAttributes(),c=i.defaultAttributeValues;for(const t in u){const n=u[t];if(n>=0){const i=l[t];if(void 0!==i){const t=i.normalized,r=i.itemSize,s=a.get(i);if(void 0===s)continue;const l=s.buffer,u=s.type,c=s.bytesPerElement;if(i.isInterleavedBufferAttribute){const a=i.data,s=a.stride,p=i.offset;a&&a.isInstancedInterleavedBuffer?(m(n,a.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=a.meshPerAttribute*a.count)):h(n),e.bindBuffer(e.ARRAY_BUFFER,l),E(n,r,u,t,s*c,p*c)}else i.isInstancedBufferAttribute?(m(n,i.meshPerAttribute),void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)):h(n),e.bindBuffer(e.ARRAY_BUFFER,l),E(n,r,u,t,0,0)}else if("instanceMatrix"===t){const t=a.get(r.instanceMatrix);if(void 0===t)continue;const i=t.buffer,s=t.type;m(n+0,1),m(n+1,1),m(n+2,1),m(n+3,1),e.bindBuffer(e.ARRAY_BUFFER,i),e.vertexAttribPointer(n+0,4,s,!1,64,0),e.vertexAttribPointer(n+1,4,s,!1,64,16),e.vertexAttribPointer(n+2,4,s,!1,64,32),e.vertexAttribPointer(n+3,4,s,!1,64,48)}else if("instanceColor"===t){const t=a.get(r.instanceColor);if(void 0===t)continue;const i=t.buffer,s=t.type;m(n,1),e.bindBuffer(e.ARRAY_BUFFER,i),e.vertexAttribPointer(n,3,s,!1,12,0)}else if(void 0!==c){const a=c[t];if(void 0!==a)switch(a.length){case 2:e.vertexAttrib2fv(n,a);break;case 3:e.vertexAttrib3fv(n,a);break;case 4:e.vertexAttrib4fv(n,a);break;default:e.vertexAttrib1fv(n,a)}}}}g()}(r,l,p,M),null!==_&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.get(_).buffer))},reset:M,resetDefaultState:_,dispose:function(){M();for(const e in o){const t=o[e];for(const e in t){const a=t[e];for(const e in a)p(a[e].object),delete a[e];delete t[e]}delete o[e]}},releaseStatesOfGeometry:function(e){if(void 0===o[e.id])return;const t=o[e.id];for(const e in t){const a=t[e];for(const e in a)p(a[e].object),delete a[e];delete t[e]}delete o[e.id]},releaseStatesOfProgram:function(e){for(const t in o){const a=o[t];if(void 0===a[e.id])continue;const n=a[e.id];for(const e in n)p(n[e].object),delete n[e];delete a[e.id]}},initAttributes:f,enableAttribute:h,disableUnusedAttributes:g}}function Da(e,t,a,n){const r=n.isWebGL2;let i;this.setMode=function(e){i=e},this.render=function(t,n){e.drawArrays(i,t,n),a.update(n,i,1)},this.renderInstances=function(n,s,o){if(0===o)return;let l,u;if(r)l=e,u="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),u="drawArraysInstancedANGLE",null===l)return;l[u](i,n,s,o),a.update(s,i,o)}}function Ia(e,t,a){let n;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const i="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&e instanceof WebGL2ComputeRenderingContext;let s=void 0!==a.precision?a.precision:"highp";const o=r(s);o!==s&&(s=o);const l=!0===a.logarithmicDepthBuffer,u=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),c=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),p=e.getParameter(e.MAX_TEXTURE_SIZE),d=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),f=e.getParameter(e.MAX_VERTEX_ATTRIBS),h=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),m=e.getParameter(e.MAX_VARYING_VECTORS),g=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),E=c>0,M=i||!!t.get("OES_texture_float");return{isWebGL2:i,getMaxAnisotropy:function(){if(void 0!==n)return n;const a=t.get("EXT_texture_filter_anisotropic");return n=null!==a?e.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,n},getMaxPrecision:r,precision:s,logarithmicDepthBuffer:l,maxTextures:u,maxVertexTextures:c,maxTextureSize:p,maxCubemapSize:d,maxAttributes:f,maxVertexUniforms:h,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:E,floatFragmentTextures:M,floatVertexTextures:E&&M,maxSamples:i?e.getParameter(e.MAX_SAMPLES):0}}function Oa(e){const t=this;let a=null,n=0,r=!1,i=!1;const s=new b,o=new S,l={value:null,needsUpdate:!1};function u(){l.value!==a&&(l.value=a,l.needsUpdate=n>0),t.numPlanes=n,t.numIntersection=0}function c(e,a,n,r){const i=null!==e?e.length:0;let u=null;if(0!==i){if(u=l.value,!0!==r||null===u){const t=n+4*i,r=a.matrixWorldInverse;o.getNormalMatrix(r),(null===u||u.length<t)&&(u=new Float32Array(t));for(let t=0,a=n;t!==i;++t,a+=4)s.copy(e[t]).applyMatrix4(r,o),s.normal.toArray(u,a),u[a+3]=s.constant}l.value=u,l.needsUpdate=!0}return t.numPlanes=i,t.numIntersection=0,u}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t,i){const s=0!==e.length||t||0!==n||r;return r=t,a=c(e,i,0),n=e.length,s},this.beginShadows=function(){i=!0,c(null)},this.endShadows=function(){i=!1,u()},this.setState=function(t,s,o){const p=t.clippingPlanes,d=t.clipIntersection,f=t.clipShadows,h=e.get(t);if(!r||null===p||0===p.length||i&&!f)i?c(null):u();else{const e=i?0:n,t=4*e;let r=h.clippingState||null;l.value=r,r=c(p,s,t,o);for(let e=0;e!==t;++e)r[e]=a[e];h.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function Ba(e){let t=new WeakMap;function a(e,t){return t===x?e.mapping=w:t===v&&(e.mapping=L),e}return{get:function(n){if(n&&n.isTexture){const r=n.mapping;if(r===x||r===v){if(t.has(n)){return a(t.get(n).texture,n.mapping)}{const r=n.image;if(r&&r.height>0){const i=e.getRenderList(),s=e.getRenderTarget(),o=e.getRenderState(),l=new R(r.height/2);return l.fromEquirectangularTexture(e,n),t.set(n,l),e.setRenderTarget(s),e.setRenderList(i),e.setRenderState(o),a(l.texture,n.mapping)}return null}}}return n},dispose:function(){t=new WeakMap}}}function Ga(e){const t={};return{has:function(a){if(void 0!==t[a])return null!==t[a];let n;switch(a){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(a)}return t[a]=n,null!==n},get:function(e){return this.has(e),t[e]}}}function Wa(e,t,a,n){const r=new WeakMap,i=new WeakMap;function s(e){const o=e.target,l=r.get(o);null!==l.index&&t.remove(l.index);for(const e in l.attributes)t.remove(l.attributes[e]);o.removeEventListener("dispose",s),r.delete(o);const u=i.get(l);u&&(t.remove(u),i.delete(l)),n.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,a.memory.geometries--}function o(e){const a=[],n=e.index,r=e.attributes.position;let s=0;if(null!==n){const e=n.array;s=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],r=e[t+1],i=e[t+2];a.push(n,r,r,i,i,n)}}else{const e=r.array;s=r.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,r=t+2;a.push(e,n,n,r,r,e)}}const o=new(P(a)>65535?F:C)(a,1);o.version=s;const l=i.get(e);l&&t.remove(l),i.set(e,o)}return{get:function(e,t){let n=r.get(t);return n||(t.addEventListener("dispose",s),t.isBufferGeometry?n=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new c).setFromObject(e)),n=t._bufferGeometry),r.set(t,n),a.memory.geometries++,n)},update:function(a){const n=a.attributes;for(const a in n)t.update(n[a],e.ARRAY_BUFFER);const r=a.morphAttributes;for(const a in r){const n=r[a];for(let a=0,r=n.length;a<r;a++)t.update(n[a],e.ARRAY_BUFFER)}},getWireframeAttribute:function(e){const t=i.get(e);if(t){const a=e.index;null!==a&&t.version<a.version&&o(e)}else o(e);return i.get(e)}}}function Xa(e,t,a,n){const r=n.isWebGL2;let i,s,o;this.setMode=function(e){i=e},this.setIndex=function(e){s=e.type,o=e.bytesPerElement},this.render=function(t,n){e.drawElements(i,n,s,t*o),a.update(n,i,1)},this.renderInstances=function(n,l,u){if(0===u)return;let c,p;if(r)c=e,p="drawElementsInstanced";else if(c=t.get("ANGLE_instanced_arrays"),p="drawElementsInstancedANGLE",null===c)return;c[p](i,l,s,n*o,u),a.update(l,i,u)}}function Ha(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(a,n,r){switch(t.calls++,n){case e.TRIANGLES:t.triangles+=r*(a/3);break;case e.LINES:t.lines+=r*(a/2);break;case e.LINE_STRIP:t.lines+=r*(a-1);break;case e.LINE_LOOP:t.lines+=r*a;break;case e.POINTS:t.points+=r*a}}}}function ka(e,t){return e[0]-t[0]}function Va(e,t){return Math.abs(t[1])-Math.abs(e[1])}function ja(e){const t={},a=new Float32Array(8),n=[];for(let e=0;e<8;e++)n[e]=[e,0];return{update:function(r,i,s,o){const l=r.morphTargetInfluences,u=void 0===l?0:l.length;let c=t[i.id];if(void 0===c){c=[];for(let e=0;e<u;e++)c[e]=[e,0];t[i.id]=c}for(let e=0;e<u;e++){const t=c[e];t[0]=e,t[1]=l[e]}c.sort(Va);for(let e=0;e<8;e++)e<u&&c[e][1]?(n[e][0]=c[e][0],n[e][1]=c[e][1]):(n[e][0]=Number.MAX_SAFE_INTEGER,n[e][1]=0);n.sort(ka);const p=s.morphTargets&&i.morphAttributes.position,d=s.morphNormals&&i.morphAttributes.normal;let f=0;for(let e=0;e<8;e++){const t=n[e],r=t[0],s=t[1];r!==Number.MAX_SAFE_INTEGER&&s?(p&&i.getAttribute("morphTarget"+e)!==p[r]&&i.setAttribute("morphTarget"+e,p[r]),d&&i.getAttribute("morphNormal"+e)!==d[r]&&i.setAttribute("morphNormal"+e,d[r]),a[e]=s,f+=s):(p&&void 0!==i.getAttribute("morphTarget"+e)&&i.deleteAttribute("morphTarget"+e),d&&void 0!==i.getAttribute("morphNormal"+e)&&i.deleteAttribute("morphNormal"+e),a[e]=0)}const h=i.morphTargetsRelative?1:1-f;o.getUniforms().setValue(e,"morphTargetBaseInfluence",h),o.getUniforms().setValue(e,"morphTargetInfluences",a)}}}function za(e,t,a,n){let r=new WeakMap;return{update:function(i){const s=n.render.frame,o=i.geometry,l=t.get(i,o);return r.get(l)!==s&&(o.isGeometry&&l.updateFromObject(i),t.update(l),r.set(l,s)),i.isInstancedMesh&&(a.update(i.instanceMatrix,e.ARRAY_BUFFER),null!==i.instanceColor&&a.update(i.instanceColor,e.ARRAY_BUFFER)),l},dispose:function(){r=new WeakMap}}}function Ya(e,t,a){const n=e.createShader(t);return e.shaderSource(n,a),e.compileShader(n),n}let qa=0;function Ka(e){switch(e){case ae:return["Linear","( value )"];case te:return["sRGB","( value )"];case ee:return["RGBE","( value )"];case $:return["RGBM","( value, 7.0 )"];case Q:return["RGBM","( value, 16.0 )"];case J:return["RGBD","( value, 256.0 )"];case Z:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case K:return["LogLuv","( value )"];default:return["Linear","( value )"]}}function Za(e,t,a){const n=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(n&&""===r)return"";return"THREE.WebGLShader: gl.getShaderInfoLog() "+a+"\n"+r+function(e){const t=e.split("\n");for(let e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join("\n")}(e.getShaderSource(t))}function Ja(e,t){const a=Ka(t);return"vec4 "+e+"( vec4 value ) { return "+a[0]+"ToLinear"+a[1]+"; }"}function Qa(e,t){const a=Ka(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+a[0]+a[1]+"; }"}function $a(e,t){let a;switch(t){case X:a="Linear";break;case W:a="Reinhard";break;case B:a="OptimizedCineon";break;case O:a="ACESFilmic";break;case I:a="Custom";break;default:a="Linear"}return"vec3 "+e+"( vec3 color ) { return "+a+"ToneMapping( color ); }"}function en(e){return""!==e}function tn(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function an(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const nn=/^[ \t]*#include +<([\w\d./]+)>/gm;function rn(e){return e.replace(nn,sn)}function sn(e,t){const a=U[t];if(void 0===a)throw new Error("Can not resolve #include <"+t+">");return rn(a)}const on=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,ln=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function un(e){return e.replace(ln,pn).replace(on,cn)}function cn(e,t,a,n){return pn(e,t,a,n)}function pn(e,t,a,n){let r="";for(let e=parseInt(t);e<parseInt(a);e++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return r}function dn(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function fn(e,t,a,n){const r=e.getContext(),i=a.defines;let s=a.vertexShader,o=a.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===H?t="SHADOWMAP_TYPE_PCF":e.shadowMapType===k?t="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===V&&(t="SHADOWMAP_TYPE_VSM"),t}(a),u=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case w:case L:t="ENVMAP_TYPE_CUBE";break;case f:case j:t="ENVMAP_TYPE_CUBE_UV"}return t}(a),c=function(e){let t="ENVMAP_MODE_REFLECTION";if(e.envMap)switch(e.envMapMode){case L:case j:t="ENVMAP_MODE_REFRACTION"}return t}(a),p=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case q:t="ENVMAP_BLENDING_MULTIPLY";break;case Y:t="ENVMAP_BLENDING_MIX";break;case z:t="ENVMAP_BLENDING_ADD"}return t}(a),d=e.gammaFactor>0?e.gammaFactor:1,h=a.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUV||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(en).join("\n")}(a),m=function(e){const t=[];for(const a in e){const n=e[a];!1!==n&&t.push("#define "+a+" "+n)}return t.join("\n")}(i),g=r.createProgram();let E,M,_=a.glslVersion?"#version "+a.glslVersion+"\n":"";a.isRawShaderMaterial?(E=[m].filter(en).join("\n"),E.length>0&&(E+="\n"),M=[h,m].filter(en).join("\n"),M.length>0&&(M+="\n")):(E=[dn(a),"#define SHADER_NAME "+a.shaderName,m,a.instancing?"#define USE_INSTANCING":"",a.instancingColor?"#define USE_INSTANCING_COLOR":"",a.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+d,"#define MAX_BONES "+a.maxBones,a.useFog&&a.fog?"#define USE_FOG":"",a.useFog&&a.fogExp2?"#define FOG_EXP2":"",a.map?"#define USE_MAP":"",a.envMap?"#define USE_ENVMAP":"",a.envMap?"#define "+c:"",a.lightMap?"#define USE_LIGHTMAP":"",a.aoMap?"#define USE_AOMAP":"",a.emissiveMap?"#define USE_EMISSIVEMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.normalMap&&a.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",a.normalMap&&a.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",a.clearcoatMap?"#define USE_CLEARCOATMAP":"",a.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",a.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",a.displacementMap&&a.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.roughnessMap?"#define USE_ROUGHNESSMAP":"",a.metalnessMap?"#define USE_METALNESSMAP":"",a.alphaMap?"#define USE_ALPHAMAP":"",a.transmissionMap?"#define USE_TRANSMISSIONMAP":"",a.vertexTangents?"#define USE_TANGENT":"",a.vertexColors?"#define USE_COLOR":"",a.vertexUvs?"#define USE_UV":"",a.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",a.flatShading?"#define FLAT_SHADED":"",a.skinning?"#define USE_SKINNING":"",a.useVertexTexture?"#define BONE_TEXTURE":"",a.morphTargets?"#define USE_MORPHTARGETS":"",a.morphNormals&&!1===a.flatShading?"#define USE_MORPHNORMALS":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"",a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+l:"",a.sizeAttenuation?"#define USE_SIZEATTENUATION":"",a.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",a.logarithmicDepthBuffer&&a.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(en).join("\n"),M=[h,dn(a),"#define SHADER_NAME "+a.shaderName,m,a.alphaTest?"#define ALPHATEST "+a.alphaTest+(a.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+d,a.useFog&&a.fog?"#define USE_FOG":"",a.useFog&&a.fogExp2?"#define FOG_EXP2":"",a.map?"#define USE_MAP":"",a.matcap?"#define USE_MATCAP":"",a.envMap?"#define USE_ENVMAP":"",a.envMap?"#define "+u:"",a.envMap?"#define "+c:"",a.envMap?"#define "+p:"",a.lightMap?"#define USE_LIGHTMAP":"",a.aoMap?"#define USE_AOMAP":"",a.emissiveMap?"#define USE_EMISSIVEMAP":"",a.bumpMap?"#define USE_BUMPMAP":"",a.normalMap?"#define USE_NORMALMAP":"",a.normalMap&&a.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",a.normalMap&&a.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",a.clearcoatMap?"#define USE_CLEARCOATMAP":"",a.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",a.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",a.specularMap?"#define USE_SPECULARMAP":"",a.roughnessMap?"#define USE_ROUGHNESSMAP":"",a.metalnessMap?"#define USE_METALNESSMAP":"",a.alphaMap?"#define USE_ALPHAMAP":"",a.sheen?"#define USE_SHEEN":"",a.transmissionMap?"#define USE_TRANSMISSIONMAP":"",a.vertexTangents?"#define USE_TANGENT":"",a.vertexColors||a.instancingColor?"#define USE_COLOR":"",a.vertexUvs?"#define USE_UV":"",a.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",a.gradientMap?"#define USE_GRADIENTMAP":"",a.flatShading?"#define FLAT_SHADED":"",a.doubleSided?"#define DOUBLE_SIDED":"",a.flipSided?"#define FLIP_SIDED":"",a.shadowMapEnabled?"#define USE_SHADOWMAP":"",a.shadowMapEnabled?"#define "+l:"",a.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",a.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",a.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",a.logarithmicDepthBuffer&&a.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(a.extensionShaderTextureLOD||a.envMap)&&a.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",a.toneMapping!==N?"#define TONE_MAPPING":"",a.toneMapping!==N?U.tonemapping_pars_fragment:"",a.toneMapping!==N?$a("toneMapping",a.toneMapping):"",a.dithering?"#define DITHERING":"",U.encodings_pars_fragment,a.map?Ja("mapTexelToLinear",a.mapEncoding):"",a.matcap?Ja("matcapTexelToLinear",a.matcapEncoding):"",a.envMap?Ja("envMapTexelToLinear",a.envMapEncoding):"",a.emissiveMap?Ja("emissiveMapTexelToLinear",a.emissiveMapEncoding):"",a.lightMap?Ja("lightMapTexelToLinear",a.lightMapEncoding):"",Qa("linearToOutputTexel",a.outputEncoding),a.depthPacking?"#define DEPTH_PACKING "+a.depthPacking:"","\n"].filter(en).join("\n")),s=rn(s),s=tn(s,a),s=an(s,a),o=rn(o),o=tn(o,a),o=an(o,a),s=un(s),o=un(o),a.isWebGL2&&!0!==a.isRawShaderMaterial&&(_="#version 300 es\n",E=["#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+E,M=["#define varying in",a.glslVersion===y?"":"out highp vec4 pc_fragColor;",a.glslVersion===y?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+M);const T=_+E+s,b=_+M+o,S=Ya(r,r.VERTEX_SHADER,T),x=Ya(r,r.FRAGMENT_SHADER,b);if(r.attachShader(g,S),r.attachShader(g,x),void 0!==a.index0AttributeName?r.bindAttribLocation(g,0,a.index0AttributeName):!0===a.morphTargets&&r.bindAttribLocation(g,0,"position"),r.linkProgram(g),e.debug.checkShaderErrors){const e=r.getProgramInfoLog(g).trim(),t=r.getShaderInfoLog(S).trim(),a=r.getShaderInfoLog(x).trim();let n=!0,i=!0;if(!1===r.getProgramParameter(g,r.LINK_STATUS)){n=!1;Za(r,S,"vertex"),Za(r,x,"fragment")}else""!==e||""!==t&&""!==a||(i=!1);i&&(this.diagnostics={runnable:n,programLog:e,vertexShader:{log:t,prefix:E},fragmentShader:{log:a,prefix:M}})}let v,A;return r.deleteShader(S),r.deleteShader(x),this.getUniforms=function(){return void 0===v&&(v=new D(r,g)),v},this.getAttributes=function(){return void 0===A&&(A=function(e,t){const a={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const n=e.getActiveAttrib(t,r).name;a[n]=e.getAttribLocation(t,n)}return a}(r,g)),A},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(g),this.program=void 0},this.name=a.shaderName,this.id=qa++,this.cacheKey=t,this.usedTimes=1,this.program=g,this.vertexShader=S,this.fragmentShader=x,this}function hn(e,t,a,n,r,i){const s=[],o=n.isWebGL2,l=n.logarithmicDepthBuffer,u=n.floatVertexTextures,c=n.maxVertexUniforms,p=n.vertexTextures;let d=n.precision;const h={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},m=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmissionMap"];function g(e){let t;return e?e.isTexture?t=e.encoding:e.isWebGLRenderTarget&&(t=e.texture.encoding):t=ae,t}return{getParameters:function(r,s,m,E,T){const b=E.fog,S=r.isMeshStandardMaterial?E.environment:null,x=t.get(r.envMap||S),v=h[r.type],A=T.isSkinnedMesh?function(e){const t=e.skeleton.bones;if(u)return 1024;{const e=c,a=Math.floor((e-20)/4),n=Math.min(a,t.length);return n<t.length?0:n}}(T):0;let R,w;if(null!==r.precision&&(d=n.getMaxPrecision(r.precision),r.precision),v){const e=M[v];R=e.vertexShader,w=e.fragmentShader}else R=r.vertexShader,w=r.fragmentShader;const L=e.getRenderTarget();return{isWebGL2:o,shaderID:v,shaderName:r.type,vertexShader:R,fragmentShader:w,defines:r.defines,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:d,instancing:!0===T.isInstancedMesh,instancingColor:!0===T.isInstancedMesh&&null!==T.instanceColor,supportsVertexTextures:p,outputEncoding:null!==L?g(L.texture):e.outputEncoding,map:!!r.map,mapEncoding:g(r.map),matcap:!!r.matcap,matcapEncoding:g(r.matcap),envMap:!!x,envMapMode:x&&x.mapping,envMapEncoding:g(x),envMapCubeUV:!!x&&(x.mapping===f||x.mapping===j),lightMap:!!r.lightMap,lightMapEncoding:g(r.lightMap),aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:g(r.emissiveMap),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,objectSpaceNormalMap:r.normalMapType===ne,tangentSpaceNormalMap:r.normalMapType===re,clearcoatMap:!!r.clearcoatMap,clearcoatRoughnessMap:!!r.clearcoatRoughnessMap,clearcoatNormalMap:!!r.clearcoatNormalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,gradientMap:!!r.gradientMap,sheen:!!r.sheen,transmissionMap:!!r.transmissionMap,combine:r.combine,vertexTangents:r.normalMap&&r.vertexTangents,vertexColors:r.vertexColors,vertexUvs:!!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatMap||r.clearcoatRoughnessMap||r.clearcoatNormalMap||r.displacementMap||r.transmissionMap),uvsVertexOnly:!(r.map||r.bumpMap||r.normalMap||r.specularMap||r.alphaMap||r.emissiveMap||r.roughnessMap||r.metalnessMap||r.clearcoatNormalMap||r.transmissionMap||!r.displacementMap),fog:!!b,useFog:r.fog,fogExp2:b&&b.isFogExp2,flatShading:r.flatShading,sizeAttenuation:r.sizeAttenuation,logarithmicDepthBuffer:l,skinning:r.skinning&&A>0,maxBones:A,useVertexTexture:u,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:s.directional.length,numPointLights:s.point.length,numSpotLights:s.spot.length,numRectAreaLights:s.rectArea.length,numHemiLights:s.hemi.length,numDirLightShadows:s.directionalShadowMap.length,numPointLightShadows:s.pointShadowMap.length,numSpotLightShadows:s.spotShadowMap.length,numClippingPlanes:i.numPlanes,numClipIntersection:i.numIntersection,dithering:r.dithering,shadowMapEnabled:e.shadowMap.enabled&&m.length>0,shadowMapType:e.shadowMap.type,toneMapping:r.toneMapped?e.toneMapping:N,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:r.side===ie,flipSided:r.side===_,depthPacking:void 0!==r.depthPacking&&r.depthPacking,index0AttributeName:r.index0AttributeName,extensionDerivatives:r.extensions&&r.extensions.derivatives,extensionFragDepth:r.extensions&&r.extensions.fragDepth,extensionDrawBuffers:r.extensions&&r.extensions.drawBuffers,extensionShaderTextureLOD:r.extensions&&r.extensions.shaderTextureLOD,rendererExtensionFragDepth:o||a.has("EXT_frag_depth"),rendererExtensionDrawBuffers:o||a.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:o||a.has("EXT_shader_texture_lod"),customProgramCacheKey:r.customProgramCacheKey()}},getProgramCacheKey:function(t){const a=[];if(t.shaderID?a.push(t.shaderID):(a.push(t.fragmentShader),a.push(t.vertexShader)),void 0!==t.defines)for(const e in t.defines)a.push(e),a.push(t.defines[e]);if(!1===t.isRawShaderMaterial){for(let e=0;e<m.length;e++)a.push(t[m[e]]);a.push(e.outputEncoding),a.push(e.gammaFactor)}return a.push(t.customProgramCacheKey),a.join()},getUniforms:function(e){const t=h[e.type];let a;if(t){const e=M[t];a=se.clone(e.uniforms)}else a=e.uniforms;return a},acquireProgram:function(t,a){let n;for(let e=0,t=s.length;e<t;e++){const t=s[e];if(t.cacheKey===a){n=t,++n.usedTimes;break}}return void 0===n&&(n=new fn(e,a,t,r),s.push(n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=s.indexOf(e);s[t]=s[s.length-1],s.pop(),e.destroy()}},programs:s}}function mn(){let e=new WeakMap;return{get:function(t){let a=e.get(t);return void 0===a&&(a={},e.set(t,a)),a},remove:function(t){e.delete(t)},update:function(t,a,n){e.get(t)[a]=n},dispose:function(){e=new WeakMap}}}function gn(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function En(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Mn(e){const t=[];let a=0;const n=[],r=[],i={id:-1};function s(n,r,s,o,l,u){let c=t[a];const p=e.get(s);return void 0===c?(c={id:n.id,object:n,geometry:r,material:s,program:p.program||i,groupOrder:o,renderOrder:n.renderOrder,z:l,group:u},t[a]=c):(c.id=n.id,c.object=n,c.geometry=r,c.material=s,c.program=p.program||i,c.groupOrder=o,c.renderOrder=n.renderOrder,c.z=l,c.group=u),a++,c}return{opaque:n,transparent:r,init:function(){a=0,n.length=0,r.length=0},push:function(e,t,a,i,o,l){const u=s(e,t,a,i,o,l);(!0===a.transparent?r:n).push(u)},unshift:function(e,t,a,i,o,l){const u=s(e,t,a,i,o,l);(!0===a.transparent?r:n).unshift(u)},finish:function(){for(let e=a,n=t.length;e<n;e++){const a=t[e];if(null===a.id)break;a.id=null,a.object=null,a.geometry=null,a.material=null,a.program=null,a.group=null}},sort:function(e,t){n.length>1&&n.sort(e||gn),r.length>1&&r.sort(t||En)}}}function _n(e){let t=new WeakMap;return{get:function(a,n){const r=t.get(a);let i;return void 0===r?(i=new Mn(e),t.set(a,new WeakMap),t.get(a).set(n,i)):(i=r.get(n),void 0===i&&(i=new Mn(e),r.set(n,i))),i},dispose:function(){t=new WeakMap}}}function Tn(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let a;switch(t.type){case"DirectionalLight":a={direction:new oe,color:new d};break;case"SpotLight":a={position:new oe,direction:new oe,color:new d,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":a={position:new oe,color:new d,distance:0,decay:0};break;case"HemisphereLight":a={direction:new oe,skyColor:new d,groundColor:new d};break;case"RectAreaLight":a={color:new d,position:new oe,halfWidth:new oe,halfHeight:new oe}}return e[t.id]=a,a}}}let bn=0;function Sn(e,t){return(t.castShadow?1:0)-(e.castShadow?1:0)}function xn(){const e=new Tn,t=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let a;switch(t.type){case"DirectionalLight":case"SpotLight":a={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ce};break;case"PointLight":a={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ce,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=a,a}}}(),a={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let e=0;e<9;e++)a.probe.push(new oe);const n=new oe,r=new le,i=new le;return{setup:function(s,o,l){let u=0,c=0,p=0;for(let e=0;e<9;e++)a.probe[e].set(0,0,0);let d=0,f=0,h=0,m=0,g=0,E=0,M=0,_=0;const T=l.matrixWorldInverse;s.sort(Sn);for(let o=0,l=s.length;o<l;o++){const l=s[o],b=l.color,S=l.intensity,x=l.distance,v=l.shadow&&l.shadow.map?l.shadow.map.texture:null;if(l.isAmbientLight)u+=b.r*S,c+=b.g*S,p+=b.b*S;else if(l.isLightProbe)for(let e=0;e<9;e++)a.probe[e].addScaledVector(l.sh.coefficients[e],S);else if(l.isDirectionalLight){const r=e.get(l);if(r.color.copy(l.color).multiplyScalar(l.intensity),r.direction.setFromMatrixPosition(l.matrixWorld),n.setFromMatrixPosition(l.target.matrixWorld),r.direction.sub(n),r.direction.transformDirection(T),l.castShadow){const e=l.shadow,n=t.get(l);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,a.directionalShadow[d]=n,a.directionalShadowMap[d]=v,a.directionalShadowMatrix[d]=l.shadow.matrix,E++}a.directional[d]=r,d++}else if(l.isSpotLight){const r=e.get(l);if(r.position.setFromMatrixPosition(l.matrixWorld),r.position.applyMatrix4(T),r.color.copy(b).multiplyScalar(S),r.distance=x,r.direction.setFromMatrixPosition(l.matrixWorld),n.setFromMatrixPosition(l.target.matrixWorld),r.direction.sub(n),r.direction.transformDirection(T),r.coneCos=Math.cos(l.angle),r.penumbraCos=Math.cos(l.angle*(1-l.penumbra)),r.decay=l.decay,l.castShadow){const e=l.shadow,n=t.get(l);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,a.spotShadow[h]=n,a.spotShadowMap[h]=v,a.spotShadowMatrix[h]=l.shadow.matrix,_++}a.spot[h]=r,h++}else if(l.isRectAreaLight){const t=e.get(l);t.color.copy(b).multiplyScalar(S),t.position.setFromMatrixPosition(l.matrixWorld),t.position.applyMatrix4(T),i.identity(),r.copy(l.matrixWorld),r.premultiply(T),i.extractRotation(r),t.halfWidth.set(.5*l.width,0,0),t.halfHeight.set(0,.5*l.height,0),t.halfWidth.applyMatrix4(i),t.halfHeight.applyMatrix4(i),a.rectArea[m]=t,m++}else if(l.isPointLight){const n=e.get(l);if(n.position.setFromMatrixPosition(l.matrixWorld),n.position.applyMatrix4(T),n.color.copy(l.color).multiplyScalar(l.intensity),n.distance=l.distance,n.decay=l.decay,l.castShadow){const e=l.shadow,n=t.get(l);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,n.shadowCameraNear=e.camera.near,n.shadowCameraFar=e.camera.far,a.pointShadow[f]=n,a.pointShadowMap[f]=v,a.pointShadowMatrix[f]=l.shadow.matrix,M++}a.point[f]=n,f++}else if(l.isHemisphereLight){const t=e.get(l);t.direction.setFromMatrixPosition(l.matrixWorld),t.direction.transformDirection(T),t.direction.normalize(),t.skyColor.copy(l.color).multiplyScalar(S),t.groundColor.copy(l.groundColor).multiplyScalar(S),a.hemi[g]=t,g++}}m>0&&(a.rectAreaLTC1=ue.LTC_1,a.rectAreaLTC2=ue.LTC_2),a.ambient[0]=u,a.ambient[1]=c,a.ambient[2]=p;const b=a.hash;b.directionalLength===d&&b.pointLength===f&&b.spotLength===h&&b.rectAreaLength===m&&b.hemiLength===g&&b.numDirectionalShadows===E&&b.numPointShadows===M&&b.numSpotShadows===_||(a.directional.length=d,a.spot.length=h,a.rectArea.length=m,a.point.length=f,a.hemi.length=g,a.directionalShadow.length=E,a.directionalShadowMap.length=E,a.pointShadow.length=M,a.pointShadowMap.length=M,a.spotShadow.length=_,a.spotShadowMap.length=_,a.directionalShadowMatrix.length=E,a.pointShadowMatrix.length=M,a.spotShadowMatrix.length=_,b.directionalLength=d,b.pointLength=f,b.spotLength=h,b.rectAreaLength=m,b.hemiLength=g,b.numDirectionalShadows=E,b.numPointShadows=M,b.numSpotShadows=_,a.version=bn++)},state:a}}function vn(){const e=new xn,t=[],a=[];return{init:function(){t.length=0,a.length=0},state:{lightsArray:t,shadowsArray:a,lights:e},setupLights:function(n){e.setup(t,a,n)},pushLight:function(e){t.push(e)},pushShadow:function(e){a.push(e)}}}function An(){let e=new WeakMap;return{get:function(t,a){let n;return!1===e.has(t)?(n=new vn,e.set(t,new WeakMap),e.get(t).set(a,n)):!1===e.get(t).has(a)?(n=new vn,e.get(t).set(a,n)):n=e.get(t).get(a),n},dispose:function(){e=new WeakMap}}}function Rn(e,t,a){let n=new pe;const r=new ce,i=new ce,s=new de,o=[],l=[],u={},p={0:_,1:T,2:ie},d=new g({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new ce},radius:{value:4}},vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}\n",fragmentShader:"\nuniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n\n#include <packing>\n\nvoid main() {\n\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\n\t// This seems totally useless but it's a crazy work around for a Adreno compiler bug\n\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\n\tfor ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\n\t\t#ifdef HORIZONAL_PASS\n\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\n\t\t#else\n\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\n\t\t#endif\n\n\t}\n\n\tmean = mean * HALF_SAMPLE_RATE;\n\tsquared_mean = squared_mean * HALF_SAMPLE_RATE;\n\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n\n}\n"}),f=d.clone();f.defines.HORIZONAL_PASS=1;const m=new c;m.setAttribute("position",new fe(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const E=new h(m,d),M=this;function b(a,n){const r=t.update(E);d.uniforms.shadow_pass.value=a.map.texture,d.uniforms.resolution.value=a.mapSize,d.uniforms.radius.value=a.radius,e.setRenderTarget(a.mapPass),e.clear(),e.renderBufferDirect(n,null,r,d,E,null),f.uniforms.shadow_pass.value=a.mapPass.texture,f.uniforms.resolution.value=a.mapSize,f.uniforms.radius.value=a.radius,e.setRenderTarget(a.map),e.clear(),e.renderBufferDirect(n,null,r,f,E,null)}function S(e,t,a){const n=e<<0|t<<1|a<<2;let r=o[n];return void 0===r&&(r=new _e({depthPacking:Te,morphTargets:e,skinning:t}),o[n]=r),r}function x(e,t,a){const n=e<<0|t<<1|a<<2;let r=l[n];return void 0===r&&(r=new be({morphTargets:e,skinning:t}),l[n]=r),r}function v(t,a,n,r,i,s,o){let l=null,c=S,d=t.customDepthMaterial;if(!0===r.isPointLight&&(c=x,d=t.customDistanceMaterial),void 0===d){let e=!1;!0===n.morphTargets&&(e=a.morphAttributes&&a.morphAttributes.position&&a.morphAttributes.position.length>0);let r=!1;!0===t.isSkinnedMesh&&!0===n.skinning&&(r=!0);l=c(e,r,!0===t.isInstancedMesh)}else l=d;if(e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length){const e=l.uuid,t=n.uuid;let a=u[e];void 0===a&&(a={},u[e]=a);let r=a[t];void 0===r&&(r=l.clone(),a[t]=r),l=r}return l.visible=n.visible,l.wireframe=n.wireframe,l.side=o===V?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:p[n.side],l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===r.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(r.matrixWorld),l.nearDistance=i,l.farDistance=s),l}function A(a,r,i,s,o){if(!1===a.visible)return;if(a.layers.test(r.layers)&&(a.isMesh||a.isLine||a.isPoints)&&(a.castShadow||a.receiveShadow&&o===V)&&(!a.frustumCulled||n.intersectsObject(a))){a.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,a.matrixWorld);const n=t.update(a),r=a.material;if(Array.isArray(r)){const t=n.groups;for(let l=0,u=t.length;l<u;l++){const u=t[l],c=r[u.materialIndex];if(c&&c.visible){const t=v(a,n,c,s,i.near,i.far,o);e.renderBufferDirect(i,null,n,t,a,u)}}}else if(r.visible){const t=v(a,n,r,s,i.near,i.far,o);e.renderBufferDirect(i,null,n,t,a,null)}}const l=a.children;for(let e=0,t=l.length;e<t;e++)A(l[e],r,i,s,o)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=H,this.render=function(t,o,l){if(!1===M.enabled)return;if(!1===M.autoUpdate&&!1===M.needsUpdate)return;if(0===t.length)return;const u=e.getRenderTarget(),c=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),d=e.state;d.setBlending(he),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let u=0,c=t.length;u<c;u++){const c=t[u],p=c.shadow;if(!1===p.autoUpdate&&!1===p.needsUpdate)continue;if(void 0===p)continue;r.copy(p.mapSize);const f=p.getFrameExtents();if(r.multiply(f),i.copy(p.mapSize),(r.x>a||r.y>a)&&(r.x>a&&(i.x=Math.floor(a/f.x),r.x=i.x*f.x,p.mapSize.x=i.x),r.y>a&&(i.y=Math.floor(a/f.y),r.y=i.y*f.y,p.mapSize.y=i.y)),null===p.map&&!p.isPointLightShadow&&this.type===V){const e={minFilter:ge,magFilter:ge,format:Ee};p.map=new me(r.x,r.y,e),p.map.texture.name=c.name+".shadowMap",p.mapPass=new me(r.x,r.y,e),p.camera.updateProjectionMatrix()}if(null===p.map){const e={minFilter:Me,magFilter:Me,format:Ee};p.map=new me(r.x,r.y,e),p.map.texture.name=c.name+".shadowMap",p.camera.updateProjectionMatrix()}e.setRenderTarget(p.map),e.clear();const h=p.getViewportCount();for(let e=0;e<h;e++){const t=p.getViewport(e);s.set(i.x*t.x,i.y*t.y,i.x*t.z,i.y*t.w),d.viewport(s),p.updateMatrices(c,e),n=p.getFrustum(),A(o,l,p.camera,c,this.type)}p.isPointLightShadow||this.type!==V||b(p,l),p.needsUpdate=!1}M.needsUpdate=!1,e.setRenderTarget(u,c,p)}}function wn(e,t,a){const n=a.isWebGL2;const r=new function(){let t=!1;const a=new de;let n=null;const r=new de(0,0,0,0);return{setMask:function(a){n===a||t||(e.colorMask(a,a,a,a),n=a)},setLocked:function(e){t=e},setClear:function(t,n,i,s,o){!0===o&&(t*=s,n*=s,i*=s),a.set(t,n,i,s),!1===r.equals(a)&&(e.clearColor(t,n,i,s),r.copy(a))},reset:function(){t=!1,n=null,r.set(-1,0,0,0)}}},i=new function(){let t=!1,a=null,n=null,r=null;return{setTest:function(t){t?y(e.DEPTH_TEST):D(e.DEPTH_TEST)},setMask:function(n){a===n||t||(e.depthMask(n),a=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case $e:e.depthFunc(e.NEVER);break;case Qe:e.depthFunc(e.ALWAYS);break;case Je:e.depthFunc(e.LESS);break;case Se:e.depthFunc(e.LEQUAL);break;case Ze:e.depthFunc(e.EQUAL);break;case Ke:e.depthFunc(e.GEQUAL);break;case qe:e.depthFunc(e.GREATER);break;case Ye:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);n=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,a=null,n=null,r=null}}},s=new function(){let t=!1,a=null,n=null,r=null,i=null,s=null,o=null,l=null,u=null;return{setTest:function(a){t||(a?y(e.STENCIL_TEST):D(e.STENCIL_TEST))},setMask:function(n){a===n||t||(e.stencilMask(n),a=n)},setFunc:function(t,a,s){n===t&&r===a&&i===s||(e.stencilFunc(t,a,s),n=t,r=a,i=s)},setOp:function(t,a,n){s===t&&o===a&&l===n||(e.stencilOp(t,a,n),s=t,o=a,l=n)},setLocked:function(e){t=e},setClear:function(t){u!==t&&(e.clearStencil(t),u=t)},reset:function(){t=!1,a=null,n=null,r=null,i=null,s=null,o=null,l=null,u=null}}};let o={},l=null,u=null,c=null,p=null,d=null,f=null,h=null,m=null,g=null,E=!1,M=null,T=null,b=null,S=null,x=null;const v=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let A=!1,R=0;const w=e.getParameter(e.VERSION);-1!==w.indexOf("WebGL")?(R=parseFloat(/^WebGL\ ([0-9])/.exec(w)[1]),A=R>=1):-1!==w.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL\ ES\ ([0-9])/.exec(w)[1]),A=R>=2);let L=null,P={};const F=new de,C=new de;function N(t,a,n){const r=new Uint8Array(4),i=e.createTexture();e.bindTexture(t,i),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let t=0;t<n;t++)e.texImage2D(a+t,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r);return i}const U={};function y(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function D(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}U[e.TEXTURE_2D]=N(e.TEXTURE_2D,e.TEXTURE_2D,1),U[e.TEXTURE_CUBE_MAP]=N(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),r.setClear(0,0,0,1),i.setClear(1),s.setClear(0),y(e.DEPTH_TEST),i.setFunc(Se),G(!1),W(je),y(e.CULL_FACE),B(he);const I={[xe]:e.FUNC_ADD,[ve]:e.FUNC_SUBTRACT,[Ae]:e.FUNC_REVERSE_SUBTRACT};if(n)I[Re]=e.MIN,I[we]=e.MAX;else{const e=t.get("EXT_blend_minmax");null!==e&&(I[Re]=e.MIN_EXT,I[we]=e.MAX_EXT)}const O={[Le]:e.ZERO,[Pe]:e.ONE,[Fe]:e.SRC_COLOR,[Ce]:e.SRC_ALPHA,[Ne]:e.SRC_ALPHA_SATURATE,[Ue]:e.DST_COLOR,[ye]:e.DST_ALPHA,[De]:e.ONE_MINUS_SRC_COLOR,[Ie]:e.ONE_MINUS_SRC_ALPHA,[Oe]:e.ONE_MINUS_DST_COLOR,[Be]:e.ONE_MINUS_DST_ALPHA};function B(t,a,n,r,i,s,o,l){if(t!==he){if(u||(y(e.BLEND),u=!0),t===Ge)i=i||a,s=s||n,o=o||r,a===p&&i===h||(e.blendEquationSeparate(I[a],I[i]),p=a,h=i),n===d&&r===f&&s===m&&o===g||(e.blendFuncSeparate(O[n],O[r],O[s],O[o]),d=n,f=r,m=s,g=o),c=t,E=null;else if(t!==c||l!==E){if(p===xe&&h===xe||(e.blendEquation(e.FUNC_ADD),p=xe,h=xe),l)switch(t){case ke:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case He:e.blendFunc(e.ONE,e.ONE);break;case Xe:e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA);break;case We:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)}else switch(t){case ke:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case He:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case Xe:e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR);break;case We:e.blendFunc(e.ZERO,e.SRC_COLOR)}d=null,f=null,m=null,g=null,c=t,E=l}}else u&&(D(e.BLEND),u=!1)}function G(t){M!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),M=t)}function W(t){t!==Ve?(y(e.CULL_FACE),t!==T&&(t===je?e.cullFace(e.BACK):t===ze?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):D(e.CULL_FACE),T=t}function X(t,a,n){t?(y(e.POLYGON_OFFSET_FILL),S===a&&x===n||(e.polygonOffset(a,n),S=a,x=n)):D(e.POLYGON_OFFSET_FILL)}function H(t){void 0===t&&(t=e.TEXTURE0+v-1),L!==t&&(e.activeTexture(t),L=t)}return{buffers:{color:r,depth:i,stencil:s},enable:y,disable:D,useProgram:function(t){return l!==t&&(e.useProgram(t),l=t,!0)},setBlending:B,setMaterial:function(t,a){t.side===ie?D(e.CULL_FACE):y(e.CULL_FACE);let n=t.side===_;a&&(n=!n),G(n),t.blending===ke&&!1===t.transparent?B(he):B(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),r.setMask(t.colorWrite);const o=t.stencilWrite;s.setTest(o),o&&(s.setMask(t.stencilWriteMask),s.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),s.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),X(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:G,setCullFace:W,setLineWidth:function(t){t!==b&&(A&&e.lineWidth(t),b=t)},setPolygonOffset:X,setScissorTest:function(t){t?y(e.SCISSOR_TEST):D(e.SCISSOR_TEST)},activeTexture:H,bindTexture:function(t,a){null===L&&H();let n=P[L];void 0===n&&(n={type:void 0,texture:void 0},P[L]=n),n.type===t&&n.texture===a||(e.bindTexture(t,a||U[t]),n.type=t,n.texture=a)},unbindTexture:function(){const t=P[L];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){}},scissor:function(t){!1===F.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),F.copy(t))},viewport:function(t){!1===C.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),C.copy(t))},reset:function(){o={},L=null,P={},l=null,c=null,M=null,T=null,r.reset(),i.reset(),s.reset()}}}function Ln(e,t,a,n,r,i,s){const o=r.isWebGL2,l=(r.maxTextures,r.maxCubemapSize),u=r.maxTextureSize,c=r.maxSamples,p=new WeakMap;let d,f=!1;try{f="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function h(e,t){return f?new OffscreenCanvas(e,t):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function m(e,t,a,n){let r=1;if((e.width>n||e.height>n)&&(r=n/Math.max(e.width,e.height)),r<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?ot.floorPowerOfTwo:Math.floor,i=n(r*e.width),s=n(r*e.height);void 0===d&&(d=h(i,s));const o=a?h(i,s):d;o.width=i,o.height=s;return o.getContext("2d").drawImage(e,0,0,i,s),o}return e}return e}function g(e){return ot.isPowerOfTwo(e.width)&&ot.isPowerOfTwo(e.height)}function E(e,t){return e.generateMipmaps&&t&&e.minFilter!==Me&&e.minFilter!==ge}function M(t,a,r,i){e.generateMipmap(t);n.get(a).__maxMipLevel=Math.log(Math.max(r,i))*Math.LOG2E}function _(a,n,r){if(!1===o)return n;if(null!==a&&void 0!==e[a])return e[a];let i=n;return n===e.RED&&(r===e.FLOAT&&(i=e.R32F),r===e.HALF_FLOAT&&(i=e.R16F),r===e.UNSIGNED_BYTE&&(i=e.R8)),n===e.RGB&&(r===e.FLOAT&&(i=e.RGB32F),r===e.HALF_FLOAT&&(i=e.RGB16F),r===e.UNSIGNED_BYTE&&(i=e.RGB8)),n===e.RGBA&&(r===e.FLOAT&&(i=e.RGBA32F),r===e.HALF_FLOAT&&(i=e.RGBA16F),r===e.UNSIGNED_BYTE&&(i=e.RGBA8)),i!==e.R16F&&i!==e.R32F&&i!==e.RGBA16F&&i!==e.RGBA32F||t.get("EXT_color_buffer_float"),i}function T(t){return t===Me||t===nt||t===rt?e.NEAREST:e.LINEAR}function b(t){const a=t.target;a.removeEventListener("dispose",b),function(t){const a=n.get(t);if(void 0===a.__webglInit)return;e.deleteTexture(a.__webglTexture),n.remove(t)}(a),a.isVideoTexture&&p.delete(a),s.memory.textures--}function S(t){const a=t.target;a.removeEventListener("dispose",S),function(t){const a=n.get(t),r=n.get(t.texture);if(!t)return;void 0!==r.__webglTexture&&e.deleteTexture(r.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++)e.deleteFramebuffer(a.__webglFramebuffer[t]),a.__webglDepthbuffer&&e.deleteRenderbuffer(a.__webglDepthbuffer[t]);else e.deleteFramebuffer(a.__webglFramebuffer),a.__webglDepthbuffer&&e.deleteRenderbuffer(a.__webglDepthbuffer),a.__webglMultisampledFramebuffer&&e.deleteFramebuffer(a.__webglMultisampledFramebuffer),a.__webglColorRenderbuffer&&e.deleteRenderbuffer(a.__webglColorRenderbuffer),a.__webglDepthRenderbuffer&&e.deleteRenderbuffer(a.__webglDepthRenderbuffer);n.remove(t.texture),n.remove(t)}(a),s.memory.textures--}let x=0;function v(t,r){const i=n.get(t);if(t.isVideoTexture&&function(e){const t=s.render.frame;p.get(e)!==t&&(p.set(e,t),e.update())}(t),t.version>0&&i.__version!==t.version){const e=t.image;if(void 0===e);else if(!1!==e.complete)return void C(i,t,r)}a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_2D,i.__webglTexture)}function A(t,r){if(6!==t.image.length)return;const s=n.get(t);if(t.version>0&&s.__version!==t.version){F(s,t),a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_CUBE_MAP,s.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);const n=t&&(t.isCompressedTexture||t.image[0].isCompressedTexture),u=t.image[0]&&t.image[0].isDataTexture,c=[];for(let e=0;e<6;e++)c[e]=n||u?u?t.image[e].image:t.image[e]:m(t.image[e],!1,!0,l);const p=c[0],d=g(p)||o,f=i.convert(t.format),h=i.convert(t.type),T=_(t.internalFormat,f,h);let b;if(P(e.TEXTURE_CUBE_MAP,t,d),n){for(let n=0;n<6;n++){b=c[n].mipmaps;for(let r=0;r<b.length;r++){const i=b[r];t.format!==Ee&&t.format!==lt?null!==f&&a.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,r,T,i.width,i.height,0,i.data):a.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,r,T,i.width,i.height,0,f,h,i.data)}}s.__maxMipLevel=b.length-1}else{b=t.mipmaps;for(let t=0;t<6;t++)if(u){a.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,c[t].width,c[t].height,0,f,h,c[t].data);for(let n=0;n<b.length;n++){const r=b[n].image[t].image;a.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,T,r.width,r.height,0,f,h,r.data)}}else{a.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,T,f,h,c[t]);for(let n=0;n<b.length;n++){const r=b[n];a.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,T,f,h,r.image[t])}}s.__maxMipLevel=b.length}E(t,d)&&M(e.TEXTURE_CUBE_MAP,t,p.width,p.height),s.__version=t.version,t.onUpdate&&t.onUpdate(t)}else a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_CUBE_MAP,s.__webglTexture)}function R(t,r){a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_CUBE_MAP,n.get(t).__webglTexture)}const w={[et]:e.REPEAT,[tt]:e.CLAMP_TO_EDGE,[at]:e.MIRRORED_REPEAT},L={[Me]:e.NEAREST,[nt]:e.NEAREST_MIPMAP_NEAREST,[rt]:e.NEAREST_MIPMAP_LINEAR,[ge]:e.LINEAR,[it]:e.LINEAR_MIPMAP_NEAREST,[st]:e.LINEAR_MIPMAP_LINEAR};function P(a,i,s){s?(e.texParameteri(a,e.TEXTURE_WRAP_S,w[i.wrapS]),e.texParameteri(a,e.TEXTURE_WRAP_T,w[i.wrapT]),a!==e.TEXTURE_3D&&a!==e.TEXTURE_2D_ARRAY||e.texParameteri(a,e.TEXTURE_WRAP_R,w[i.wrapR]),e.texParameteri(a,e.TEXTURE_MAG_FILTER,L[i.magFilter]),e.texParameteri(a,e.TEXTURE_MIN_FILTER,L[i.minFilter])):(e.texParameteri(a,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(a,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a!==e.TEXTURE_3D&&a!==e.TEXTURE_2D_ARRAY||e.texParameteri(a,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),i.wrapS!==tt||i.wrapT,e.texParameteri(a,e.TEXTURE_MAG_FILTER,T(i.magFilter)),e.texParameteri(a,e.TEXTURE_MIN_FILTER,T(i.minFilter)),i.minFilter!==Me&&i.minFilter);const l=t.get("EXT_texture_filter_anisotropic");if(l){if(i.type===ut&&null===t.get("OES_texture_float_linear"))return;if(i.type===ct&&null===(o||t.get("OES_texture_half_float_linear")))return;(i.anisotropy>1||n.get(i).__currentAnisotropy)&&(e.texParameterf(a,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,r.getMaxAnisotropy())),n.get(i).__currentAnisotropy=i.anisotropy)}}function F(t,a){void 0===t.__webglInit&&(t.__webglInit=!0,a.addEventListener("dispose",b),t.__webglTexture=e.createTexture(),s.memory.textures++)}function C(t,n,r){let s=e.TEXTURE_2D;n.isDataTexture2DArray&&(s=e.TEXTURE_2D_ARRAY),n.isDataTexture3D&&(s=e.TEXTURE_3D),F(t,n),a.activeTexture(e.TEXTURE0+r),a.bindTexture(s,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment);const l=function(e){return!o&&(e.wrapS!==tt||e.wrapT!==tt||e.minFilter!==Me&&e.minFilter!==ge)}(n)&&!1===g(n.image),c=m(n.image,l,!1,u),p=g(c)||o,d=i.convert(n.format);let f,h=i.convert(n.type),T=_(n.internalFormat,d,h);P(s,n,p);const b=n.mipmaps;if(n.isDepthTexture)T=e.DEPTH_COMPONENT,o?T=n.type===ut?e.DEPTH_COMPONENT32F:n.type===pt?e.DEPTH_COMPONENT24:n.type===dt?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT16:n.type,n.format===ft&&T===e.DEPTH_COMPONENT&&n.type!==ht&&n.type!==pt&&(n.type=ht,h=i.convert(n.type)),n.format===mt&&T===e.DEPTH_COMPONENT&&(T=e.DEPTH_STENCIL,n.type!==dt&&(n.type=dt,h=i.convert(n.type))),a.texImage2D(e.TEXTURE_2D,0,T,c.width,c.height,0,d,h,null);else if(n.isDataTexture)if(b.length>0&&p){for(let t=0,n=b.length;t<n;t++)f=b[t],a.texImage2D(e.TEXTURE_2D,t,T,f.width,f.height,0,d,h,f.data);n.generateMipmaps=!1,t.__maxMipLevel=b.length-1}else a.texImage2D(e.TEXTURE_2D,0,T,c.width,c.height,0,d,h,c.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(let t=0,r=b.length;t<r;t++)f=b[t],n.format!==Ee&&n.format!==lt?null!==d&&a.compressedTexImage2D(e.TEXTURE_2D,t,T,f.width,f.height,0,f.data):a.texImage2D(e.TEXTURE_2D,t,T,f.width,f.height,0,d,h,f.data);t.__maxMipLevel=b.length-1}else if(n.isDataTexture2DArray)a.texImage3D(e.TEXTURE_2D_ARRAY,0,T,c.width,c.height,c.depth,0,d,h,c.data),t.__maxMipLevel=0;else if(n.isDataTexture3D)a.texImage3D(e.TEXTURE_3D,0,T,c.width,c.height,c.depth,0,d,h,c.data),t.__maxMipLevel=0;else if(b.length>0&&p){for(let t=0,n=b.length;t<n;t++)f=b[t],a.texImage2D(e.TEXTURE_2D,t,T,d,h,f);n.generateMipmaps=!1,t.__maxMipLevel=b.length-1}else a.texImage2D(e.TEXTURE_2D,0,T,d,h,c),t.__maxMipLevel=0;E(n,p)&&M(s,n,c.width,c.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function N(t,r,s,o){const l=i.convert(r.texture.format),u=i.convert(r.texture.type),c=_(r.texture.internalFormat,l,u);a.texImage2D(o,0,c,r.width,r.height,0,l,u,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,s,o,n.get(r.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function U(t,a,n){if(e.bindRenderbuffer(e.RENDERBUFFER,t),a.depthBuffer&&!a.stencilBuffer){let r=e.DEPTH_COMPONENT16;if(n){const t=a.depthTexture;t&&t.isDepthTexture&&(t.type===ut?r=e.DEPTH_COMPONENT32F:t.type===pt&&(r=e.DEPTH_COMPONENT24));const n=D(a);e.renderbufferStorageMultisample(e.RENDERBUFFER,n,r,a.width,a.height)}else e.renderbufferStorage(e.RENDERBUFFER,r,a.width,a.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}else if(a.depthBuffer&&a.stencilBuffer){if(n){const t=D(a);e.renderbufferStorageMultisample(e.RENDERBUFFER,t,e.DEPTH24_STENCIL8,a.width,a.height)}else e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,a.width,a.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)}else{const t=i.convert(a.texture.format),r=i.convert(a.texture.type),s=_(a.texture.internalFormat,t,r);if(n){const t=D(a);e.renderbufferStorageMultisample(e.RENDERBUFFER,t,s,a.width,a.height)}else e.renderbufferStorage(e.RENDERBUFFER,s,a.width,a.height)}e.bindRenderbuffer(e.RENDERBUFFER,null)}function y(t){const a=n.get(t),r=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,a){if(a&&a.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!a.depthTexture||!a.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(a.depthTexture).__webglTexture&&a.depthTexture.image.width===a.width&&a.depthTexture.image.height===a.height||(a.depthTexture.image.width=a.width,a.depthTexture.image.height=a.height,a.depthTexture.needsUpdate=!0),v(a.depthTexture,0);const r=n.get(a.depthTexture).__webglTexture;if(a.depthTexture.format===ft)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0);else{if(a.depthTexture.format!==mt)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,r,0)}}(a.__webglFramebuffer,t)}else if(r){a.__webglDepthbuffer=[];for(let n=0;n<6;n++)e.bindFramebuffer(e.FRAMEBUFFER,a.__webglFramebuffer[n]),a.__webglDepthbuffer[n]=e.createRenderbuffer(),U(a.__webglDepthbuffer[n],t,!1)}else e.bindFramebuffer(e.FRAMEBUFFER,a.__webglFramebuffer),a.__webglDepthbuffer=e.createRenderbuffer(),U(a.__webglDepthbuffer,t,!1);e.bindFramebuffer(e.FRAMEBUFFER,null)}function D(e){return o&&e.isWebGLMultisampleRenderTarget?Math.min(c,e.samples):0}this.allocateTextureUnit=function(){const e=x;return x+=1,e},this.resetTextureUnits=function(){x=0},this.setTexture2D=v,this.setTexture2DArray=function(t,r){const i=n.get(t);t.version>0&&i.__version!==t.version?C(i,t,r):(a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_2D_ARRAY,i.__webglTexture))},this.setTexture3D=function(t,r){const i=n.get(t);t.version>0&&i.__version!==t.version?C(i,t,r):(a.activeTexture(e.TEXTURE0+r),a.bindTexture(e.TEXTURE_3D,i.__webglTexture))},this.setTextureCube=A,this.setTextureCubeDynamic=R,this.setupRenderTarget=function(t){const r=n.get(t),l=n.get(t.texture);t.addEventListener("dispose",S),l.__webglTexture=e.createTexture(),s.memory.textures++;const u=!0===t.isWebGLCubeRenderTarget,c=!0===t.isWebGLMultisampleRenderTarget,p=g(t)||o;if(!o||t.texture.format!==lt||t.texture.type!==ut&&t.texture.type!==ct||(t.texture.format=Ee),u){r.__webglFramebuffer=[];for(let t=0;t<6;t++)r.__webglFramebuffer[t]=e.createFramebuffer()}else if(r.__webglFramebuffer=e.createFramebuffer(),c&&o){r.__webglMultisampledFramebuffer=e.createFramebuffer(),r.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,r.__webglColorRenderbuffer);const a=i.convert(t.texture.format),n=i.convert(t.texture.type),s=_(t.texture.internalFormat,a,n),o=D(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,o,s,t.width,t.height),e.bindFramebuffer(e.FRAMEBUFFER,r.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,r.__webglColorRenderbuffer),e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(r.__webglDepthRenderbuffer=e.createRenderbuffer(),U(r.__webglDepthRenderbuffer,t,!0)),e.bindFramebuffer(e.FRAMEBUFFER,null)}if(u){a.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),P(e.TEXTURE_CUBE_MAP,t.texture,p);for(let a=0;a<6;a++)N(r.__webglFramebuffer[a],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+a);E(t.texture,p)&&M(e.TEXTURE_CUBE_MAP,t.texture,t.width,t.height),a.bindTexture(e.TEXTURE_CUBE_MAP,null)}else a.bindTexture(e.TEXTURE_2D,l.__webglTexture),P(e.TEXTURE_2D,t.texture,p),N(r.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),E(t.texture,p)&&M(e.TEXTURE_2D,t.texture,t.width,t.height),a.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&y(t)},this.updateRenderTargetMipmap=function(t){const r=t.texture;if(E(r,g(t)||o)){const i=t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,s=n.get(r).__webglTexture;a.bindTexture(i,s),M(i,r,t.width,t.height),a.bindTexture(i,null)}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget&&o){const a=n.get(t);e.bindFramebuffer(e.READ_FRAMEBUFFER,a.__webglMultisampledFramebuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,a.__webglFramebuffer);const r=t.width,i=t.height;let s=e.COLOR_BUFFER_BIT;t.depthBuffer&&(s|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&(s|=e.STENCIL_BUFFER_BIT),e.blitFramebuffer(0,0,r,i,0,0,r,i,s,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,a.__webglMultisampledFramebuffer)}},this.safeSetTexture2D=function(e,t){e&&e.isWebGLRenderTarget&&(e=e.texture),v(e,t)},this.safeSetTextureCube=function(e,t){e&&e.isWebGLCubeRenderTarget&&(e=e.texture),e&&e.isCubeTexture||Array.isArray(e.image)&&6===e.image.length?A(e,t):R(e,t)}}function Pn(e,t,a){const n=a.isWebGL2;return{convert:function(a){let r;if(a===gt)return e.UNSIGNED_BYTE;if(a===Et)return e.UNSIGNED_SHORT_4_4_4_4;if(a===Mt)return e.UNSIGNED_SHORT_5_5_5_1;if(a===_t)return e.UNSIGNED_SHORT_5_6_5;if(a===Tt)return e.BYTE;if(a===bt)return e.SHORT;if(a===ht)return e.UNSIGNED_SHORT;if(a===St)return e.INT;if(a===pt)return e.UNSIGNED_INT;if(a===ut)return e.FLOAT;if(a===ct)return n?e.HALF_FLOAT:(r=t.get("OES_texture_half_float"),null!==r?r.HALF_FLOAT_OES:null);if(a===xt)return e.ALPHA;if(a===lt)return e.RGB;if(a===Ee)return e.RGBA;if(a===vt)return e.LUMINANCE;if(a===At)return e.LUMINANCE_ALPHA;if(a===ft)return e.DEPTH_COMPONENT;if(a===mt)return e.DEPTH_STENCIL;if(a===Rt)return e.RED;if(a===wt)return e.RED_INTEGER;if(a===Lt)return e.RG;if(a===Pt)return e.RG_INTEGER;if(a===Ft)return e.RGB_INTEGER;if(a===Ct)return e.RGBA_INTEGER;if(a===Nt||a===Ut||a===yt||a===Dt){if(r=t.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(a===Nt)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(a===Ut)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(a===yt)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(a===Dt)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(a===It||a===Ot||a===Bt||a===Gt){if(r=t.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(a===It)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(a===Ot)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(a===Bt)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(a===Gt)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(a===Wt)return r=t.get("WEBGL_compressed_texture_etc1"),null!==r?r.COMPRESSED_RGB_ETC1_WEBGL:null;if((a===Xt||a===Ht)&&(r=t.get("WEBGL_compressed_texture_etc"),null!==r)){if(a===Xt)return r.COMPRESSED_RGB8_ETC2;if(a===Ht)return r.COMPRESSED_RGBA8_ETC2_EAC}return a===kt||a===Vt||a===jt||a===zt||a===Yt||a===qt||a===Kt||a===Zt||a===Jt||a===Qt||a===$t||a===ea||a===ta||a===aa||a===na||a===ra||a===ia||a===sa||a===oa||a===la||a===ua||a===ca||a===pa||a===da||a===fa||a===ha||a===ma||a===ga?(r=t.get("WEBGL_compressed_texture_astc"),null!==r?a:null):a===Ea?(r=t.get("EXT_texture_compression_bptc"),null!==r?a:null):a===dt?n?e.UNSIGNED_INT_24_8:(r=t.get("WEBGL_depth_texture"),null!==r?r.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}function Fn(e){function t(t,a){t.opacity.value=a.opacity,a.color&&t.diffuse.value.copy(a.color),a.emissive&&t.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),a.map&&(t.map.value=a.map),a.alphaMap&&(t.alphaMap.value=a.alphaMap),a.specularMap&&(t.specularMap.value=a.specularMap);const n=e.get(a).envMap;if(n){t.envMap.value=n,t.flipEnvMap.value=n.isCubeTexture?-1:1,t.reflectivity.value=a.reflectivity,t.refractionRatio.value=a.refractionRatio;const r=e.get(n).__maxMipLevel;void 0!==r&&(t.maxMipLevel.value=r)}let r,i;a.lightMap&&(t.lightMap.value=a.lightMap,t.lightMapIntensity.value=a.lightMapIntensity),a.aoMap&&(t.aoMap.value=a.aoMap,t.aoMapIntensity.value=a.aoMapIntensity),a.map?r=a.map:a.specularMap?r=a.specularMap:a.displacementMap?r=a.displacementMap:a.normalMap?r=a.normalMap:a.bumpMap?r=a.bumpMap:a.roughnessMap?r=a.roughnessMap:a.metalnessMap?r=a.metalnessMap:a.alphaMap?r=a.alphaMap:a.emissiveMap?r=a.emissiveMap:a.clearcoatMap?r=a.clearcoatMap:a.clearcoatNormalMap?r=a.clearcoatNormalMap:a.clearcoatRoughnessMap&&(r=a.clearcoatRoughnessMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix)),a.aoMap?i=a.aoMap:a.lightMap&&(i=a.lightMap),void 0!==i&&(i.isWebGLRenderTarget&&(i=i.texture),!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uv2Transform.value.copy(i.matrix))}function a(t,a){t.roughness.value=a.roughness,t.metalness.value=a.metalness,a.roughnessMap&&(t.roughnessMap.value=a.roughnessMap),a.metalnessMap&&(t.metalnessMap.value=a.metalnessMap),a.emissiveMap&&(t.emissiveMap.value=a.emissiveMap),a.bumpMap&&(t.bumpMap.value=a.bumpMap,t.bumpScale.value=a.bumpScale,a.side===_&&(t.bumpScale.value*=-1)),a.normalMap&&(t.normalMap.value=a.normalMap,t.normalScale.value.copy(a.normalScale),a.side===_&&t.normalScale.value.negate()),a.displacementMap&&(t.displacementMap.value=a.displacementMap,t.displacementScale.value=a.displacementScale,t.displacementBias.value=a.displacementBias);e.get(a).envMap&&(t.envMapIntensity.value=a.envMapIntensity)}return{refreshFogUniforms:function(e,t){e.fogColor.value.copy(t.color),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,r,i){n.isMeshBasicMaterial?t(e,n):n.isMeshLambertMaterial?(t(e,n),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(e,n)):n.isMeshToonMaterial?(t(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap);t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===_&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===_&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshPhongMaterial?(t(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===_&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===_&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshStandardMaterial?(t(e,n),n.isMeshPhysicalMaterial?function(e,t){a(e,t),e.reflectivity.value=t.reflectivity,e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.sheen&&e.sheen.value.copy(t.sheen);t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap);t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap);t.clearcoatNormalMap&&(e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),e.clearcoatNormalMap.value=t.clearcoatNormalMap,t.side===_&&e.clearcoatNormalScale.value.negate());e.transmission.value=t.transmission,t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap)}(e,n):a(e,n)):n.isMeshMatcapMaterial?(t(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===_&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===_&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDepthMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDistanceMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(e,n)):n.isMeshNormalMaterial?(t(e,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===_&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===_&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,a,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*a,e.scale.value=.5*n,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let r;t.map?r=t.map:t.alphaMap&&(r=t.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix))}(e,n,r,i):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);let a;t.map?a=t.map:t.alphaMap&&(a=t.alphaMap);void 0!==a&&(!0===a.matrixAutoUpdate&&a.updateMatrix(),e.uvTransform.value.copy(a.matrix))}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function Cn(e){const t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),a=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,r=void 0===e.depth||e.depth,i=void 0===e.stencil||e.stencil,s=void 0!==e.antialias&&e.antialias,o=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,u=void 0!==e.powerPreference?e.powerPreference:"default",c=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;let p=null,d=null;this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=ae,this.physicallyCorrectLights=!1,this.toneMapping=N,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const f=this;let h=!1,m=null,g=0,E=0,M=null,_=null,T=-1,b=null,S=null;const x=new de,v=new de;let A=null,R=t.width,w=t.height,L=1,P=null,F=null;const C=new de(0,0,R,w),U=new de(0,0,R,w);let y=!1;const I=new pe;let O=!1,B=!1;const G=new le,W=new oe,X={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function H(){return null===M?L:1}let k,V,j,z,Y,q,K,Z,J,Q,$,ee,te,ne,re,ie,se,ue,fe,he,me,ge=a;function Me(e,a){for(let n=0;n<e.length;n++){const r=e[n],i=t.getContext(r,a);if(null!==i)return i}return null}try{const e={alpha:n,depth:r,stencil:i,antialias:s,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:u,failIfMajorPerformanceCaveat:c};if(t.addEventListener("webglcontextlost",Se,!1),t.addEventListener("webglcontextrestored",xe,!1),null===ge){const t=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&t.shift(),ge=Me(t,e),null===ge)throw Me(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===ge.getShaderPrecisionFormat&&(ge.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw e}function _e(){k=new Ga(ge),V=new Ia(ge,k,e),!1===V.isWebGL2&&(k.get("WEBGL_depth_texture"),k.get("OES_texture_float"),k.get("OES_texture_half_float"),k.get("OES_texture_half_float_linear"),k.get("OES_standard_derivatives"),k.get("OES_element_index_uint"),k.get("OES_vertex_array_object"),k.get("ANGLE_instanced_arrays")),k.get("OES_texture_float_linear"),he=new Pn(ge,k,V),j=new wn(ge,k,V),j.scissor(v.copy(U).multiplyScalar(L).floor()),j.viewport(x.copy(C).multiplyScalar(L).floor()),z=new Ha(ge),Y=new mn,q=new Ln(ge,k,j,Y,V,he,z),K=new Ba(f),Z=new Ca(ge,V),me=new ya(ge,k,Z,V),J=new Wa(ge,Z,z,me),Q=new za(ge,J,Z,z),se=new ja(ge),re=new Oa(Y),$=new hn(f,K,k,V,me,re),ee=new Fn(Y),te=new _n(Y),ne=new An,ie=new Ua(f,K,j,Q,o),ue=new Da(ge,k,z,V),fe=new Xa(ge,k,z,V),z.programs=$.programs,f.capabilities=V,f.extensions=k,f.properties=Y,f.renderLists=te,f.state=j,f.info=z}_e();const Te=new Ma(f,ge);this.xr=Te;const be=new Rn(f,Q,V.maxTextureSize);function Se(e){e.preventDefault(),h=!0}function xe(){h=!1,_e()}function ve(e){const t=e.target;t.removeEventListener("dispose",ve),function(e){Ae(e),Y.remove(e)}(t)}function Ae(e){const t=Y.get(e).program;void 0!==t&&$.releaseProgram(t)}this.shadowMap=be,this.getContext=function(){return ge},this.getContextAttributes=function(){return ge.getContextAttributes()},this.forceContextLoss=function(){const e=k.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=k.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return L},this.setPixelRatio=function(e){void 0!==e&&(L=e,this.setSize(R,w,!1))},this.getSize=function(e){return void 0===e&&(e=new ce),e.set(R,w)},this.setSize=function(e,a,n){Te.isPresenting||(R=e,w=a,t.width=Math.floor(e*L),t.height=Math.floor(a*L),!1!==n&&(t.style.width=e+"px",t.style.height=a+"px"),this.setViewport(0,0,e,a))},this.getDrawingBufferSize=function(e){return void 0===e&&(e=new ce),e.set(R*L,w*L).floor()},this.setDrawingBufferSize=function(e,a,n){R=e,w=a,L=n,t.width=Math.floor(e*n),t.height=Math.floor(a*n),this.setViewport(0,0,e,a)},this.getCurrentViewport=function(e){return void 0===e&&(e=new de),e.copy(x)},this.getViewport=function(e){return e.copy(C)},this.setViewport=function(e,t,a,n){e.isVector4?C.set(e.x,e.y,e.z,e.w):C.set(e,t,a,n),j.viewport(x.copy(C).multiplyScalar(L).floor())},this.getScissor=function(e){return e.copy(U)},this.setScissor=function(e,t,a,n){e.isVector4?U.set(e.x,e.y,e.z,e.w):U.set(e,t,a,n),j.scissor(v.copy(U).multiplyScalar(L).floor())},this.getScissorTest=function(){return y},this.setScissorTest=function(e){j.setScissorTest(y=e)},this.setOpaqueSort=function(e){P=e},this.setTransparentSort=function(e){F=e},this.getClearColor=function(){return ie.getClearColor()},this.setClearColor=function(){ie.setClearColor.apply(ie,arguments)},this.getClearAlpha=function(){return ie.getClearAlpha()},this.setClearAlpha=function(){ie.setClearAlpha.apply(ie,arguments)},this.clear=function(e,t,a){let n=0;(void 0===e||e)&&(n|=ge.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=ge.DEPTH_BUFFER_BIT),(void 0===a||a)&&(n|=ge.STENCIL_BUFFER_BIT),ge.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Se,!1),t.removeEventListener("webglcontextrestored",xe,!1),te.dispose(),ne.dispose(),Y.dispose(),K.dispose(),Q.dispose(),me.dispose(),Te.dispose(),we.stop()},this.renderBufferImmediate=function(e,t){me.initAttributes();const a=Y.get(e);e.hasPositions&&!a.position&&(a.position=ge.createBuffer()),e.hasNormals&&!a.normal&&(a.normal=ge.createBuffer()),e.hasUvs&&!a.uv&&(a.uv=ge.createBuffer()),e.hasColors&&!a.color&&(a.color=ge.createBuffer());const n=t.getAttributes();e.hasPositions&&(ge.bindBuffer(ge.ARRAY_BUFFER,a.position),ge.bufferData(ge.ARRAY_BUFFER,e.positionArray,ge.DYNAMIC_DRAW),me.enableAttribute(n.position),ge.vertexAttribPointer(n.position,3,ge.FLOAT,!1,0,0)),e.hasNormals&&(ge.bindBuffer(ge.ARRAY_BUFFER,a.normal),ge.bufferData(ge.ARRAY_BUFFER,e.normalArray,ge.DYNAMIC_DRAW),me.enableAttribute(n.normal),ge.vertexAttribPointer(n.normal,3,ge.FLOAT,!1,0,0)),e.hasUvs&&(ge.bindBuffer(ge.ARRAY_BUFFER,a.uv),ge.bufferData(ge.ARRAY_BUFFER,e.uvArray,ge.DYNAMIC_DRAW),me.enableAttribute(n.uv),ge.vertexAttribPointer(n.uv,2,ge.FLOAT,!1,0,0)),e.hasColors&&(ge.bindBuffer(ge.ARRAY_BUFFER,a.color),ge.bufferData(ge.ARRAY_BUFFER,e.colorArray,ge.DYNAMIC_DRAW),me.enableAttribute(n.color),ge.vertexAttribPointer(n.color,3,ge.FLOAT,!1,0,0)),me.disableUnusedAttributes(),ge.drawArrays(ge.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,a,n,r,i){null===t&&(t=X);const s=r.isMesh&&r.matrixWorld.determinant()<0,o=Ne(e,t,n,r);j.setMaterial(n,s);let l=a.index;const u=a.attributes.position;if(null===l){if(void 0===u||0===u.count)return}else if(0===l.count)return;let c,p=1;!0===n.wireframe&&(l=J.getWireframeAttribute(a),p=2),(n.morphTargets||n.morphNormals)&&se.update(r,a,n,o),me.setup(r,n,o,a,l);let d=ue;null!==l&&(c=Z.get(l),d=fe,d.setIndex(c));const f=null!==l?l.count:u.count,h=a.drawRange.start*p,m=a.drawRange.count*p,g=null!==i?i.start*p:0,E=null!==i?i.count*p:1/0,M=Math.max(h,g),_=Math.min(f,h+m,g+E)-1,T=Math.max(0,_-M+1);if(0!==T){if(r.isMesh)!0===n.wireframe?(j.setLineWidth(n.wireframeLinewidth*H()),d.setMode(ge.LINES)):d.setMode(ge.TRIANGLES);else if(r.isLine){let e=n.linewidth;void 0===e&&(e=1),j.setLineWidth(e*H()),r.isLineSegments?d.setMode(ge.LINES):r.isLineLoop?d.setMode(ge.LINE_LOOP):d.setMode(ge.LINE_STRIP)}else r.isPoints?d.setMode(ge.POINTS):r.isSprite&&d.setMode(ge.TRIANGLES);if(r.isInstancedMesh)d.renderInstances(M,T,r.count);else if(a.isInstancedBufferGeometry){const e=Math.min(a.instanceCount,a._maxInstanceCount);d.renderInstances(M,T,e)}else d.render(M,T)}},this.compile=function(e,t){d=ne.get(e,t),d.init(),e.traverse((function(e){e.isLight&&(d.pushLight(e),e.castShadow&&d.pushShadow(e))})),d.setupLights(t);const a=new WeakMap;e.traverse((function(t){const n=t.material;if(n)if(Array.isArray(n))for(let r=0;r<n.length;r++){const i=n[r];!1===a.has(i)&&(Ce(i,e,t),a.set(i))}else!1===a.has(n)&&(Ce(n,e,t),a.set(n))}))};let Re=null;const we=new _a;function Le(e,t,a,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)a=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)d.pushLight(e),e.castShadow&&d.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||I.intersectsSprite(e)){n&&W.setFromMatrixPosition(e.matrixWorld).applyMatrix4(G);const t=Q.update(e),r=e.material;r.visible&&p.push(e,t,r,a,W.z,null)}}else if(e.isImmediateRenderObject)n&&W.setFromMatrixPosition(e.matrixWorld).applyMatrix4(G),p.push(e,null,e.material,a,W.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==z.render.frame&&(e.skeleton.update(),e.skeleton.frame=z.render.frame),!e.frustumCulled||I.intersectsObject(e))){n&&W.setFromMatrixPosition(e.matrixWorld).applyMatrix4(G);const t=Q.update(e),r=e.material;if(Array.isArray(r)){const n=t.groups;for(let i=0,s=n.length;i<s;i++){const s=n[i],o=r[s.materialIndex];o&&o.visible&&p.push(e,t,o,a,W.z,s)}}else r.visible&&p.push(e,t,r,a,W.z,null)}const r=e.children;for(let e=0,i=r.length;e<i;e++)Le(r[e],t,a,n)}function Pe(e,t,a){const n=!0===t.isScene?t.overrideMaterial:null;for(let r=0,i=e.length;r<i;r++){const i=e[r],s=i.object,o=i.geometry,l=null===n?i.material:n,u=i.group;if(a.isArrayCamera){S=a;const e=a.cameras;for(let a=0,n=e.length;a<n;a++){const n=e[a];s.layers.test(n.layers)&&(j.viewport(x.copy(n.viewport)),d.setupLights(n),Fe(s,t,n,o,l,u))}}else S=null,Fe(s,t,a,o,l,u)}}function Fe(e,t,a,n,r,i){if(e.onBeforeRender(f,t,a,n,r,i),d=ne.get(t,S||a),e.modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){const n=Ne(a,t,r,e);j.setMaterial(r),me.reset(),function(e,t){e.render((function(e){f.renderBufferImmediate(e,t)}))}(e,n)}else f.renderBufferDirect(a,t,n,r,e,i);e.onAfterRender(f,t,a,n,r,i),d=ne.get(t,S||a)}function Ce(e,t,a){!0!==t.isScene&&(t=X);const n=Y.get(e),r=d.state.lights,i=d.state.shadowsArray,s=r.state.version,o=$.getParameters(e,r.state,i,t,a),l=$.getProgramCacheKey(o);let u=n.program,c=!0;if(void 0===u)e.addEventListener("dispose",ve);else if(u.cacheKey!==l)Ae(e);else if(n.lightsStateVersion!==s)c=!1;else{if(void 0!==o.shaderID){const a=e.isMeshStandardMaterial?t.environment:null;return void(n.envMap=K.get(e.envMap||a))}c=!1}c&&(o.uniforms=$.getUniforms(e),e.onBeforeCompile(o,f),u=$.acquireProgram(o,l),n.program=u,n.uniforms=o.uniforms,n.outputEncoding=o.outputEncoding);const p=n.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=re.numPlanes,n.numIntersection=re.numIntersection,p.clippingPlanes=re.uniform),n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=K.get(e.envMap||n.environment),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=s,n.needsLights&&(p.ambientLightColor.value=r.state.ambient,p.lightProbe.value=r.state.probe,p.directionalLights.value=r.state.directional,p.directionalLightShadows.value=r.state.directionalShadow,p.spotLights.value=r.state.spot,p.spotLightShadows.value=r.state.spotShadow,p.rectAreaLights.value=r.state.rectArea,p.ltc_1.value=r.state.rectAreaLTC1,p.ltc_2.value=r.state.rectAreaLTC2,p.pointLights.value=r.state.point,p.pointLightShadows.value=r.state.pointShadow,p.hemisphereLights.value=r.state.hemi,p.directionalShadowMap.value=r.state.directionalShadowMap,p.directionalShadowMatrix.value=r.state.directionalShadowMatrix,p.spotShadowMap.value=r.state.spotShadowMap,p.spotShadowMatrix.value=r.state.spotShadowMatrix,p.pointShadowMap.value=r.state.pointShadowMap,p.pointShadowMatrix.value=r.state.pointShadowMatrix);const h=n.program.getUniforms(),m=D.seqWithValue(h.seq,p);n.uniformsList=m}function Ne(e,t,a,n){!0!==t.isScene&&(t=X),q.resetTextureUnits();const r=t.fog,i=a.isMeshStandardMaterial?t.environment:null,s=null===M?f.outputEncoding:M.texture.encoding,o=K.get(a.envMap||i),l=Y.get(a),u=d.state.lights;if(!0===O&&(!0===B||e!==b)){const t=e===b&&a.id===T;re.setState(a,e,t)}a.version===l.__version?a.fog&&l.fog!==r||l.environment!==i||l.needsLights&&l.lightsStateVersion!==u.state.version?Ce(a,t,n):void 0===l.numClippingPlanes||l.numClippingPlanes===re.numPlanes&&l.numIntersection===re.numIntersection?(l.outputEncoding!==s||l.envMap!==o)&&Ce(a,t,n):Ce(a,t,n):(Ce(a,t,n),l.__version=a.version);let c=!1,p=!1,h=!1;const m=l.program,g=m.getUniforms(),E=l.uniforms;if(j.useProgram(m.program)&&(c=!0,p=!0,h=!0),a.id!==T&&(T=a.id,p=!0),c||b!==e){if(g.setValue(ge,"projectionMatrix",e.projectionMatrix),V.logarithmicDepthBuffer&&g.setValue(ge,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),b!==e&&(b=e,p=!0,h=!0),a.isShaderMaterial||a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshStandardMaterial||a.envMap){const t=g.map.cameraPosition;void 0!==t&&t.setValue(ge,W.setFromMatrixPosition(e.matrixWorld))}(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial)&&g.setValue(ge,"isOrthographic",!0===e.isOrthographicCamera),(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial||a.isShadowMaterial||a.skinning)&&g.setValue(ge,"viewMatrix",e.matrixWorldInverse)}if(a.skinning){g.setOptional(ge,n,"bindMatrix"),g.setOptional(ge,n,"bindMatrixInverse");const e=n.skeleton;if(e){const t=e.bones;if(V.floatVertexTextures){if(void 0===e.boneTexture){let a=Math.sqrt(4*t.length);a=ot.ceilPowerOfTwo(a),a=Math.max(a,4);const n=new Float32Array(a*a*4);n.set(e.boneMatrices);const r=new Ta(n,a,a,Ee,ut);e.boneMatrices=n,e.boneTexture=r,e.boneTextureSize=a}g.setValue(ge,"boneTexture",e.boneTexture,q),g.setValue(ge,"boneTextureSize",e.boneTextureSize)}else g.setOptional(ge,e,"boneMatrices")}}var _,S;return(p||l.receiveShadow!==n.receiveShadow)&&(l.receiveShadow=n.receiveShadow,g.setValue(ge,"receiveShadow",n.receiveShadow)),p&&(g.setValue(ge,"toneMappingExposure",f.toneMappingExposure),l.needsLights&&(S=h,(_=E).ambientLightColor.needsUpdate=S,_.lightProbe.needsUpdate=S,_.directionalLights.needsUpdate=S,_.directionalLightShadows.needsUpdate=S,_.pointLights.needsUpdate=S,_.pointLightShadows.needsUpdate=S,_.spotLights.needsUpdate=S,_.spotLightShadows.needsUpdate=S,_.rectAreaLights.needsUpdate=S,_.hemisphereLights.needsUpdate=S),r&&a.fog&&ee.refreshFogUniforms(E,r),ee.refreshMaterialUniforms(E,a,L,w),D.upload(ge,l.uniformsList,E,q)),a.isShaderMaterial&&!0===a.uniformsNeedUpdate&&(D.upload(ge,l.uniformsList,E,q),a.uniformsNeedUpdate=!1),a.isSpriteMaterial&&g.setValue(ge,"center",n.center),g.setValue(ge,"modelViewMatrix",n.modelViewMatrix),g.setValue(ge,"normalMatrix",n.normalMatrix),g.setValue(ge,"modelMatrix",n.matrixWorld),m}we.setAnimationLoop((function(e){Te.isPresenting||Re&&Re(e)})),"undefined"!=typeof window&&we.setContext(window),this.setAnimationLoop=function(e){Re=e,Te.setAnimationLoop(e),null===e?we.stop():we.start()},this.render=function(e,t){let a,n;if(void 0!==arguments[2]&&(a=arguments[2]),void 0!==arguments[3]&&(n=arguments[3]),void 0!==t&&!0!==t.isCamera)return;if(!0===h)return;me.resetDefaultState(),T=-1,b=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===Te.enabled&&!0===Te.isPresenting&&(t=Te.getCamera(t)),!0===e.isScene&&e.onBeforeRender(f,e,t,a||M),d=ne.get(e,t),d.init(),G.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),I.setFromProjectionMatrix(G),B=this.localClippingEnabled,O=re.init(this.clippingPlanes,B,t),p=te.get(e,t),p.init(),Le(e,t,0,f.sortObjects),p.finish(),!0===f.sortObjects&&p.sort(P,F),!0===O&&re.beginShadows();const r=d.state.shadowsArray;be.render(r,e,t),d.setupLights(t),!0===O&&re.endShadows(),!0===this.info.autoReset&&this.info.reset(),void 0!==a&&this.setRenderTarget(a),ie.render(p,e,t,n);const i=p.opaque,s=p.transparent;i.length>0&&Pe(i,e,t),s.length>0&&Pe(s,e,t),!0===e.isScene&&e.onAfterRender(f,e,t),null!==M&&(q.updateRenderTargetMipmap(M),q.updateMultisampleRenderTarget(M)),j.buffers.depth.setTest(!0),j.buffers.depth.setMask(!0),j.buffers.color.setMask(!0),j.setPolygonOffset(!1),p=null,d=null},this.setFramebuffer=function(e){m!==e&&null===M&&ge.bindFramebuffer(ge.FRAMEBUFFER,e),m=e},this.getActiveCubeFace=function(){return g},this.getActiveMipmapLevel=function(){return E},this.getRenderList=function(){return p},this.setRenderList=function(e){p=e},this.getRenderState=function(){return d},this.setRenderState=function(e){d=e},this.getRenderTarget=function(){return M},this.setRenderTarget=function(e,t=0,a=0){M=e,g=t,E=a,e&&void 0===Y.get(e).__webglFramebuffer&&q.setupRenderTarget(e);let n=m,r=!1;if(e){const a=Y.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=a[t],r=!0):n=e.isWebGLMultisampleRenderTarget?Y.get(e).__webglMultisampledFramebuffer:a,x.copy(e.viewport),v.copy(e.scissor),A=e.scissorTest}else x.copy(C).multiplyScalar(L).floor(),v.copy(U).multiplyScalar(L).floor(),A=y;if(_!==n&&(ge.bindFramebuffer(ge.FRAMEBUFFER,n),_=n),j.viewport(x),j.scissor(v),j.setScissorTest(A),r){const n=Y.get(e.texture);ge.framebufferTexture2D(ge.FRAMEBUFFER,ge.COLOR_ATTACHMENT0,ge.TEXTURE_CUBE_MAP_POSITIVE_X+t,n.__webglTexture,a)}},this.readRenderTargetPixels=function(e,t,a,n,r,i,s){if(!e||!e.isWebGLRenderTarget)return;let o=Y.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==s&&(o=o[s]),o){let s=!1;o!==_&&(ge.bindFramebuffer(ge.FRAMEBUFFER,o),s=!0);try{const o=e.texture,l=o.format,u=o.type;if(l!==Ee&&he.convert(l)!==ge.getParameter(ge.IMPLEMENTATION_COLOR_READ_FORMAT))return;if(!(u===gt||he.convert(u)===ge.getParameter(ge.IMPLEMENTATION_COLOR_READ_TYPE)||u===ut&&(V.isWebGL2||k.get("OES_texture_float")||k.get("WEBGL_color_buffer_float"))||u===ct&&(V.isWebGL2?k.get("EXT_color_buffer_float"):k.get("EXT_color_buffer_half_float"))))return;ge.checkFramebufferStatus(ge.FRAMEBUFFER)===ge.FRAMEBUFFER_COMPLETE&&t>=0&&t<=e.width-n&&a>=0&&a<=e.height-r&&ge.readPixels(t,a,n,r,he.convert(l),he.convert(u),i)}finally{s&&ge.bindFramebuffer(ge.FRAMEBUFFER,_)}}},this.copyFramebufferToTexture=function(e,t,a){void 0===a&&(a=0);const n=Math.pow(2,-a),r=Math.floor(t.image.width*n),i=Math.floor(t.image.height*n),s=he.convert(t.format);q.setTexture2D(t,0),ge.copyTexImage2D(ge.TEXTURE_2D,a,s,e.x,e.y,r,i,0),j.unbindTexture()},this.copyTextureToTexture=function(e,t,a,n){void 0===n&&(n=0);const r=t.image.width,i=t.image.height,s=he.convert(a.format),o=he.convert(a.type);q.setTexture2D(a,0),ge.pixelStorei(ge.UNPACK_FLIP_Y_WEBGL,a.flipY),ge.pixelStorei(ge.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),ge.pixelStorei(ge.UNPACK_ALIGNMENT,a.unpackAlignment),t.isDataTexture?ge.texSubImage2D(ge.TEXTURE_2D,n,e.x,e.y,r,i,s,o,t.image.data):t.isCompressedTexture?ge.compressedTexSubImage2D(ge.TEXTURE_2D,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,s,t.mipmaps[0].data):ge.texSubImage2D(ge.TEXTURE_2D,n,e.x,e.y,s,o,t.image),0===n&&a.generateMipmaps&&ge.generateMipmap(ge.TEXTURE_2D),j.unbindTexture()},this.initTexture=function(e){q.setTexture2D(e,0),j.unbindTexture()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}export{Pa as Clock,La as HUD,Fa as Scene,Cn as WebGLRenderer,wa as debugView,Ra as loadModel,Aa as loadReticle,ba as onWindowResize,va as render};
